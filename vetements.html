<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salut 9 ¬∑ Kapittel 4 ¬∑ V√™tements & couleurs</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111b2e;
      --panel2:#0f172a;
      --text:#e6eefc;
      --muted:#9fb2d6;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --card:#0b1530;
      --border:rgba(255,255,255,.12);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(34,197,94,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:20px 16px 80px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:12px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .top-left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .xp-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background:rgba(124,58,237,.18);
      border:1px solid rgba(124,58,237,.35);
      font-weight:700;
    }
    .link-pill{
      padding:8px 12px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);
      font-weight:600;
    }
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .progress{min-width:220px;}
    .progress-label{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin:0 2px 6px}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid var(--border); overflow:hidden}
    .bar > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #60a5fa, var(--accent2)); border-radius:999px; transition:width .35s ease}
    .badge{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:rgba(34,197,94,.14); font-weight:800;}
    h1{font-size:34px; margin:22px 0 10px}
    .lead{color:var(--muted); margin:0 0 14px; line-height:1.45}
    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:18px}
    .card h3{margin:12px 0 8px; font-size:16px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:14px 0}
    .nav{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      transition:transform .06s ease, background .2s ease;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(124,58,237,.22); border-color:rgba(124,58,237,.45)}
    .btn.good{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.38)}
    .btn.warn{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.35)}
    .btn.bad{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.35)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:650;
      font-size:13px;
    }
    .two{display:grid; grid-template-columns:1fr; gap:12px;}
    @media(min-width:740px){ .two{grid-template-columns:1fr 1fr} }

    /* Ordbank */
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input[type="text"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(11,21,48,.6);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    .list{
      display:grid; grid-template-columns:1fr; gap:8px;
      margin-top:10px; max-height:330px; overflow:auto; padding-right:6px;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(11,21,48,.4);
    }
    .row strong{font-size:15px}
    .row small{display:block; color:var(--muted); margin-top:2px}
    .tag{
      font-size:12px; font-weight:800; letter-spacing:.2px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    /* Flashcards */
    .fc{display:grid; gap:10px;}
    .flash{
      background:linear-gradient(180deg, rgba(124,58,237,.18), rgba(11,21,48,.65));
      border:1px solid rgba(124,58,237,.35);
      border-radius:18px;
      padding:16px;
      min-height:160px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .flash .front{font-size:28px; font-weight:900; letter-spacing:.2px}
    .flash .back{font-size:16px; color:var(--muted); margin-top:8px; display:none}
    .flash.revealed .back{display:block}
    .flash .hint{color:var(--muted); font-size:13px; margin-top:10px}
    .fc-actions{display:flex; gap:10px; flex-wrap:wrap}
    .mini{font-size:12px; color:var(--muted)}

    /* Drag & drop */
    .dd{display:grid; gap:12px;}
    .dd-grid{display:grid; grid-template-columns:1fr; gap:12px;}
    @media(min-width:760px){ .dd-grid{grid-template-columns:1fr 1fr} }
    .bank{
      border:1px dashed rgba(255,255,255,.22);
      border-radius:18px;
      padding:12px;
      background:rgba(255,255,255,.03);
      min-height:180px;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      font-weight:800;
      cursor:grab;
    }
    .targets{display:grid; gap:10px}
    .target{
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(11,21,48,.45);
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .target .left{display:flex; align-items:center; gap:10px;}
    .emoji{font-size:24px}
    .drop{
      min-width:160px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.25);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      text-align:center;
      font-weight:800;
    }
    .drop.filled{border-style:solid; color:var(--text); background:rgba(34,197,94,.10); border-color:rgba(34,197,94,.35)}
    .drop.bad{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.35)}
    .scoreline{display:flex; justify-content:space-between; color:var(--muted); font-size:13px}

    /* Sentence builder */
    .sb{display:grid; gap:10px;}
    .sentence{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(11,21,48,.45);
      font-size:16px;
      line-height:1.45;
    }
    .fb{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
    }
    .fb.good{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:var(--text)}
    .fb.bad{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.35); color:var(--text)}

    /* Confetti */
    .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:9999;}
    .confetti span{
      position:absolute; top:-10px;
      width:10px; height:16px;
      background:rgba(255,255,255,.9);
      border-radius:3px;
      animation:fall 1.2s linear forwards;
      opacity:.95;
    }
    @keyframes fall{
      to{ transform: translateY(calc(100vh + 40px)) rotate(520deg); opacity:.9; }
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(11,21,48,.92);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow);
      z-index:10000;
      max-width:min(560px, calc(100vw - 24px));
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      font-weight:700;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .footer-nav{
      margin-top:18px;
      display:flex; gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="top-left">
        <div class="xp-pill">‚≠ê XP: <span id="xp">0</span></div>
        <a class="link-pill" href="./index.html">‚Üê Til meny</a>
        <span class="pill" id="levelPill">Niv√•: 1 ¬∑ Novice</span>
      </div>
      <div class="right">
        <div class="progress">
          <div class="progress-label">
            <span>Fremdrift</span>
            <span id="progressPct">0%</span>
          </div>
          <div class="bar"><div id="progressBar"></div></div>
        </div>
        <div class="badge" id="badge">üîí L√•st</div>
      </div>
    </div>

    <h1>üëï V√™tements & üé® Couleurs</h1>
    <p class="lead">√òv kl√¶r og farger, f√• tilbakemelding, og samle XP. Fullf√∏r oppgavene for √• l√•se opp en badge.</p>

    <div class="nav">
      <a class="btn" href="./passe-compose.html">Pass√© compos√©</a>
      <a class="btn primary" href="./vetements.html">V√™tements</a>
      <a class="btn" href="./negation.html">N√©gation</a>
      <a class="btn" href="./defi.html">D√©fi</a>
      <a class="btn" href="./meteo.html">La m√©t√©o</a>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <h2>üéØ M√•l</h2>
        <p class="muted" style="margin:0 0 8px;">Jeg kan‚Ä¶</p>
        <ul class="muted" style="margin:0 0 8px; line-height:1.55;">
          <li>navn p√• vanlige kl√¶r (un/une/des)</li>
          <li>navn p√• farger</li>
          <li>lage setninger: <strong>Je porte‚Ä¶</strong> / <strong>J‚Äôaime‚Ä¶</strong> / <strong>Je n‚Äôaime pas‚Ä¶</strong></li>
        </ul>
        <div class="hr"></div>
        <h2>üèÜ Bel√∏nning</h2>
        <p class="muted" style="margin:0 0 10px;">
          Du f√•r XP for: riktige flashcards, fullf√∏rt matching, riktige setninger og god bruk av m√∏nstre i minioppgaven.
          Ved <strong>100 XP</strong> l√•ser du opp: <strong>‚ÄúFashion Master‚Äù</strong>.
        </p>
        <div class="controls">
          <button class="btn warn" id="saveBtn">Lagre lokalt</button>
          <button class="btn" id="resetBtn">Nullstill alt</button>
          <span class="mini" id="saveNote">Lagrer automatisk ogs√•.</span>
        </div>
      </div>

      <div class="card">
        <h2>üìö Gloser (fra boka)</h2>
        <div class="two">
          <div class="pill">üëï Kl√¶r: <strong id="countClothes">0</strong></div>
          <div class="pill">üé® Farger: <strong id="countColors">0</strong></div>
        </div>
        <div class="hr"></div>
        <p class="muted" style="margin:0;">
          Alt ligger inne i denne fila, s√• du f√•r aldri ‚Äútom ordbank‚Äù igjen.
          Hvis du senere vil hente fra JSON-filer, kan vi koble det p√• ‚Äì men dette er ‚Äúbombesikkert‚Äù.
        </p>
        <div class="hr"></div>
        <p class="muted" style="margin:0;">
          <strong>Daglig XP:</strong> Dagens del-XP (flash/matching/setning/tekst) nullstilles automatisk ved ny dato.
        </p>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>1) Ordbank (s√∏k + filter)</h2>
      <div class="controls">
        <div style="flex:1; min-width:220px;">
          <input id="search" type="text" placeholder="S√∏k (fransk eller norsk)‚Ä¶" />
        </div>
        <div style="min-width:190px;">
          <select id="filter">
            <option value="all">Alle</option>
            <option value="clothes">Kl√¶r</option>
            <option value="colors">Farger</option>
          </select>
        </div>
        <button class="btn" id="toggleLang">Vis: FR ‚Üí NO</button>
      </div>
      <div class="list" id="wordList" aria-live="polite"></div>
      <div class="hr"></div>
      <div class="muted">Tips: Trykk p√• ‚ÄúVis: ‚Ä¶‚Äù for √• bytte visning.</div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>2) Flashcards (mestring + XP)</h2>
      <p class="muted" style="margin-top:0;">Klikk ‚ÄúVis svar‚Äù. Deretter velger du hvor godt du kunne det. Systemet husker mestring per kort.</p>
      <div class="fc">
        <div class="flash" id="flashCard">
          <div>
            <div class="front" id="fcFront">‚Äî</div>
            <div class="back" id="fcBack">‚Äî</div>
            <div class="hint" id="fcHint">
              Kort <span id="fcIndex">1</span> / <span id="fcTotal">0</span> ¬∑ Mestring: <span id="fcMastery">0</span>/3
            </div>
          </div>
          <div class="fc-actions">
            <button class="btn" id="revealBtn">Vis svar</button>
            <button class="btn good" id="knewBtn" disabled>Visste</button>
            <button class="btn warn" id="almostBtn" disabled>Nesten</button>
            <button class="btn bad" id="nopeBtn" disabled>Ikke</button>
            <button class="btn" id="nextBtn">Neste</button>
          </div>
        </div>
        <div class="scoreline">
          <span>Mastered: <strong id="masteredCount">0</strong> / <span id="deckCount">0</span></span>
          <span>Flashcard-XP i dag: <strong id="fcXP">0</strong></span>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>3) Matching (dra riktig ord til riktig emoji)</h2>
      <p class="muted" style="margin-top:0;">Dra franske ord fra ‚Äúbanken‚Äù og slipp p√• riktig m√•l. Riktig gir XP.</p>
      <div class="dd">
        <div class="scoreline">
          <span>Poeng: <strong id="ddScore">0</strong> / <span id="ddTotal">0</span></span>
          <span>XP fra matching i dag: <strong id="ddXP">0</strong></span>
        </div>
        <div class="dd-grid">
          <div class="bank">
            <div class="muted" style="margin-bottom:10px; font-weight:800;">Ord √• dra</div>
            <div class="chips" id="ddBank"></div>
          </div>
          <div class="targets" id="ddTargets"></div>
        </div>
        <div class="controls" style="margin-top:8px;">
          <button class="btn warn" id="ddSave">Lagre</button>
          <button class="btn" id="ddReset">Start p√• nytt</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>4) Setningsbygger (med fasit + riktig fargeavtale)</h2>
      <p class="muted" style="margin-top:0;">Velg riktig plagg + farge for √• treffe fasit. Du f√•r XP for treff.</p>
      <div class="sb">
        <div class="sentence" id="sbPrompt">‚Äî</div>
        <div class="two">
          <div>
            <label class="muted" for="sbCloth">Plagg</label>
            <select id="sbCloth"></select>
          </div>
          <div>
            <label class="muted" for="sbColor">Farge</label>
            <select id="sbColor"></select>
          </div>
        </div>
        <div class="controls">
          <button class="btn primary" id="sbCheck">Sjekk</button>
          <button class="btn" id="sbNext">Ny setning</button>
          <span class="pill">Treff: <strong id="sbHits">0</strong> / <span id="sbRounds">0</span></span>
          <span class="pill">XP i dag: <strong id="sbXP">0</strong></span>
        </div>
        <div class="fb" id="sbFeedback">Tips: Plagg og farger kan du l√¶re raskt ved √• variere setningene.</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>5) Fri minioppgave (smart feedback)</h2>
      <p class="muted" style="margin-top:0;">
        Skriv 4‚Äì8 setninger om hva du liker √• ha p√• deg. Du f√•r ‚Äúm√∏nsterpoeng‚Äù n√•r du bruker gode uttrykk.
      </p>
      <div class="two">
        <div>
          <label class="muted" for="freeText">Din tekst</label>
          <textarea id="freeText" placeholder="Ex: Aujourd‚Äôhui, je porte un pull bleu. J‚Äôaime la jupe rouge parce que‚Ä¶"></textarea>
          <div class="controls" style="margin-top:10px;">
            <button class="btn warn" id="freeSave">Lagre</button>
            <button class="btn" id="freeReset">Nullstill</button>
            <span class="pill">Feedback: <strong id="freeScore">0</strong> / 6</span>
            <span class="pill">XP i dag: <strong id="freeXP">0</strong></span>
          </div>
          <div class="hr"></div>
          <div class="fb" id="freeFeedback">Skriv, s√• f√•r du smart feedback (m√∏nstre + ord).</div>
        </div>
        <div>
          <h3>Setningsstartere</h3>
          <ul class="muted" style="margin-top:0; line-height:1.55;">
            <li>Aujourd‚Äôhui, ‚Ä¶</li>
            <li>En √©t√© / En hiver, ‚Ä¶</li>
            <li>Je porte ‚Ä¶</li>
            <li>J‚Äôaime ‚Ä¶ parce que ‚Ä¶</li>
            <li>Je n‚Äôaime pas ‚Ä¶</li>
          </ul>
          <h3>Bonus-ord</h3>
          <div class="muted" style="line-height:1.55;">souvent, parfois, mais, parce que, et, aussi</div>
          <div class="hr"></div>
          <div class="muted">
            Smart feedback sjekker om du bruker:
            <strong>Je porte</strong>, <strong>J‚Äôaime</strong>, <strong>Je n‚Äôaime pas</strong>, <strong>parce que</strong>,
            minst <strong>1 farge</strong>, og minst <strong>2 klesord</strong>.
          </div>
        </div>
      </div>
    </div>

    <div class="footer-nav">
      <a class="btn" href="./index.html">‚Üê Til meny</a>
      <a class="btn primary" href="./passe-compose.html">Neste: Pass√© compos√© ‚Üí</a>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>
  <div class="toast" id="toast"></div>

<script>
/* ========================= HELPERS ========================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
let toastTimer = null;
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 1400);
}
function confetti(){
  const host = document.getElementById("confetti");
  host.innerHTML = "";
  const n = 80;
  for(let i=0;i<n;i++){
    const s = document.createElement("span");
    s.style.left = Math.floor(Math.random()*100) + "vw";
    s.style.animationDelay = (Math.random()*0.25) + "s";
    s.style.transform = "rotate("+(Math.random()*360)+"deg)";
    host.appendChild(s);
  }
  setTimeout(()=> host.innerHTML="", 1600);
}

/* ========================= DATA ========================= */
// Kl√¶r: legger inn grammatikk fra artikkel: un(m), une(f), des(p=plural)
function inferNounMeta(frWithArticle){
  const s = (frWithArticle||"").trim().toLowerCase();
  if(s.startsWith("une ")) return {gender:"f", number:"s"};
  if(s.startsWith("un "))  return {gender:"m", number:"s"};
  if(s.startsWith("des ")) return {gender:"m", number:"p"}; // plural (kj√∏nn lite viktig)
  return {gender:"m", number:"s"};
}

const CLOTHES = [
  { id:"debardeur",  fr:"un d√©bardeur",        no:"en singlet",                 emoji:"ü©±" },
  { id:"tshirt",     fr:"un T-shirt",          no:"en t-skjorte",               emoji:"üëï" },
  { id:"robe",       fr:"une robe",            no:"en kjole",                   emoji:"üëó" },
  { id:"jupe",       fr:"une jupe",            no:"et skj√∏rt",                  emoji:"ü©≥" },
  { id:"chemise",    fr:"une chemise",         no:"en skjorte",                 emoji:"üëî" },
  { id:"pull",       fr:"un pull",             no:"en genser",                  emoji:"üß∂" },
  { id:"short",      fr:"un short",            no:"en shorts",                  emoji:"ü©≥" },
  { id:"pantalon",   fr:"un pantalon",         no:"en bukse",                   emoji:"üëñ" },
  { id:"manteau",    fr:"un manteau",          no:"en frakk",                   emoji:"üß•" },
  { id:"veste",      fr:"une veste",           no:"en jakke",                   emoji:"üß•" },
  { id:"chaussettes",fr:"des chaussettes",     no:"sokker",                     emoji:"üß¶" },
  { id:"chaussures", fr:"des chaussures",      no:"sko",                        emoji:"üëû" },
  { id:"baskets",    fr:"des baskets",         no:"joggesko",                   emoji:"üëü" },
  { id:"gants",      fr:"des gants",           no:"hansker",                    emoji:"üß§" },
  { id:"bonnet",     fr:"un bonnet",           no:"en lue",                     emoji:"üß¢" },
  { id:"echarpe",    fr:"une √©charpe",         no:"et skjerf",                  emoji:"üß£" },
  { id:"bottes",     fr:"des bottes",          no:"st√∏vler",                    emoji:"ü•æ" },
  { id:"ceinture",   fr:"une ceinture",        no:"et belte",                   emoji:"üß∑" },
  { id:"casquette",  fr:"une casquette",       no:"en caps",                    emoji:"üß¢" },
  { id:"maillot",    fr:"un maillot de bain",  no:"en badedrakt / badebukse",   emoji:"ü©±" }
].map(x => ({...x, ...inferNounMeta(x.fr)}));

/* Farger: b√∏yning for setninger.
   - m_s: maskulin entall
   - f_s: feminin entall
   - m_p: maskulin flertall
   - f_p: feminin flertall
*/
const COLORS = [
  { id:"marron", fr:"marron", no:"brun",  emoji:"üü§", m_s:"marron", f_s:"marron",  m_p:"marron",  f_p:"marron" },
  { id:"noir",   fr:"noir",   no:"svart", emoji:"‚ö´", m_s:"noir",   f_s:"noire",   m_p:"noirs",   f_p:"noires" },
  { id:"bleu",   fr:"bleu",   no:"bl√•",   emoji:"üîµ", m_s:"bleu",   f_s:"bleue",   m_p:"bleus",   f_p:"bleues" },
  { id:"vert",   fr:"vert",   no:"gr√∏nn", emoji:"üü¢", m_s:"vert",   f_s:"verte",   m_p:"verts",   f_p:"vertes" },
  { id:"jaune",  fr:"jaune",  no:"gul",   emoji:"üü°", m_s:"jaune",  f_s:"jaune",   m_p:"jaunes",  f_p:"jaunes" },
  { id:"gris",   fr:"gris",   no:"gr√•",   emoji:"‚öôÔ∏è", m_s:"gris",   f_s:"grise",   m_p:"gris",    f_p:"grises" },
  { id:"rose",   fr:"rose",   no:"rosa",  emoji:"üå∏", m_s:"rose",   f_s:"rose",    m_p:"roses",   f_p:"roses" },
  { id:"violet", fr:"violet", no:"lilla", emoji:"üü£", m_s:"violet", f_s:"violette",m_p:"violets", f_p:"violettes" }
];

const DECK = [
  ...CLOTHES.map(x => ({...x, cat:"clothes"})),
  ...COLORS.map(x => ({...x, cat:"colors"}))
];

/* ========================= STATE + STORAGE ========================= */
const LS_KEY = "salut9_vetements_v2";

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

const defaultState = () => ({
  xp: 0,
  daily: { date: todayKey() },
  fc: { idx: 0, revealed: false, mastery: {}, sessionXP: 0 },
  dd: { solved: {}, score: 0, sessionXP: 0, seed: Date.now() },
  sb: { hits: 0, rounds: 0, sessionXP: 0, current: null },
  free: { text: "", score: 0, sessionXP: 0 },
  ui: { showFR: true, filter:"all", search:"" },
  achieved: { badge:false },
  stats: { lastSaved: 0 }
});

let S = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    const base = defaultState();
    const merged = {
      ...base, ...parsed,
      daily: {...base.daily, ...(parsed.daily||{})},
      fc: {...base.fc, ...(parsed.fc||{})},
      dd: {...base.dd, ...(parsed.dd||{})},
      sb: {...base.sb, ...(parsed.sb||{})},
      free: {...base.free, ...(parsed.free||{})},
      ui: {...base.ui, ...(parsed.ui||{})},
      achieved: {...base.achieved, ...(parsed.achieved||{})},
      stats: {...base.stats, ...(parsed.stats||{})}
    };
    if(!merged.daily?.date) merged.daily = { date: todayKey() };
    if(!merged.fc.mastery) merged.fc.mastery = {};
    if(!merged.dd.solved) merged.dd.solved = {};
    return merged;
  }catch(e){
    return defaultState();
  }
}

let saveTimer = null;
function autoSaveSoft(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }, 250);
}
function saveState(){
  S.stats.lastSaved = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(S));
  toast("‚úÖ Lagret lokalt");
  renderAll();
}
function resetAll(){
  if(!confirm("Nullstill alt (XP + fremdrift)?")) return;
  S = defaultState();
  localStorage.removeItem(LS_KEY);
  renderAll();
  toast("üîÑ Nullstilt");
}

/* ========================= DAGLIG RESET (DEL-XP) ========================= */
function dailyRollOverIfNeeded(){
  const t = todayKey();
  if(S.daily?.date !== t){
    S.daily = { date: t };
    S.fc.sessionXP = 0;
    S.dd.sessionXP = 0;
    S.sb.sessionXP = 0;
    S.free.sessionXP = 0;
    toast("üìÖ Ny dag! Daglig XP-teller er nullstilt.");
    autoSaveSoft();
  }
}

/* ========================= XP + PROGRESS + REWARDS ========================= */
function addXP(n){
  if(n <= 0) return;
  S.xp += n;
  if(S.xp >= 100 && !S.achieved.badge){
    S.achieved.badge = true;
    confetti();
    toast("üèÜ Badge l√•st opp: Fashion Master!");
  }
  autoSaveSoft();
  renderTop();
}

function levelFromXP(xp){
  if(xp >= 100) return {lvl:5, name:"Fashion Master"};
  if(xp >= 75)  return {lvl:4, name:"Stylish"};
  if(xp >= 50)  return {lvl:3, name:"P√• vei"};
  if(xp >= 25)  return {lvl:2, name:"Learner"};
  return {lvl:1, name:"Novice"};
}

function masteredCount(){
  return DECK.filter(c => (S.fc.mastery[c.id]||0) >= 3).length;
}

function mulberry32(seed){
  let a = seed >>> 0;
  return function() {
    a |= 0;
    a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}
function shuffleWithSeed(arr, seed){
  const rnd = mulberry32(seed);
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(rnd() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function currentDDItems(){
  const base = CLOTHES.slice();
  const seed = S.dd.seed || Date.now();
  const shuffled = shuffleWithSeed(base, seed);
  return shuffled.slice(0, Math.min(8, shuffled.length));
}

function progressPercent(){
  // Flashcards (0-40), Matching (0-25), Sentence builder (0-20), Free (0-15)
  const mastered = masteredCount();
  const fcPart = Math.min(40, Math.round((mastered / DECK.length) * 40));

  const ddItems = currentDDItems();
  const ddTotal = Math.max(1, ddItems.length);
  const ddDone = (S.dd.score >= ddTotal) ? 25 : Math.round((S.dd.score / ddTotal) * 25);

  const sbGoalRounds = 6;
  const sbPart = Math.min(
    20,
    Math.round(
      (Math.min(S.sb.rounds, sbGoalRounds) / sbGoalRounds) * 14 +
      (Math.min(S.sb.hits, 4) / 4) * 6
    )
  );

  const freePart = Math.min(15, Math.round((S.free.score / 6) * 15));

  return Math.max(0, Math.min(100, fcPart + ddDone + sbPart + freePart));
}

function renderTop(){
  document.getElementById("xp").textContent = S.xp;
  const p = progressPercent();
  document.getElementById("progressPct").textContent = `${p}%`;
  document.getElementById("progressBar").style.width = `${p}%`;
  const lv = levelFromXP(S.xp);
  document.getElementById("levelPill").textContent = `Niv√•: ${lv.lvl} ¬∑ ${lv.name}`;

  const badge = document.getElementById("badge");
  badge.textContent = S.achieved.badge ? "üèÜ Fashion Master" : "üîí L√•st";
  badge.style.background = S.achieved.badge ? "rgba(34,197,94,.18)" : "rgba(255,255,255,.06)";
}

/* ========================= ORDBANK ========================= */
const wordListEl = document.getElementById("wordList");
const searchEl = document.getElementById("search");
const filterEl = document.getElementById("filter");
const toggleLangBtn = document.getElementById("toggleLang");

searchEl.value = S.ui.search;
filterEl.value = S.ui.filter;
toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR ‚Üí NO" : "Vis: NO ‚Üí FR";

searchEl.addEventListener("input", () => {
  S.ui.search = searchEl.value;
  autoSaveSoft();
  renderWordbank();
});
filterEl.addEventListener("change", () => {
  S.ui.filter = filterEl.value;
  autoSaveSoft();
  renderWordbank();
});
toggleLangBtn.addEventListener("click", () => {
  S.ui.showFR = !S.ui.showFR;
  toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR ‚Üí NO" : "Vis: NO ‚Üí FR";
  autoSaveSoft();
  renderWordbank();
});

function renderWordbank(){
  const q = (S.ui.search || "").trim().toLowerCase();
  const f = S.ui.filter;
  let items = DECK.slice();

  if(f === "clothes") items = items.filter(x => x.cat === "clothes");
  if(f === "colors")  items = items.filter(x => x.cat === "colors");

  if(q){
    items = items.filter(x => {
      const fr = (x.fr||"").toLowerCase();
      const no = (x.no||"").toLowerCase();
      const id = (x.id||"").toLowerCase();
      return fr.includes(q) || no.includes(q) || id.includes(q);
    });
  }

  wordListEl.innerHTML = "";
  items.forEach(x => {
    const left  = S.ui.showFR ? x.fr : x.no;
    const right = S.ui.showFR ? x.no : x.fr;
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <strong>${escapeHtml(x.emoji)} ${escapeHtml(left)}</strong>
        <small>${escapeHtml(right)}</small>
      </div>
      <span class="tag">${x.cat === "clothes" ? "Kl√¶r" : "Farger"}</span>
    `;
    wordListEl.appendChild(row);
  });

  document.getElementById("countClothes").textContent = CLOTHES.length;
  document.getElementById("countColors").textContent = COLORS.length;
}

/* ========================= FLASHCARDS ========================= */
const flashCardEl = document.getElementById("flashCard");
const fcFrontEl = document.getElementById("fcFront");
const fcBackEl = document.getElementById("fcBack");
const fcIndexEl = document.getElementById("fcIndex");
const fcTotalEl = document.getElementById("fcTotal");
const fcMasteryEl = document.getElementById("fcMastery");
const masteredCountEl = document.getElementById("masteredCount");
const deckCountEl = document.getElementById("deckCount");
const fcXPEl = document.getElementById("fcXP");
const revealBtn = document.getElementById("revealBtn");
const knewBtn = document.getElementById("knewBtn");
const almostBtn = document.getElementById("almostBtn");
const nopeBtn = document.getElementById("nopeBtn");
const nextBtn = document.getElementById("nextBtn");

function currentCard(){
  const idx = ((S.fc.idx||0) % DECK.length + DECK.length) % DECK.length;
  return DECK[idx];
}

function renderFlashcard(){
  const card = currentCard();
  fcFrontEl.textContent = `${card.emoji} ${card.fr}`;
  fcBackEl.textContent = `${card.no}`;
  fcTotalEl.textContent = DECK.length;
  fcIndexEl.textContent = (S.fc.idx % DECK.length) + 1;

  const m = S.fc.mastery[card.id] || 0;
  fcMasteryEl.textContent = `${m}`;

  deckCountEl.textContent = DECK.length;
  masteredCountEl.textContent = masteredCount();
  fcXPEl.textContent = S.fc.sessionXP;

  flashCardEl.classList.toggle("revealed", !!S.fc.revealed);
  knewBtn.disabled = !S.fc.revealed;
  almostBtn.disabled = !S.fc.revealed;
  nopeBtn.disabled = !S.fc.revealed;
}

revealBtn.addEventListener("click", () => {
  S.fc.revealed = true;
  autoSaveSoft();
  renderFlashcard();
});

function answerFlash(kind){
  dailyRollOverIfNeeded();
  const card = currentCard();
  const m = S.fc.mastery[card.id] || 0;

  let deltaM = 0;
  let gained = 0;

  if(kind === "knew"){ deltaM = 1; gained = 3; }
  else if(kind === "almost"){ deltaM = 1; gained = 1; }
  else { deltaM = 0; gained = 0; }

  const newM = Math.min(3, m + deltaM);
  S.fc.mastery[card.id] = newM;

  if(gained > 0){
    S.fc.sessionXP += gained;
    addXP(gained);
    toast(`‚≠ê +${gained} XP (flashcard)`);
  }

  S.fc.revealed = false;
  S.fc.idx = (S.fc.idx + 1) % DECK.length;
  autoSaveSoft();
  renderAll();
}

knewBtn.addEventListener("click", () => answerFlash("knew"));
almostBtn.addEventListener("click", () => answerFlash("almost"));
nopeBtn.addEventListener("click", () => answerFlash("nope"));
nextBtn.addEventListener("click", () => {
  S.fc.revealed = false;
  S.fc.idx = (S.fc.idx + 1) % DECK.length;
  autoSaveSoft();
  renderFlashcard();
});

/* ========================= MATCHING (Drag & Drop) ========================= */
const ddBankEl = document.getElementById("ddBank");
const ddTargetsEl = document.getElementById("ddTargets");
const ddScoreEl = document.getElementById("ddScore");
const ddTotalEl = document.getElementById("ddTotal");
const ddXPEl = document.getElementById("ddXP");
const ddSaveBtn = document.getElementById("ddSave");
const ddResetBtn = document.getElementById("ddReset");

function renderDD(){
  const items = currentDDItems();
  ddTotalEl.textContent = items.length;
  ddScoreEl.textContent = S.dd.score;
  ddXPEl.textContent = S.dd.sessionXP;

  ddBankEl.innerHTML = "";
  items.forEach(it => {
    if(S.dd.solved[it.id]) return;
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.draggable = true;
    chip.textContent = it.fr;
    chip.dataset.id = it.id;
    chip.addEventListener("dragstart", (e) =>
