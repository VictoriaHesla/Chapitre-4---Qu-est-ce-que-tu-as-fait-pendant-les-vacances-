<script>
/* =========================
   DATA (fra vedlegget)
   ========================= */
const CLOTHES = [
  { id:"debardeur", fr:"un dÃ©bardeur", no:"en singlet", emoji:"ðŸ©±" },
  { id:"tshirt", fr:"un T-shirt", no:"en t-skjorte", emoji:"ðŸ‘•" },
  { id:"robe", fr:"une robe", no:"en kjole", emoji:"ðŸ‘—" },
  { id:"jupe", fr:"une jupe", no:"et skjÃ¸rt", emoji:"ðŸ©³" },
  { id:"chemise", fr:"une chemise", no:"en skjorte", emoji:"ðŸ‘”" },
  { id:"pull", fr:"un pull", no:"en genser", emoji:"ðŸ§¶" },
  { id:"short", fr:"un short", no:"en shorts", emoji:"ðŸ©³" },
  { id:"pantalon", fr:"un pantalon", no:"en bukse", emoji:"ðŸ‘–" },
  { id:"manteau", fr:"un manteau", no:"en frakk", emoji:"ðŸ§¥" },
  { id:"veste", fr:"une veste", no:"en jakke", emoji:"ðŸ§¥" },
  { id:"chaussettes", fr:"des chaussettes", no:"sokker", emoji:"ðŸ§¦" },
  { id:"chaussures", fr:"des chaussures", no:"sko", emoji:"ðŸ‘ž" },
  { id:"baskets", fr:"des baskets", no:"joggesko", emoji:"ðŸ‘Ÿ" },
  { id:"gants", fr:"des gants", no:"hansker", emoji:"ðŸ§¤" },
  { id:"bonnet", fr:"un bonnet", no:"en lue", emoji:"ðŸ§¢" },
  { id:"echarpe", fr:"une Ã©charpe", no:"et skjerf", emoji:"ðŸ§£" },
  { id:"bottes", fr:"des bottes", no:"stÃ¸vler", emoji:"ðŸ¥¾" },
  { id:"ceinture", fr:"une ceinture", no:"et belte", emoji:"ðŸ§·" },
  { id:"casquette", fr:"une casquette", no:"en caps", emoji:"ðŸ§¢" },
  { id:"maillot", fr:"un maillot de bain", no:"en badedrakt / badebukse", emoji:"ðŸ©±" }
];

const COLORS = [
  { id:"marron", fr:"marron", no:"brun", emoji:"ðŸŸ¤" },
  { id:"noir", fr:"noir", no:"svart", emoji:"âš«" },
  { id:"bleu", fr:"bleu", no:"blÃ¥", emoji:"ðŸ”µ" },
  { id:"vert", fr:"vert", no:"grÃ¸nn", emoji:"ðŸŸ¢" },
  { id:"jaune", fr:"jaune", no:"gul", emoji:"ðŸŸ¡" },
  { id:"gris", fr:"gris", no:"grÃ¥", emoji:"âš™ï¸" },
  { id:"rose", fr:"rose", no:"rosa", emoji:"ðŸŒ¸" },
  { id:"violet", fr:"violet", no:"lilla", emoji:"ðŸŸ£" }
];

const DECK = [
  ...CLOTHES.map(x => ({...x, cat:"clothes"})),
  ...COLORS.map(x => ({...x, cat:"colors"}))
];

/* =========================
   STATE + STORAGE
   ========================= */
const LS_KEY = "salut9_vetements_v1";

const defaultState = () => ({
  xp: 0,
  fc: { idx: 0, revealed: false, mastery: {}, sessionXP: 0 },
  dd: { solved: {}, score: 0, sessionXP: 0, seed: Date.now() },
  sb: { hits: 0, rounds: 0, sessionXP: 0, current: null },
  free: { text: "", score: 0, sessionXP: 0 },
  ui: { showFR: true, filter:"all", search:"" },
  achieved: { badge:false },
  stats: { lastSaved: 0 }
});

let S = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return {...defaultState(), ...parsed,
      fc: {...defaultState().fc, ...(parsed.fc||{})},
      dd: {...defaultState().dd, ...(parsed.dd||{})},
      sb: {...defaultState().sb, ...(parsed.sb||{})},
      free: {...defaultState().free, ...(parsed.free||{})},
      ui: {...defaultState().ui, ...(parsed.ui||{})},
      achieved: {...defaultState().achieved, ...(parsed.achieved||{})},
      stats: {...defaultState().stats, ...(parsed.stats||{})}
    };
  }catch(e){
    return defaultState();
  }
}

function saveState(){
  S.stats.lastSaved = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(S));
  toast("âœ… Lagret lokalt");
  renderAll();
}

function resetAll(){
  if(!confirm("Nullstill alt (XP + fremdrift)?")) return;
  S = defaultState();
  localStorage.removeItem(LS_KEY);
  renderAll();
  toast("ðŸ”„ Nullstilt");
}

/* =========================
   XP + PROGRESS + REWARDS
   ========================= */
function addXP(n){
  if(n <= 0) return;
  S.xp += n;

  if(S.xp >= 100 && !S.achieved.badge){
    S.achieved.badge = true;
    confetti();
    toast("ðŸ† Badge lÃ¥st opp: Fashion Master!");
  }
  autoSaveSoft();
  renderTop();
}

function levelFromXP(xp){
  if(xp >= 100) return {lvl:5, name:"Fashion Master"};
  if(xp >= 75) return {lvl:4, name:"Stylish"};
  if(xp >= 50) return {lvl:3, name:"PÃ¥ vei"};
  if(xp >= 25) return {lvl:2, name:"Learner"};
  return {lvl:1, name:"Novice"};
}

function masteredCount(){
  return DECK.filter(c => (S.fc.mastery[c.id]||0) >= 3).length;
}

function progressPercent(){
  const mastered = masteredCount();
  const fcPart = Math.min(40, Math.round((mastered / DECK.length) * 40));

  const ddItems = currentDDItems();
  const ddTotal = Math.max(1, ddItems.length);
  const ddDone = (S.dd.score >= ddTotal) ? 25 : Math.round((S.dd.score / ddTotal) * 25);

  const sbGoalRounds = 6;
  const sbPart = Math.min(
    20,
    Math.round(
      (Math.min(S.sb.rounds, sbGoalRounds) / sbGoalRounds) * 14 +
      (Math.min(S.sb.hits, 4) / 4) * 6
    )
  );

  const freePart = Math.min(15, Math.round((S.free.score / 6) * 15));

  return Math.max(0, Math.min(100, fcPart + ddDone + sbPart + freePart));
}

function renderTop(){
  document.getElementById("xp").textContent = S.xp;

  const p = progressPercent();
  document.getElementById("progressPct").textContent = `${p}%`;
  document.getElementById("progressBar").style.width = `${p}%`;

  const lv = levelFromXP(S.xp);
  document.getElementById("levelPill").textContent = `NivÃ¥: ${lv.lvl} Â· ${lv.name}`;

  const badge = document.getElementById("badge");
  badge.textContent = S.achieved.badge ? "ðŸ† Fashion Master" : "ðŸ”’ LÃ¥st";
  badge.style.background = S.achieved.badge ? "rgba(34,197,94,.18)" : "rgba(255,255,255,.06)";
}

let saveTimer = null;
function autoSaveSoft(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }, 250);
}

/* =========================
   ORDBANK
   ========================= */
const wordListEl = document.getElementById("wordList");
const searchEl = document.getElementById("search");
const filterEl = document.getElementById("filter");
const toggleLangBtn = document.getElementById("toggleLang");

searchEl.value = S.ui.search;
filterEl.value = S.ui.filter;
toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR â†’ NO" : "Vis: NO â†’ FR";

searchEl.addEventListener("input", () => {
  S.ui.search = searchEl.value;
  autoSaveSoft();
  renderWordbank();
});
filterEl.addEventListener("change", () => {
  S.ui.filter = filterEl.value;
  autoSaveSoft();
  renderWordbank();
});
toggleLangBtn.addEventListener("click", () => {
  S.ui.showFR = !S.ui.showFR;
  toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR â†’ NO" : "Vis: NO â†’ FR";
  autoSaveSoft();
  renderWordbank();
});

function renderWordbank(){
  const q = (S.ui.search || "").trim().toLowerCase();
  const f = S.ui.filter;

  let items = DECK.slice();
  if(f === "clothes") items = items.filter(x => x.cat === "clothes");
  if(f === "colors") items = items.filter(x => x.cat === "colors");

  if(q){
    items = items.filter(x => {
      const fr = (x.fr||"").toLowerCase();
      const no = (x.no||"").toLowerCase();
      const id = (x.id||"").toLowerCase();
      return fr.includes(q) || no.includes(q) || id.includes(q);
    });
  }

  wordListEl.innerHTML = "";
  items.forEach(x => {
    const left = S.ui.showFR ? x.fr : x.no;
    const right = S.ui.showFR ? x.no : x.fr;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <strong>${escapeHtml(x.emoji)} ${escapeHtml(left)}</strong>
        <small>${escapeHtml(right)}</small>
      </div>
      <span class="tag">${x.cat === "clothes" ? "KlÃ¦r" : "Farger"}</span>
    `;
    wordListEl.appendChild(row);
  });

  document.getElementById("countClothes").textContent = CLOTHES.length;
  document.getElementById("countColors").textContent = COLORS.length;
}

/* =========================
   FLASHCARDS
   ========================= */
const flashCardEl = document.getElementById("flashCard");
const fcFrontEl = document.getElementById("fcFront");
const fcBackEl = document.getElementById("fcBack");
const fcHintEl = document.getElementById("fcHint");
const fcIndexEl = document.getElementById("fcIndex");
const fcTotalEl = document.getElementById("fcTotal");
const fcMasteryEl = document.getElementById("fcMastery");
const masteredCountEl = document.getElementById("masteredCount");
const deckCountEl = document.getElementById("deckCount");
const fcXPEl = document.getElementById("fcXP");

const revealBtn = document.getElementById("revealBtn");
const knewBtn = document.getElementById("knewBtn");
const almostBtn = document.getElementById("almostBtn");
const nopeBtn = document.getElementById("nopeBtn");
const nextBtn = document.getElementById("nextBtn");

function currentCard(){
  const idx = ((S.fc.idx||0) % DECK.length + DECK.length) % DECK.length;
  return DECK[idx];
}

function renderFlashcard(){
  const card = currentCard();
  const showFR = true; // flash: alltid fr pÃ¥ front

  fcFrontEl.textContent = `${card.emoji} ${showFR ? card.fr : card.no}`;
  fcBackEl.textContent = `${showFR ? card.no : card.fr}`;

  fcTotalEl.textContent = DECK.length;
  fcIndexEl.textContent = (S.fc.idx % DECK.length) + 1;

  const m = S.fc.mastery[card.id] || 0;
  fcMasteryEl.textContent = `${m}`;

  deckCountEl.textContent = DECK.length;
  masteredCountEl.textContent = masteredCount();

  fcXPEl.textContent = S.fc.sessionXP;

  flashCardEl.classList.toggle("revealed", !!S.fc.revealed);
  knewBtn.disabled = !S.fc.revealed;
  almostBtn.disabled = !S.fc.revealed;
  nopeBtn.disabled = !S.fc.revealed;
}

revealBtn.addEventListener("click", () => {
  S.fc.revealed = true;
  autoSaveSoft();
  renderFlashcard();
});

function answerFlash(kind){
  const card = currentCard();
  const m = S.fc.mastery[card.id] || 0;

  let deltaM = 0;
  let gained = 0;

  if(kind === "knew"){
    deltaM = 1;
    gained = 3;
  }else if(kind === "almost"){
    deltaM = 1;
    gained = 1;
  }else{
    deltaM = 0;
    gained = 0;
  }

  const newM = Math.min(3, m + deltaM);
  S.fc.mastery[card.id] = newM;

  if(gained > 0){
    S.fc.sessionXP += gained;
    addXP(gained);
    toast(`â­ +${gained} XP (flashcard)`);
  }

  S.fc.revealed = false;
  S.fc.idx = (S.fc.idx + 1) % DECK.length;

  autoSaveSoft();
  renderAll();
}

knewBtn.addEventListener("click", () => answerFlash("knew"));
almostBtn.addEventListener("click", () => answerFlash("almost"));
nopeBtn.addEventListener("click", () => answerFlash("nope"));

nextBtn.addEventListener("click", () => {
  S.fc.revealed = false;
  S.fc.idx = (S.fc.idx + 1) % DECK.length;
  autoSaveSoft();
  renderFlashcard();
});

/* =========================
   MATCHING (Drag & Drop)
   ========================= */
const ddBankEl = document.getElementById("ddBank");
const ddTargetsEl = document.getElementById("ddTargets");
const ddScoreEl = document.getElementById("ddScore");
const ddTotalEl = document.getElementById("ddTotal");
const ddXPEl = document.getElementById("ddXP");

const ddSaveBtn = document.getElementById("ddSave");
const ddResetBtn = document.getElementById("ddReset");

function mulberry32(seed){
  let a = seed >>> 0;
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

function shuffleWithSeed(arr, seed){
  const rnd = mulberry32(seed);
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(rnd() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function currentDDItems(){
  // 8 klÃ¦r (blanding), litt â€œpasse storâ€ oppgave
  const base = CLOTHES.slice();
  const seed = S.dd.seed || Date.now();
  const shuffled = shuffleWithSeed(base, seed);
  return shuffled.slice(0, Math.min(8, shuffled.length));
}

function renderDD(){
  const items = currentDDItems();
  ddTotalEl.textContent = items.length;
  ddScoreEl.textContent = S.dd.score;
  ddXPEl.textContent = S.dd.sessionXP;

  // Bank: ord som ikke er lÃ¸st
  ddBankEl.innerHTML = "";
  items.forEach(it => {
    if(S.dd.solved[it.id]) return;
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.draggable = true;
    chip.textContent = it.fr;
    chip.dataset.id = it.id;
    chip.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", it.id);
      e.dataTransfer.effectAllowed = "move";
    });
    ddBankEl.appendChild(chip);
  });

  // Targets
  ddTargetsEl.innerHTML = "";
  items.forEach(it => {
    const solved = !!S.dd.solved[it.id];
    const target = document.createElement("div");
    target.className = "target";
    target.innerHTML = `
      <div class="left">
        <div class="emoji">${escapeHtml(it.emoji)}</div>
        <div>
          <strong>${escapeHtml(it.no)}</strong>
          <div class="mini muted">Slipp riktig FR-ord her</div>
        </div>
      </div>
      <div class="drop ${solved ? "filled" : ""}" data-accept="${escapeHtml(it.id)}">
        ${solved ? escapeHtml(it.fr) : "Dra ord hit"}
      </div>
    `;

    const drop = target.querySelector(".drop");
    drop.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    });
    drop.addEventListener("drop", (e) => {
      e.preventDefault();
      const draggedId = e.dataTransfer.getData("text/plain");
      const acceptId = drop.dataset.accept;

      if(!draggedId) return;
      if(S.dd.solved[acceptId]) return;

      if(draggedId === acceptId){
        S.dd.solved[acceptId] = true;
        S.dd.score = Object.keys(S.dd.solved).filter(k => S.dd.solved[k]).length;

        const gained = 3;
        S.dd.sessionXP += gained;
        addXP(gained);

        toast("âœ… Riktig! +3 XP");
        drop.classList.remove("bad");
        drop.classList.add("filled");
        autoSaveSoft();
        renderDD();
        renderTop();
      }else{
        drop.classList.add("bad");
        toast("âŒ Ikke helt â€“ prÃ¸v igjen");
        setTimeout(()=> drop.classList.remove("bad"), 450);
      }
    });

    ddTargetsEl.appendChild(target);
  });
}

ddSaveBtn.addEventListener("click", saveState);
ddResetBtn.addEventListener("click", () => {
  if(!confirm("Starte matching pÃ¥ nytt?")) return;
  S.dd = {...defaultState().dd, seed: Date.now()};
  autoSaveSoft();
  renderDD();
  renderTop();
  toast("ðŸ” Ny matching klar");
});

/* =========================
   SETNINGSBYGGER
   ========================= */
const sbPromptEl = document.getElementById("sbPrompt");
const sbClothEl = document.getElementById("sbCloth");
const sbColorEl = document.getElementById("sbColor");
const sbCheckBtn = document.getElementById("sbCheck");
const sbNextBtn = document.getElementById("sbNext");
const sbHitsEl = document.getElementById("sbHits");
const sbRoundsEl = document.getElementById("sbRounds");
const sbXPEl = document.getElementById("sbXP");
const sbFeedbackEl = document.getElementById("sbFeedback");

function fillSBSelects(){
  sbClothEl.innerHTML = "";
  CLOTHES.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.emoji} ${c.fr}`;
    sbClothEl.appendChild(opt);
  });

  sbColorEl.innerHTML = "";
  COLORS.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.emoji} ${c.fr}`;
    sbColorEl.appendChild(opt);
  });
}

function newSBRound(){
  const cloth = CLOTHES[Math.floor(Math.random()*CLOTHES.length)];
  const color = COLORS[Math.floor(Math.random()*COLORS.length)];

  // tre typer prompt
  const patterns = [
    { id:"porte", text:`Lag setningen: Je porte ${cloth.fr} ${color.fr}.` , answer:`Je porte ${cloth.fr} ${color.fr}.`},
    { id:"aime", text:`Velg riktig for: Jâ€™aime ${cloth.fr} ${color.fr}.`, answer:`Jâ€™aime ${cloth.fr} ${color.fr}.`},
    { id:"naime", text:`Velg riktig for: Je nâ€™aime pas ${cloth.fr} ${color.fr}.`, answer:`Je nâ€™aime pas ${cloth.fr} ${color.fr}.`}
  ];
  const p = patterns[Math.floor(Math.random()*patterns.length)];

  S.sb.current = { clothId: cloth.id, colorId: color.id, pattern: p.id, answer: p.answer, prompt: p.text };
  autoSaveSoft();

  sbPromptEl.textContent = p.text;
  sbFeedbackEl.className = "fb";
  sbFeedbackEl.textContent = "Velg plagg + farge og trykk Sjekk.";
}

function renderSB(){
  sbHitsEl.textContent = S.sb.hits;
  sbRoundsEl.textContent = S.sb.rounds;
  sbXPEl.textContent = S.sb.sessionXP;

  if(!S.sb.current) newSBRound();

  // sett selects til noe â€œfornuftigâ€ (behold brukerens valg hvis mulig)
  if(!sbClothEl.value) sbClothEl.value = CLOTHES[0]?.id || "";
  if(!sbColorEl.value) sbColorEl.value = COLORS[0]?.id || "";

  sbPromptEl.textContent = S.sb.current.prompt;
}

sbCheckBtn.addEventListener("click", () => {
  if(!S.sb.current) return;

  const chosenCloth = sbClothEl.value;
  const chosenColor = sbColorEl.value;

  S.sb.rounds += 1;

  const ok = (chosenCloth === S.sb.current.clothId) && (chosenColor === S.sb.current.colorId);

  if(ok){
    S.sb.hits += 1;
    const gained = 4;
    S.sb.sessionXP += gained;
    addXP(gained);

    sbFeedbackEl.className = "fb good";
    sbFeedbackEl.textContent = `âœ… Riktig! +${gained} XP Â· Fasit: ${S.sb.current.answer}`;
    toast(`âœ… +${gained} XP (setning)`);
  }else{
    const cloth = CLOTHES.find(x => x.id === S.sb.current.clothId);
    const color = COLORS.find(x => x.id === S.sb.current.colorId);
    sbFeedbackEl.className = "fb bad";
    sbFeedbackEl.textContent = `âŒ Nesten. Fasit: ${S.sb.current.answer} (${cloth?.emoji||""} ${cloth?.fr||""} + ${color?.emoji||""} ${color?.fr||""})`;
  }

  autoSaveSoft();
  renderSB();
  renderTop();
});

sbNextBtn.addEventListener("click", () => {
  newSBRound();
  renderSB();
});

/* =========================
   FRI MINIOPPGAVE (smart feedback)
   ========================= */
const freeTextEl = document.getElementById("freeText");
const freeSaveBtn = document.getElementById("freeSave");
const freeResetBtn = document.getElementById("freeReset");
const freeScoreEl = document.getElementById("freeScore");
const freeXPEl = document.getElementById("freeXP");

freeTextEl.value = S.free.text || "";

function normalize(s){
  return (s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // fjern aksenter (Ã© -> e)
}

function freeFeedbackScore(text){
  const t = normalize(text);

  const checks = [
    { key:"jeporte", ok: /je\s+porte/.test(t) },
    { key:"jaime", ok: /j[' ]aime/.test(t) },
    { key:"jenaimepas", ok: /je\s+n[' ]aime\s+pas/.test(t) },
    { key:"parceque", ok: /parce\s+que/.test(t) },
    { key:"color", ok: COLORS.some(c => t.includes(normalize(c.fr))) },
    { key:"clothes2", ok: countClothesMentions(t) >= 2 }
  ];

  return checks.reduce((sum, c) => sum + (c.ok ? 1 : 0), 0);
}

function countClothesMentions(tNorm){
  let count = 0;
  CLOTHES.forEach(c => {
    const fr = normalize(c.fr);
    // fjern artikkel for Ã¥ Ã¸ke treffsjansen
    const bare = fr.replace(/^un\s+|^une\s+|^des\s+/,"");
    if(tNorm.includes(fr) || tNorm.includes(bare)) count += 1;
  });
  return count;
}

function renderFree(){
  freeScoreEl.textContent = S.free.score;
  freeXPEl.textContent = S.free.sessionXP;
}

function evaluateFree(){
  const text = freeTextEl.value || "";
  const score = freeFeedbackScore(text);

  const prev = S.free.score || 0;
  S.free.text = text;
  S.free.score = score;

  // XP: gi bare nÃ¥r du forbedrer deg
  const diff = Math.max(0, score - prev);
  if(diff > 0){
    const gained = diff * 2; // 2 XP per nytt â€œmÃ¸nsterâ€
    S.free.sessionXP += gained;
    addXP(gained);
    toast(`âœ¨ +${gained} XP (mÃ¸nstre)`);
  }

  autoSaveSoft();
  renderFree();
  renderTop();
}

freeTextEl.addEventListener("input", () => {
  // live-score uten XP-spam: bare oppdater score, ingen XP fÃ¸r â€œLagreâ€
  const score = freeFeedbackScore(freeTextEl.value || "");
  S.free.text = freeTextEl.value || "";
  S.free.score = score;
  autoSaveSoft();
  renderFree();
});

freeSaveBtn.addEventListener("click", () => {
  evaluateFree();
  saveState();
});

freeResetBtn.addEventListener("click", () => {
  if(!confirm("Nullstille teksten din?")) return;
  S.free = {...defaultState().free};
  freeTextEl.value = "";
  autoSaveSoft();
  renderFree();
  renderTop();
  toast("ðŸ§½ Tekst nullstilt");
});

/* =========================
   TOP BUTTONS
   ========================= */
document.getElementById("saveBtn").addEventListener("click", saveState);
document.getElementById("resetBtn").addEventListener("click", resetAll);

/* =========================
   TOAST + CONFETTI + HELPERS
   ========================= */
let toastTimer = null;
function toast(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "18px";
    el.style.transform = "translateX(-50%)";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "14px";
    el.style.border = "1px solid rgba(255,255,255,.14)";
    el.style.background = "rgba(15,23,42,.85)";
    el.style.color = "white";
    el.style.fontWeight = "800";
    el.style.boxShadow = "0 12px 30px rgba(0,0,0,.35)";
    el.style.zIndex = "99999";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
}

function confetti(){
  const box = document.getElementById("confetti");
  if(!box) return;
  box.innerHTML = "";

  const colors = ["rgba(124,58,237,.95)","rgba(34,197,94,.95)","rgba(96,165,250,.95)","rgba(245,158,11,.95)"];
  const n = 64;

  for(let i=0; i<n; i++){
    const s = document.createElement("span");
    s.style.left = Math.random()*100 + "vw";
    s.style.animationDelay = (Math.random()*0.25) + "s";
    s.style.transform = `rotate(${Math.random()*360}deg)`;
    s.style.background = colors[Math.floor(Math.random()*colors.length)];
    s.style.width = (8 + Math.random()*8) + "px";
    s.style.height = (10 + Math.random()*14) + "px";
    box.appendChild(s);
  }
  setTimeout(()=> box.innerHTML="", 1400);
}

function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* =========================
   RENDER ALL + INIT
   ========================= */
function renderAll(){
  renderTop();
  renderWordbank();
  renderFlashcard();
  renderDD();
  renderSB();
  renderFree();
}

function init(){
  fillSBSelects();

  // oppdater tellerbokser
  document.getElementById("countClothes").textContent = CLOTHES.length;
  document.getElementById("countColors").textContent = COLORS.length;

  // sett dd seed hvis mangler
  if(!S.dd.seed) S.dd.seed = Date.now();

  // hvis dd.score ikke matcher solved, sync:
  S.dd.score = Object.keys(S.dd.solved || {}).filter(k => S.dd.solved[k]).length;

  // hvis sb.current mangler, lag en
  if(!S.sb.current) newSBRound();

  renderAll();
}

init();
</script>
