<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V√™tements ‚Äì Avatar & spill</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --text:#eaf0ff;
      --muted:#b7c4ff;
      --accent:#7dd3fc;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --max: 1080px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
                  radial-gradient(1000px 700px at 80% 0%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    header{padding:28px 16px 14px;}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px 40px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .title{
      font-size: clamp(22px, 3.2vw, 34px);
      margin:10px 0 6px;
      letter-spacing:.2px;
    }
    .subtitle{color:var(--muted); margin:0 0 14px; max-width: 85ch;}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,51,.6);
      font-size: 13px;
      color: var(--muted);
    }
    .pill b{color:var(--text)}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 0;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .card .hd h2{margin:0; font-size:18px;}
    .card .bd{padding:14px 16px 16px;}
    .small{font-size:13px; color: var(--muted); margin-top:8px;}
    .divider{height:1px; background: var(--border); margin:12px 0;}
    .kicker{font-size:12px; text-transform:uppercase; letter-spacing:.12em; color: var(--muted);}

    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button.primary{
      background: rgba(125,211,252,.18);
      border-color: rgba(125,211,252,.35);
    }
    button.good{
      background: rgba(52,211,153,.16);
      border-color: rgba(52,211,153,.35);
    }
    button.warn{
      background: rgba(251,191,36,.15);
      border-color: rgba(251,191,36,.35);
    }
    button.bad{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.35);
    }

    .playbox{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(16,26,51,.35);
      padding:12px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .msg.good{border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.10)}
    .msg.bad{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10)}
    .msg.warn{border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.10)}

    select, textarea, input[type="text"], input[type="color"]{
      width:100%;
      border:1px solid var(--border);
      background: rgba(16,26,51,.35);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font: inherit;
      outline:none;
    }
    textarea{min-height: 140px; resize: vertical;}

    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 780px){ .two{grid-template-columns:1fr} }

    .hint{
      padding:10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.20);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    /* ---------- VISUAL CLOTHING CARDS ---------- */
    .shop{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 680px){ .shop{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 420px){ .shop{grid-template-columns: 1fr;} }

    .item{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(16,26,51,.45);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:grab;
      user-select:none;
    }
    .item:active{cursor:grabbing}
    .icon{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.05);
      font-size:22px;
    }
    .meta{min-width:0}
    .fr{font-weight:900}
    .no{color:var(--muted); font-size:13px}
    .tag{
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:2px 8px;
      border-radius: 999px;
    }

    /* ---------- MANNEQUIN / AVATAR ---------- */
    .avatarWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .avatarStage{
      border:1px solid var(--border);
      border-radius: 18px;
      background: rgba(16,26,51,.35);
      padding:12px;
      position:relative;
      overflow:hidden;
    }

    .mannequin{
      height: 420px;
      position: relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(circle at 30% 20%, rgba(125,211,252,.10), transparent 40%),
        radial-gradient(circle at 70% 0%, rgba(52,211,153,.08), transparent 45%),
        rgba(255,255,255,.03);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px;
    }

    /* simplistic mannequin silhouette */
    .silhouette{
      width: 220px;
      height: 400px;
      position: relative;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .head{
      width: 90px; height: 90px;
      border-radius: 999px;
      position:absolute;
      top: 16px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
    }
    .torso{
      width: 160px; height: 190px;
      border-radius: 40px;
      position:absolute;
      top: 105px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
    }
    .legs{
      width: 150px; height: 160px;
      border-radius: 40px;
      position:absolute;
      top: 285px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }

    .slotGrid{
      position:absolute;
      inset: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:10px;
      pointer-events:none; /* slots handle pointer; we enable inside */
    }

    .slot{
      pointer-events:auto;
      border:1px dashed rgba(255,255,255,.20);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:center;
      align-items:flex-start;
      min-height: 86px;
    }
    .slot strong{font-size:13px}
    .slot .placed{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      font-weight:800;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:13px;
    }
    .swatch{
      width:14px; height:14px;
      border-radius: 4px;
      border:1px solid rgba(255,255,255,.25);
      background: #ffffff;
    }

    .slot.dropOk{outline: 2px solid rgba(52,211,153,.55);}
    .slot.dropBad{outline: 2px solid rgba(251,113,133,.55);}

    .controlsRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }

    /* ---------- COLOR QUIZ ---------- */
    .colorRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 700px){ .colorRow{grid-template-columns:1fr} }

    footer{padding:18px 16px 28px; color: var(--muted); text-align:center}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,.05);
      color: var(--text);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a href="index.html">‚Üê Til meny</a>
        <span class="badge">Salut 9 ¬∑ Kapittel 4 ¬∑ V√™tements (Avatar)</span>
      </div>

      <h1 class="title">üëï V√™tements: kle p√• en manekeng + farger</h1>
      <p class="subtitle">
        Dra plagg til riktig sted p√• manekengen, velg farge, og lag en ‚Äúdagens outfit‚Äù-avatar.
        Til slutt: beskriv outfiten p√• fransk.
      </p>

      <div class="pillrow">
        <span class="pill"><b>L√¶ringsm√•l</b> Jeg kan kles- og fargegloser</span>
        <span class="pill"><b>L√¶ringsm√•l</b> Jeg kan skrive med <i>Il/Elle porte‚Ä¶</i></span>
        <span class="pill"><b>L√¶ringsm√•l</b> Jeg kan bruke farger: <i>un pantalon noir</i></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: SHOP + GAMES -->
      <section class="card">
        <div class="hd">
          <div>
            <div class="kicker">1) Dra og slipp</div>
            <h2>Butikk: dra plagg til manekengen</h2>
          </div>
          <button class="warn" id="toggleNor">Vis/skjul norsk</button>
        </div>

        <div class="bd">
          <p class="small">
            Dra et plagg til riktig ‚Äúplass‚Äù (hode/overdel/underdel/f√∏tter/tilbeh√∏r).
            Velg farge etterp√•. M√•let er <b>5 riktige plasseringer</b>.
          </p>

          <div class="shop" id="shop"></div>

          <div class="msg" id="dragFeedback" style="display:none;"></div>

          <div class="divider"></div>

          <div class="playbox">
            <div class="kicker">2) Fargeoppgave</div>
            <h2 style="margin:6px 0 8px;">Velg riktig fargeord</h2>

            <div class="colorRow">
              <div>
                <div class="small">Se fargen og velg riktig fransk ord:</div>
                <div id="colorSwatch" style="margin-top:8px; height:52px; border-radius:14px; border:1px solid var(--border); background:#7dd3fc;"></div>
              </div>
              <div>
                <label class="small" for="colorChoice">Farge p√• fransk</label>
                <select id="colorChoice"></select>
              </div>
            </div>

            <div class="controlsRow">
              <button class="good" id="checkColor">Sjekk</button>
              <button class="primary" id="newColorQ">Ny farge</button>
              <span class="pill">Poeng: <b id="colorScore">0</b>/<b id="colorTotal">0</b></span>
            </div>

            <div class="msg" id="colorFeedback" style="display:none;"></div>
          </div>

          <div class="divider"></div>

          <div class="playbox">
            <div class="kicker">3) Setningsbygger</div>
            <h2 style="margin:6px 0 8px;">Beskriv avataren din</h2>
            <p class="small">Velg hvem + setningstype. Klikk ‚ÄúLag setning‚Äù og bygg teksten din.</p>

            <div class="two">
              <div>
                <label class="small" for="person">Person</label>
                <select id="person"></select>
              </div>
              <div>
                <label class="small" for="style">Setning</label>
                <select id="style">
                  <option value="porte">Il/Elle porte‚Ä¶</option>
                  <option value="a">Il/Elle a‚Ä¶ (tilbeh√∏r)</option>
                  <option value="aime">J‚Äôaime / Je n‚Äôaime pas‚Ä¶</option>
                </select>
              </div>
            </div>

            <div class="controlsRow">
              <button class="good" id="makeSentence">Lag setning</button>
              <button id="copySentence">Kopier setning</button>
            </div>

            <div class="msg" id="sentenceOut" style="display:none;"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: AVATAR + WRITING -->
      <aside class="card">
        <div class="hd">
          <div>
            <div class="kicker">Avatar</div>
            <h2>Manekeng / ‚ÄúDagens outfit‚Äù</h2>
          </div>
          <button class="primary" id="saveAvatar">Lagre outfit</button>
        </div>

        <div class="bd">
          <div class="avatarWrap">
            <div class="avatarStage">
              <div class="mannequin" aria-label="mannequin">
                <div class="silhouette" aria-hidden="true">
                  <div class="head"></div>
                  <div class="torso"></div>
                  <div class="legs"></div>
                </div>

                <!-- Drop slots overlay -->
                <div class="slotGrid" aria-label="drop zones">
                  <div class="slot" data-slot="head">
                    <strong>Hode</strong>
                    <div class="small">Dra: chapeau / casquette</div>
                    <div class="placed" id="slot_head"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_head" title="Velg farge" />
                      <button id="clear_head">T√∏m</button>
                    </div>
                  </div>

                  <div class="slot" data-slot="accessory">
                    <strong>Tilbeh√∏r</strong>
                    <div class="small">Dra: √©charpe / lunettes / sac</div>
                    <div class="placed" id="slot_accessory"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_accessory" title="Velg farge" />
                      <button id="clear_accessory">T√∏m</button>
                    </div>
                  </div>

                  <div class="slot" data-slot="top">
                    <strong>Overdel</strong>
                    <div class="small">Dra: t-shirt / pull / veste / manteau</div>
                    <div class="placed" id="slot_top"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_top" title="Velg farge" />
                      <button id="clear_top">T√∏m</button>
                    </div>
                  </div>

                  <div class="slot" data-slot="bottom">
                    <strong>Underdel</strong>
                    <div class="small">Dra: pantalon / short / jupe / robe</div>
                    <div class="placed" id="slot_bottom"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_bottom" title="Velg farge" />
                      <button id="clear_bottom">T√∏m</button>
                    </div>
                  </div>

                  <div class="slot" data-slot="feet">
                    <strong>F√∏tter</strong>
                    <div class="small">Dra: chaussures / baskets</div>
                    <div class="placed" id="slot_feet"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_feet" title="Velg farge" />
                      <button id="clear_feet">T√∏m</button>
                    </div>
                  </div>

                  <div class="slot" data-slot="extra">
                    <strong>Ekstra</strong>
                    <div class="small">Valgfri plass</div>
                    <div class="placed" id="slot_extra"></div>
                    <div class="two" style="margin-top:6px;">
                      <input type="color" id="color_extra" title="Velg farge" />
                      <button id="clear_extra">T√∏m</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="controlsRow">
                <button class="good" id="checkOutfit">Sjekk: 5 riktige plasseringer</button>
                <button class="warn" id="loadAvatar">Last inn lagret outfit</button>
                <button class="bad" id="resetAvatar">Nullstill</button>
              </div>

              <div class="msg" id="avatarFeedback" style="display:none;"></div>
            </div>

            <div class="divider"></div>

            <div class="kicker">4) Skriveoppgave</div>
            <h2 style="margin:6px 0 8px;">Beskriv outfiten</h2>

            <p class="small">
              Skriv <b>6‚Äì10 setninger</b>. Bruk minst <b>5</b> klesord og <b>3</b> farger.
            </p>

            <div class="hint">
              <b>St√∏ttesetninger:</b><br>
              ‚Ä¢ Aujourd‚Äôhui, je porte ‚Ä¶<br>
              ‚Ä¢ Il/Elle porte ‚Ä¶<br>
              ‚Ä¢ Il/Elle porte un/une ‚Ä¶ + couleur<br>
              ‚Ä¢ J‚Äôaime / Je n‚Äôaime pas ‚Ä¶ parce que ‚Ä¶<br><br>
              <b>Mini-regel:</b> fargen kommer ofte <i>etter</i> plagget: <i>un pantalon noir</i>.
            </div>

            <div style="margin-top:10px;">
              <label class="small" for="studentText">Din tekst</label>
              <textarea id="studentText" placeholder="Skriv her... (bruk setningsbyggeren til √• komme i gang)"></textarea>
            </div>

            <div class="controlsRow">
              <button class="primary" id="saveText">Lagre tekst lokalt</button>
              <button id="copyText">Kopier tekst</button>
              <button id="checkTargets">Sjekk m√•l</button>
            </div>

            <div class="msg" id="textFeedback" style="display:none;"></div>

          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    GitHub Pages ¬∑ Alt lagres lokalt ¬∑ Neste kan v√¶re: flere ‚Äúoutfit cards‚Äù med ekte bilder
  </footer>

<script>
  // ---------------- DATA ----------------
  // Hver item har: fr/no, slot, icon (for visuelt kort)
  const ITEMS = [
    { id:"tshirt",  fr:"un t-shirt",     no:"t-skjorte", slot:"top",       icon:"üëï" },
    { id:"pull",    fr:"un pull",        no:"genser",    slot:"top",       icon:"üß∂" },
    { id:"veste",   fr:"une veste",      no:"jakke",     slot:"top",       icon:"üß•" },
    { id:"manteau", fr:"un manteau",     no:"k√•pe",      slot:"top",       icon:"üß•" },

    { id:"pantalon",fr:"un pantalon",    no:"bukse",     slot:"bottom",    icon:"üëñ" },
    { id:"short",   fr:"un short",       no:"shorts",    slot:"bottom",    icon:"ü©≥" },
    { id:"jupe",    fr:"une jupe",       no:"skj√∏rt",    slot:"bottom",    icon:"üëó" },
    { id:"robe",    fr:"une robe",       no:"kjole",     slot:"bottom",    icon:"üëó" },

    { id:"chauss",  fr:"des chaussures", no:"sko",       slot:"feet",      icon:"üëû" },
    { id:"baskets", fr:"des baskets",    no:"joggesko",  slot:"feet",      icon:"üëü" },

    { id:"chapeau", fr:"un chapeau",     no:"hatt",      slot:"head",      icon:"üé©" },
    { id:"casq",    fr:"une casquette",  no:"caps",      slot:"head",      icon:"üß¢" },

    { id:"echarpe", fr:"une √©charpe",    no:"skjerf",    slot:"accessory", icon:"üß£" },
    { id:"lunettes",fr:"des lunettes",   no:"briller",   slot:"accessory", icon:"üï∂Ô∏è" },
    { id:"sac",     fr:"un sac",         no:"veske/sekk",slot:"accessory", icon:"üéí" }
  ];

  const COLORS = [
    { fr:"noir",   no:"svart",   hex:"#111111" },
    { fr:"blanc",  no:"hvit",    hex:"#f6f7fb" },
    { fr:"bleu",   no:"bl√•",     hex:"#2563eb" },
    { fr:"rouge",  no:"r√∏d",     hex:"#ef4444" },
    { fr:"vert",   no:"gr√∏nn",   hex:"#22c55e" },
    { fr:"jaune",  no:"gul",     hex:"#facc15" },
    { fr:"gris",   no:"gr√•",     hex:"#9ca3af" },
    { fr:"rose",   no:"rosa",    hex:"#fb7185" },
    { fr:"violet", no:"lilla",   hex:"#8b5cf6" },
    { fr:"marron", no:"brun",    hex:"#7c4a2d" },
    { fr:"orange", no:"oransje", hex:"#f97316" }
  ];

  const PERSONS = ["Je", "Il", "Elle", "Mon ami", "Mon amie"];

  // ---------------- HELPERS ----------------
  const $ = (id) => document.getElementById(id);
  const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  function hexToClosestFrench(hex){
    // enkel "n√¶rmeste farge": beregn euklidisk avstand i RGB til v√•re farger
    const h = hex.replace("#","");
    const r = parseInt(h.slice(0,2),16);
    const g = parseInt(h.slice(2,4),16);
    const b = parseInt(h.slice(4,6),16);

    let best = COLORS[0], bestD = Infinity;
    for(const c of COLORS){
      const hh = c.hex.replace("#","");
      const rr = parseInt(hh.slice(0,2),16);
      const gg = parseInt(hh.slice(2,4),16);
      const bb = parseInt(hh.slice(4,6),16);
      const d = (r-rr)**2 + (g-gg)**2 + (b-bb)**2;
      if(d < bestD){ bestD = d; best = c; }
    }
    return best.fr;
  }

  function copyToClipboard(text){
    return navigator.clipboard.writeText(text);
  }

  // ---------------- UI: SHOP (drag items) ----------------
  let showNorwegian = true;

  function renderShop(){
    const shop = $("shop");
    shop.innerHTML = "";
    ITEMS.forEach(it => {
      const div = document.createElement("div");
      div.className = "item";
      div.draggable = true;
      div.dataset.itemId = it.id;

      div.innerHTML = `
        <div class="icon" aria-hidden="true">${it.icon}</div>
        <div class="meta">
          <div class="fr">${it.fr}</div>
          <div class="no" style="display:${showNorwegian?'block':'none'}">${it.no}</div>
          <div class="tag">plass: ${slotLabel(it.slot)}</div>
        </div>
      `;

      div.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", it.id);
      });

      shop.appendChild(div);
    });
  }

  function slotLabel(slot){
    return ({
      head:"hode",
      top:"overdel",
      bottom:"underdel",
      feet:"f√∏tter",
      accessory:"tilbeh√∏r",
      extra:"ekstra"
    })[slot] || slot;
  }

  $("toggleNor").addEventListener("click", () => {
    showNorwegian = !showNorwegian;
    renderShop();
  });

  // ---------------- AVATAR STATE ----------------
  const avatar = {
    head: null,
    accessory: null,
    top: null,
    bottom: null,
    feet: null,
    extra: null,
    colors: {
      head:"#7dd3fc",
      accessory:"#7dd3fc",
      top:"#7dd3fc",
      bottom:"#7dd3fc",
      feet:"#7dd3fc",
      extra:"#7dd3fc"
    }
  };

  function getItemById(id){
    return ITEMS.find(x => x.id === id) || null;
  }

  function renderSlot(slot){
    const place = $("slot_" + slot);
    place.innerHTML = "";
    const itId = avatar[slot];
    if(!itId){
      place.innerHTML = `<span class="small">tom</span>`;
      return;
    }
    const it = getItemById(itId);
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${it.icon}</span>
      <span>${it.fr}</span>
      <span class="swatch" style="background:${avatar.colors[slot]}"></span>
    `;
    place.appendChild(chip);
  }

  function renderAllSlots(){
    ["head","accessory","top","bottom","feet","extra"].forEach(renderSlot);
    // sync color inputs
    ["head","accessory","top","bottom","feet","extra"].forEach(s => {
      $("color_"+s).value = avatar.colors[s];
    });
  }

  function attachSlotDnD(){
    const slots = document.querySelectorAll(".slot");
    slots.forEach(slotEl => {
      slotEl.addEventListener("dragover", (e) => {
        e.preventDefault();
        slotEl.classList.add("dropOk");
      });
      slotEl.addEventListener("dragleave", () => {
        slotEl.classList.remove("dropOk");
        slotEl.classList.remove("dropBad");
      });
      slotEl.addEventListener("drop", (e) => {
        e.preventDefault();
        slotEl.classList.remove("dropOk");
        slotEl.classList.remove("dropBad");

        const slot = slotEl.dataset.slot;
        const itemId = e.dataTransfer.getData("text/plain");
        const it = getItemById(itemId);

        if(!it){
          flash(slotEl, false);
          return;
        }

        // allow "extra" to accept any item
        const ok = (slot === "extra") || (it.slot === slot);

        if(ok){
          avatar[slot] = it.id;
          renderSlot(slot);
          flash(slotEl, true);
          showDragMsg(`‚úÖ Riktig! ${it.fr} h√∏rer til p√• ${slotLabel(slot)}.`, true);
        }else{
          flash(slotEl, false);
          showDragMsg(`‚ùå Ikke helt: ${it.fr} h√∏rer til p√• ${slotLabel(it.slot)} (ikke ${slotLabel(slot)}).`, false);
        }
      });
    });
  }

  function flash(el, ok){
    el.classList.add(ok ? "dropOk" : "dropBad");
    setTimeout(() => el.classList.remove("dropOk","dropBad"), 700);
  }

  function showDragMsg(text, ok){
    const fb = $("dragFeedback");
    fb.style.display = "block";
    fb.className = "msg " + (ok ? "good" : "bad");
    fb.textContent = text;
  }

  // color controls
  function attachColorControls(){
    ["head","accessory","top","bottom","feet","extra"].forEach(slot => {
      $("color_"+slot).addEventListener("input", (e) => {
        avatar.colors[slot] = e.target.value;
        renderSlot(slot);
      });
      $("clear_"+slot).addEventListener("click", () => {
        avatar[slot] = null;
        renderSlot(slot);
      });
    });
  }

  // check outfit: 5 correct placements (ignores extra)
  $("checkOutfit").addEventListener("click", () => {
    let correct = 0;
    const slots = ["head","accessory","top","bottom","feet"];
    slots.forEach(s => {
      const id = avatar[s];
      if(!id) return;
      const it = getItemById(id);
      if(it && it.slot === s) correct += 1;
    });

    const fb = $("avatarFeedback");
    fb.style.display = "block";

    if(correct >= 5){
      fb.className = "msg good";
      fb.innerHTML = `üéâ Du har <b>${correct}/5</b> riktige plasseringer! N√• kan du beskrive outfiten i teksten.`;
    }else{
      fb.className = "msg bad";
      fb.innerHTML = `Du har <b>${correct}/5</b> riktige plasseringer. Pr√∏v √• fylle alle 5 (hode/tilbeh√∏r/overdel/underdel/f√∏tter).`;
    }
  });

  // save/load avatar
  const LS_AVATAR = "vetements_avatar_v1";
  $("saveAvatar").addEventListener("click", () => {
    localStorage.setItem(LS_AVATAR, JSON.stringify(avatar));
    const fb = $("avatarFeedback");
    fb.style.display = "block";
    fb.className = "msg good";
    fb.textContent = "‚úÖ Outfit lagret lokalt i nettleseren.";
  });

  $("loadAvatar").addEventListener("click", () => {
    try{
      const raw = localStorage.getItem(LS_AVATAR);
      if(!raw) throw new Error("no");
      const obj = JSON.parse(raw);
      // shallow validate
      ["head","accessory","top","bottom","feet","extra"].forEach(s => avatar[s] = obj[s] || null);
      if(obj.colors){
        ["head","accessory","top","bottom","feet","extra"].forEach(s => {
          avatar.colors[s] = obj.colors[s] || avatar.colors[s];
        });
      }
      renderAllSlots();
      const fb = $("avatarFeedback");
      fb.style.display = "block";
      fb.className = "msg good";
      fb.textContent = "‚úÖ Outfit lastet inn!";
    }catch(e){
      const fb = $("avatarFeedback");
      fb.style.display = "block";
      fb.className = "msg bad";
      fb.textContent = "Fant ingen lagret outfit enn√•.";
    }
  });

  $("resetAvatar").addEventListener("click", () => {
    if(!confirm("Nullstill avataren?")) return;
    ["head","accessory","top","bottom","feet","extra"].forEach(s => avatar[s] = null);
    renderAllSlots();
    $("avatarFeedback").style.display = "none";
  });

  // ---------------- COLOR QUIZ ----------------
  let colorScore = 0;
  let colorTotal = 0;
  let currentColor = null;

  function initColorSelect(){
    const sel = $("colorChoice");
    sel.innerHTML = "";
    COLORS.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.fr;
      opt.textContent = `${c.fr} (${c.no})`;
      sel.appendChild(opt);
    });
  }

  function newColorQuestion(){
    currentColor = shuffle([...COLORS])[0];
    $("colorSwatch").style.background = currentColor.hex;
    $("colorFeedback").style.display = "none";
  }

  $("newColorQ").addEventListener("click", newColorQuestion);

  $("checkColor").addEventListener("click", () => {
    const choice = $("colorChoice").value;
    colorTotal += 1;
    $("colorTotal").textContent = String(colorTotal);

    const ok = (choice === currentColor.fr);
    if(ok) colorScore += 1;
    $("colorScore").textContent = String(colorScore);

    const fb = $("colorFeedback");
    fb.style.display = "block";
    fb.className = "msg " + (ok ? "good" : "bad");
    fb.innerHTML = ok
      ? `‚úÖ Riktig! Det er <b>${currentColor.fr}</b>.`
      : `‚ùå Riktig er <b>${currentColor.fr}</b> (${currentColor.no}).`;

    setTimeout(newColorQuestion, 700);
  });

  // ---------------- SENTENCE BUILDER (based on avatar) ----------------
  function initPersons(){
    const sel = $("person");
    sel.innerHTML = "";
    PERSONS.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  }

  function avatarLines(){
    // build lines from filled slots
    const lines = [];
    const order = ["head","top","bottom","feet","accessory","extra"];
    for(const slot of order){
      const id = avatar[slot];
      if(!id) continue;
      const it = getItemById(id);
      const col = avatar.colors[slot] || "#7dd3fc";
      const frColor = hexToClosestFrench(col);
      lines.push({ item: it.fr, color: frColor, slot });
    }
    return lines;
  }

  function makeSentence(){
    const who = $("person").value;
    const style = $("style").value;
    const lines = avatarLines();

    let sentence = "";

    if(lines.length === 0){
      sentence = "Je porte des v√™tements aujourd‚Äôhui.";
    } else if(style === "porte"){
      // pick one clothing item (prefer top/bottom/feet)
      const preferred = lines.find(x => ["top","bottom","feet"].includes(x.slot)) || lines[0];
      sentence = `${who} porte ${preferred.item} ${preferred.color}.`;
    } else if(style === "a"){
      const acc = lines.find(x => ["head","accessory","extra"].includes(x.slot)) || lines[0];
      sentence = `${who} a ${acc.item} ${acc.color}.`;
    } else {
      // aime / n'aime pas
      const any = lines[0];
      sentence = `J‚Äôaime ${any.item} ${any.color}.`;
    }

    const out = $("sentenceOut");
    out.style.display = "block";
    out.className = "msg";
    out.textContent = sentence;
  }

  $("makeSentence").addEventListener("click", makeSentence);

  $("copySentence").addEventListener("click", async () => {
    const out = $("sentenceOut");
    if(out.style.display === "none") return;
    try{
      await copyToClipboard(out.textContent);
      out.className = "msg good";
      out.textContent = "‚úÖ Setningen er kopiert!";
      setTimeout(()=>{ out.className="msg"; }, 700);
    }catch(e){
      alert("Klarte ikke √• kopiere. Marker teksten og kopier manuelt.");
    }
  });

  // ---------------- WRITING: SAVE/CHECK ----------------
  const LS_TEXT = "vetements_text_v2";

  $("saveText").addEventListener("click", () => {
    localStorage.setItem(LS_TEXT, $("studentText").value);
    const fb = $("textFeedback");
    fb.style.display = "block";
    fb.className = "msg good";
    fb.textContent = "‚úÖ Tekst lagret lokalt.";
  });

  $("copyText").addEventListener("click", async () => {
    const txt = $("studentText").value.trim();
    if(!txt){ alert("Skriv litt tekst f√∏rst üôÇ"); return; }
    try{
      await copyToClipboard(txt);
      const fb = $("textFeedback");
      fb.style.display = "block";
      fb.className = "msg good";
      fb.textContent = "‚úÖ Teksten er kopiert.";
    }catch(e){
      alert("Klarte ikke √• kopiere. Marker teksten og kopier manuelt.");
    }
  });

  function countHits(text, arr){
    const t = text.toLowerCase();
    return arr.filter(x => t.includes(x.toLowerCase()));
  }

  $("checkTargets").addEventListener("click", () => {
    const txt = $("studentText").value;
    const fb = $("textFeedback");
    fb.style.display = "block";

    const frClothes = ITEMS.map(x=>x.fr);
    const frColors  = COLORS.map(x=>x.fr);

    const usedClothes = countHits(txt, frClothes);
    const usedColors  = countHits(txt, frColors);

    const okC = usedClothes.length >= 5;
    const okCol = usedColors.length >= 3;

    if(okC && okCol){
      fb.className = "msg good";
      fb.innerHTML = `‚úÖ Bra! Du bruker <b>${usedClothes.length}</b> klesord og <b>${usedColors.length}</b> farger.<br>
        <b>Kl√¶r:</b> ${usedClothes.join(", ")}<br>
        <b>Farger:</b> ${usedColors.join(", ")}`;
    }else{
      fb.className = "msg bad";
      fb.innerHTML = `‚ùó M√•l: <b>5</b> klesord og <b>3</b> farger.<br>
        Du har: <b>${usedClothes.length}</b> klesord og <b>${usedColors.length}</b> farger.<br><br>
        <b>Kl√¶r brukt:</b> ${usedClothes.join(", ") || "ingen enn√•"}<br>
        <b>Farger brukt:</b> ${usedColors.join(", ") || "ingen enn√•"}`;
    }
  });

  function loadSaved(){
    const t = localStorage.getItem(LS_TEXT);
    if(t) $("studentText").value = t;
    // avatar farger default:
    ["head","accessory","top","bottom","feet","extra"].forEach(s => {
      $("color_"+s).value = avatar.colors[s];
    });
  }

  // ---------------- INIT ----------------
  renderShop();
  attachSlotDnD();
  attachColorControls();
  renderAllSlots();

  initColorSelect();
  newColorQuestion();

  initPersons();
  loadSaved();
</script>
</body>
</html>
