<script>
(() => {
  "use strict";

  // ---- Vis feilmeldinger p√• siden (slik at den ikke blir "blank") ----
  function showFatal(err){
    console.error(err);
    document.body.innerHTML = `
      <div style="max-width:900px;margin:24px auto;padding:16px;border:1px solid rgba(0,0,0,.15);border-radius:12px;font-family:system-ui">
        <h2 style="margin:0 0 8px">‚ö†Ô∏è Siden krasjet i JavaScript</h2>
        <p style="margin:0 0 8px">Dette er grunnen til at siden blir blank. Se feilen under:</p>
        <pre style="white-space:pre-wrap;background:#f6f6f6;padding:12px;border-radius:10px;overflow:auto">${escapeHtml(String(err && (err.stack||err.message||err)))}</pre>
        <p style="margin:12px 0 0">Tips: √Öpne DevTools ‚Üí Console for mer detaljer.</p>
      </div>
    `;
  }
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // ---- Kj√∏r f√∏rst n√•r DOM er klar ----
  document.addEventListener("DOMContentLoaded", () => {
    try {

      /* =========================
         DATA
         ========================= */
      const CLOTHES = [
        { id:"debardeur", fr:"un d√©bardeur", no:"en singlet", emoji:"ü©±" },
        { id:"tshirt", fr:"un T-shirt", no:"en t-skjorte", emoji:"üëï" },
        { id:"robe", fr:"une robe", no:"en kjole", emoji:"üëó" },
        { id:"jupe", fr:"une jupe", no:"et skj√∏rt", emoji:"ü©≥" },
        { id:"chemise", fr:"une chemise", no:"en skjorte", emoji:"üëî" },
        { id:"pull", fr:"un pull", no:"en genser", emoji:"üß∂" },
        { id:"short", fr:"un short", no:"en shorts", emoji:"ü©≥" },
        { id:"pantalon", fr:"un pantalon", no:"en bukse", emoji:"üëñ" },
        { id:"manteau", fr:"un manteau", no:"en frakk", emoji:"üß•" },
        { id:"veste", fr:"une veste", no:"en jakke", emoji:"üß•" },
        { id:"chaussettes", fr:"des chaussettes", no:"sokker", emoji:"üß¶" },
        { id:"chaussures", fr:"des chaussures", no:"sko", emoji:"üëû" },
        { id:"baskets", fr:"des baskets", no:"joggesko", emoji:"üëü" },
        { id:"gants", fr:"des gants", no:"hansker", emoji:"üß§" },
        { id:"bonnet", fr:"un bonnet", no:"en lue", emoji:"üß¢" },
        { id:"echarpe", fr:"une √©charpe", no:"et skjerf", emoji:"üß£" },
        { id:"bottes", fr:"des bottes", no:"st√∏vler", emoji:"ü•æ" },
        { id:"ceinture", fr:"une ceinture", no:"et belte", emoji:"üß∑" },
        { id:"casquette", fr:"une casquette", no:"en caps", emoji:"üß¢" },
        { id:"maillot", fr:"un maillot de bain", no:"en badedrakt / badebukse", emoji:"ü©±" }
      ];

      const COLORS = [
        { id:"marron", fr:"marron", no:"brun", emoji:"üü§" },
        { id:"noir", fr:"noir", no:"svart", emoji:"‚ö´" },
        { id:"bleu", fr:"bleu", no:"bl√•", emoji:"üîµ" },
        { id:"vert", fr:"vert", no:"gr√∏nn", emoji:"üü¢" },
        { id:"jaune", fr:"jaune", no:"gul", emoji:"üü°" },
        { id:"gris", fr:"gris", no:"gr√•", emoji:"‚öôÔ∏è" },
        { id:"rose", fr:"rose", no:"rosa", emoji:"üå∏" },
        { id:"violet", fr:"violet", no:"lilla", emoji:"üü£" }
      ];

      const DECK = [
        ...CLOTHES.map(x => ({...x, cat:"clothes"})),
        ...COLORS.map(x => ({...x, cat:"colors"}))
      ];

      /* =========================
         STATE + STORAGE
         ========================= */
      const LS_KEY = "salut9_vetements_v1";

      const defaultState = () => ({
        xp: 0,
        fc: { idx: 0, revealed: false, mastery: {}, sessionXP: 0 },
        dd: { solved: {}, score: 0, sessionXP: 0, seed: Date.now() },
        sb: { hits: 0, rounds: 0, sessionXP: 0, current: null },
        free: { text: "", score: 0, sessionXP: 0 },
        ui: { showFR: true, filter:"all", search:"" },
        achieved: { badge:false },
        stats: { lastSaved: 0 }
      });

      function loadState(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return defaultState();
          const parsed = JSON.parse(raw);
          const base = defaultState();
          return {
            ...base, ...parsed,
            fc: {...base.fc, ...(parsed.fc||{})},
            dd: {...base.dd, ...(parsed.dd||{})},
            sb: {...base.sb, ...(parsed.sb||{})},
            free: {...base.free, ...(parsed.free||{})},
            ui: {...base.ui, ...(parsed.ui||{})},
            achieved: {...base.achieved, ...(parsed.achieved||{})},
            stats: {...base.stats, ...(parsed.stats||{})}
          };
        }catch(e){
          return defaultState();
        }
      }

      let S = loadState();

      let saveTimer = null;
      function autoSaveSoft(){
        clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> {
          localStorage.setItem(LS_KEY, JSON.stringify(S));
        }, 250);
      }

      function saveState(){
        S.stats.lastSaved = Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(S));
        toast("‚úÖ Lagret lokalt");
        renderAll();
      }

      function resetAll(){
        if(!confirm("Nullstill alt (XP + fremdrift)?")) return;
        S = defaultState();
        localStorage.removeItem(LS_KEY);
        renderAll();
        toast("üîÑ Nullstilt");
      }

      /* =========================
         DOM: HENT ALLE ELEMENTER TRYGT
         ========================= */
      function $(id){
        const el = document.getElementById(id);
        if(!el) throw new Error(`Mangler element med id="#${id}" i HTML. (Da blir siden blank.)`);
        return el;
      }

      // Top
      const xpEl = $("xp");
      const progressPctEl = $("progressPct");
      const progressBarEl = $("progressBar");
      const levelPillEl = $("levelPill");
      const badgeEl = $("badge");
      $("saveBtn").addEventListener("click", saveState);
      $("resetBtn").addEventListener("click", resetAll);

      // Wordbank
      const wordListEl = $("wordList");
      const searchEl = $("search");
      const filterEl = $("filter");
      const toggleLangBtn = $("toggleLang");

      // Flashcards
      const flashCardEl = $("flashCard");
      const fcFrontEl = $("fcFront");
      const fcBackEl = $("fcBack");
      const fcIndexEl = $("fcIndex");
      const fcTotalEl = $("fcTotal");
      const fcMasteryEl = $("fcMastery");
      const masteredCountEl = $("masteredCount");
      const deckCountEl = $("deckCount");
      const fcXPEl = $("fcXP");

      $("revealBtn").addEventListener("click", () => { S.fc.revealed = true; autoSaveSoft(); renderFlashcard(); });
      $("knewBtn").addEventListener("click", () => answerFlash("knew"));
      $("almostBtn").addEventListener("click", () => answerFlash("almost"));
      $("nopeBtn").addEventListener("click", () => answerFlash("nope"));
      $("nextBtn").addEventListener("click", () => { S.fc.revealed=false; S.fc.idx=(S.fc.idx+1)%DECK.length; autoSaveSoft(); renderFlashcard(); });

      // Drag&Drop
      const ddBankEl = $("ddBank");
      const ddTargetsEl = $("ddTargets");
      const ddScoreEl = $("ddScore");
      const ddTotalEl = $("ddTotal");
      const ddXPEl = $("ddXP");
      $("ddSave").addEventListener("click", saveState);
      $("ddReset").addEventListener("click", () => {
        if(!confirm("Starte matching p√• nytt?")) return;
        S.dd = {...defaultState().dd, seed: Date.now()};
        autoSaveSoft();
        renderDD();
        renderTop();
        toast("üîÅ Ny matching klar");
      });

      // Setningsbygger
      const sbPromptEl = $("sbPrompt");
      const sbClothEl = $("sbCloth");
      const sbColorEl = $("sbColor");
      const sbHitsEl = $("sbHits");
      const sbRoundsEl = $("sbRounds");
      const sbXPEl = $("sbXP");
      const sbFeedbackEl = $("sbFeedback");
      $("sbCheck").addEventListener("click", checkSB);
      $("sbNext").addEventListener("click", () => { newSBRound(); renderSB(); });

      // Fri tekst
      const freeTextEl = $("freeText");
      const freeScoreEl = $("freeScore");
      const freeXPEl = $("freeXP");
      $("freeSave").addEventListener("click", () => { evaluateFree(); saveState(); });
      $("freeReset").addEventListener("click", () => {
        if(!confirm("Nullstille teksten din?")) return;
        S.free = {...defaultState().free};
        freeTextEl.value = "";
        autoSaveSoft();
        renderFree();
        renderTop();
        toast("üßΩ Tekst nullstilt");
      });

      /* =========================
         XP + PROGRESS
         ========================= */
      function addXP(n){
        if(n <= 0) return;
        S.xp += n;

        if(S.xp >= 100 && !S.achieved.badge){
          S.achieved.badge = true;
          confetti();
          toast("üèÜ Badge l√•st opp: Fashion Master!");
        }
        autoSaveSoft();
        renderTop();
      }

      function levelFromXP(xp){
        if(xp >= 100) return {lvl:5, name:"Fashion Master"};
        if(xp >= 75) return {lvl:4, name:"Stylish"};
        if(xp >= 50) return {lvl:3, name:"P√• vei"};
        if(xp >= 25) return {lvl:2, name:"Learner"};
        return {lvl:1, name:"Novice"};
      }

      function masteredCount(){
        return DECK.filter(c => (S.fc.mastery[c.id]||0) >= 3).length;
      }

      function progressPercent(){
        const mastered = masteredCount();
        const fcPart = Math.min(40, Math.round((mastered / DECK.length) * 40));

        const ddItems = currentDDItems();
        const ddTotal = Math.max(1, ddItems.length);
        const ddDone = (S.dd.score >= ddTotal) ? 25 : Math.round((S.dd.score / ddTotal) * 25);

        const sbGoalRounds = 6;
        const sbPart = Math.min(
          20,
          Math.round(
            (Math.min(S.sb.rounds, sbGoalRounds) / sbGoalRounds) * 14 +
            (Math.min(S.sb.hits, 4) / 4) * 6
          )
        );

        const freePart = Math.min(15, Math.round((S.free.score / 6) * 15));
        return Math.max(0, Math.min(100, fcPart + ddDone + sbPart + freePart));
      }

      function renderTop(){
        xpEl.textContent = S.xp;
        const p = progressPercent();
        progressPctEl.textContent = `${p}%`;
        progressBarEl.style.width = `${p}%`;

        const lv = levelFromXP(S.xp);
        levelPillEl.textContent = `Niv√•: ${lv.lvl} ¬∑ ${lv.name}`;

        badgeEl.textContent = S.achieved.badge ? "üèÜ Fashion Master" : "üîí L√•st";
        badgeEl.style.background = S.achieved.badge ? "rgba(34,197,94,.18)" : "rgba(255,255,255,.06)";
      }

      /* =========================
         ORDBANK
         ========================= */
      searchEl.value = S.ui.search;
      filterEl.value = S.ui.filter;
      toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR ‚Üí NO" : "Vis: NO ‚Üí FR";

      searchEl.addEventListener("input", () => { S.ui.search = searchEl.value; autoSaveSoft(); renderWordbank(); });
      filterEl.addEventListener("change", () => { S.ui.filter = filterEl.value; autoSaveSoft(); renderWordbank(); });
      toggleLangBtn.addEventListener("click", () => {
        S.ui.showFR = !S.ui.showFR;
        toggleLangBtn.textContent = S.ui.showFR ? "Vis: FR ‚Üí NO" : "Vis: NO ‚Üí FR";
        autoSaveSoft();
        renderWordbank();
      });

      function renderWordbank(){
        const q = (S.ui.search || "").trim().toLowerCase();
        const f = S.ui.filter;

        let items = DECK.slice();
        if(f === "clothes") items = items.filter(x => x.cat === "clothes");
        if(f === "colors") items = items.filter(x => x.cat === "colors");

        if(q){
          items = items.filter(x => {
            const fr = (x.fr||"").toLowerCase();
            const no = (x.no||"").toLowerCase();
            const id = (x.id||"").toLowerCase();
            return fr.includes(q) || no.includes(q) || id.includes(q);
          });
        }

        wordListEl.innerHTML = "";
        items.forEach(x => {
          const left = S.ui.showFR ? x.fr : x.no;
          const right = S.ui.showFR ? x.no : x.fr;

          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div>
              <strong>${escapeHtml(x.emoji)} ${escapeHtml(left)}</strong>
              <small>${escapeHtml(right)}</small>
            </div>
            <span class="tag">${x.cat === "clothes" ? "Kl√¶r" : "Farger"}</span>
          `;
          wordListEl.appendChild(row);
        });

        $("countClothes").textContent = CLOTHES.length;
        $("countColors").textContent = COLORS.length;
      }

      /* =========================
         FLASHCARDS
         ========================= */
      function currentCard(){
        const idx = ((S.fc.idx||0) % DECK.length + DECK.length) % DECK.length;
        return DECK[idx];
      }

      function renderFlashcard(){
        const card = currentCard();
        const showFR = true;

        fcFrontEl.textContent = `${card.emoji} ${showFR ? card.fr : card.no}`;
        fcBackEl.textContent = `${showFR ? card.no : card.fr}`;

        fcTotalEl.textContent = DECK.length;
        fcIndexEl.textContent = (S.fc.idx % DECK.length) + 1;

        const m = S.fc.mastery[card.id] || 0;
        fcMasteryEl.textContent = `${m}`;

        deckCountEl.textContent = DECK.length;
        masteredCountEl.textContent = masteredCount();
        fcXPEl.textContent = S.fc.sessionXP;

        flashCardEl.classList.toggle("revealed", !!S.fc.revealed);
        $("knewBtn").disabled = !S.fc.revealed;
        $("almostBtn").disabled = !S.fc.revealed;
        $("nopeBtn").disabled = !S.fc.revealed;
      }

      function answerFlash(kind){
        const card = currentCard();
        const m = S.fc.mastery[card.id] || 0;

        let deltaM = 0;
        let gained = 0;

        if(kind === "knew"){ deltaM = 1; gained = 3; }
        else if(kind === "almost"){ deltaM = 1; gained = 1; }

        S.fc.mastery[card.id] = Math.min(3, m + deltaM);

        if(gained > 0){
          S.fc.sessionXP += gained;
          addXP(gained);
          toast(`‚≠ê +${gained} XP (flashcard)`);
        }

        S.fc.revealed = false;
        S.fc.idx = (S.fc.idx + 1) % DECK.length;

        autoSaveSoft();
        renderAll();
      }

      /* =========================
         MATCHING (Drag & Drop)
         ========================= */
      function mulberry32(seed){
        let a = seed >>> 0;
        return function() {
          a |= 0; a = a + 0x6D2B79F5 | 0;
          let t = Math.imul(a ^ a >>> 15, 1 | a);
          t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
      }
      function shuffleWithSeed(arr, seed){
        const rnd = mulberry32(seed);
        const a = arr.slice();
        for(let i=a.length-1; i>0; i--){
          const j = Math.floor(rnd() * (i+1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }
      function currentDDItems(){
        const base = CLOTHES.slice();
        const seed = S.dd.seed || Date.now();
        const shuffled = shuffleWithSeed(base, seed);
        return shuffled.slice(0, Math.min(8, shuffled.length));
      }

      function renderDD(){
        const items = currentDDItems();
        ddTotalEl.textContent = items.length;
        ddScoreEl.textContent = S.dd.score;
        ddXPEl.textContent = S.dd.sessionXP;

        ddBankEl.innerHTML = "";
        items.forEach(it => {
          if(S.dd.solved[it.id]) return;
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.draggable = true;
          chip.textContent = it.fr;
          chip.dataset.id = it.id;
          chip.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", it.id);
            e.dataTransfer.effectAllowed = "move";
          });
          ddBankEl.appendChild(chip);
        });

        ddTargetsEl.innerHTML = "";
        items.forEach(it => {
          const solved = !!S.dd.solved[it.id];
          const target = document.createElement("div");
          target.className = "target";
          target.innerHTML = `
            <div class="left">
              <div class="emoji">${escapeHtml(it.emoji)}</div>
              <div>
                <strong>${escapeHtml(it.no)}</strong>
                <div class="mini muted">Slipp riktig FR-ord her</div>
              </div>
            </div>
            <div class="drop ${solved ? "filled" : ""}" data-accept="${escapeHtml(it.id)}">
              ${solved ? escapeHtml(it.fr) : "Dra ord hit"}
            </div>
          `;

          const drop = target.querySelector(".drop");
          drop.addEventListener("dragover", (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; });
          drop.addEventListener("drop", (e) => {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData("text/plain");
            const acceptId = drop.dataset.accept;
            if(!draggedId) return;
            if(S.dd.solved[acceptId]) return;

            if(draggedId === acceptId){
              S.dd.solved[acceptId] = true;
              S.dd.score = Object.keys(S.dd.solved).filter(k => S.dd.solved[k]).length;

              const gained = 3;
              S.dd.sessionXP += gained;
              addXP(gained);

              toast("‚úÖ Riktig! +3 XP");
              drop.classList.remove("bad");
              drop.classList.add("filled");
              autoSaveSoft();
              renderDD();
              renderTop();
            }else{
              drop.classList.add("bad");
              toast("‚ùå Ikke helt ‚Äì pr√∏v igjen");
              setTimeout(()=> drop.classList.remove("bad"), 450);
            }
          });

          ddTargetsEl.appendChild(target);
        });
      }

      /* =========================
         SETNINGSBYGGER
         ========================= */
      function fillSBSelects(){
        sbClothEl.innerHTML = "";
        CLOTHES.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.emoji} ${c.fr}`;
          sbClothEl.appendChild(opt);
        });

        sbColorEl.innerHTML = "";
        COLORS.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.emoji} ${c.fr}`;
          sbColorEl.appendChild(opt);
        });
      }

      function newSBRound(){
        const cloth = CLOTHES[Math.floor(Math.random()*CLOTHES.length)];
        const color = COLORS[Math.floor(Math.random()*COLORS.length)];

        const patterns = [
          { id:"porte", text:`Lag setningen: Je porte ${cloth.fr} ${color.fr}.`, answer:`Je porte ${cloth.fr} ${color.fr}.`},
          { id:"aime", text:`Velg riktig for: J‚Äôaime ${cloth.fr} ${color.fr}.`, answer:`J‚Äôaime ${cloth.fr} ${color.fr}.`},
          { id:"naime", text:`Velg riktig for: Je n‚Äôaime pas ${cloth.fr} ${color.fr}.`, answer:`Je n‚Äôaime pas ${cloth.fr} ${color.fr}.`}
        ];
        const p = patterns[Math.floor(Math.random()*patterns.length)];

        S.sb.current = { clothId: cloth.id, colorId: color.id, pattern: p.id, answer: p.answer, prompt: p.text };
        autoSaveSoft();

        sbPromptEl.textContent = p.text;
        sbFeedbackEl.className = "fb";
        sbFeedbackEl.textContent = "Velg plagg + farge og trykk Sjekk.";
      }

      function renderSB(){
        sbHitsEl.textContent = S.sb.hits;
        sbRoundsEl.textContent = S.sb.rounds;
        sbXPEl.textContent = S.sb.sessionXP;

        if(!S.sb.current) newSBRound();

        if(!sbClothEl.value) sbClothEl.value = CLOTHES[0]?.id || "";
        if(!sbColorEl.value) sbColorEl.value = COLORS[0]?.id || "";

        sbPromptEl.textContent = S.sb.current.prompt;
      }

      function checkSB(){
        if(!S.sb.current) return;

        const chosenCloth = sbClothEl.value;
        const chosenColor = sbColorEl.value;

        S.sb.rounds += 1;

        const ok = (chosenCloth === S.sb.current.clothId) && (chosenColor === S.sb.current.colorId);

        if(ok){
          S.sb.hits += 1;
          const gained = 4;
          S.sb.sessionXP += gained;
          addXP(gained);

          sbFeedbackEl.className = "fb good";
          sbFeedbackEl.textContent = `‚úÖ Riktig! +${gained} XP ¬∑ Fasit: ${S.sb.current.answer}`;
          toast(`‚úÖ +${gained} XP (setning)`);
        }else{
          sbFeedbackEl.className = "fb bad";
          sbFeedbackEl.textContent = `‚ùå Nesten. Fasit: ${S.sb.current.answer}`;
        }

        autoSaveSoft();
        renderSB();
        renderTop();
      }

      /* =========================
         FRI MINIOPPGAVE
         ========================= */
      function normalize(s){
        return (s||"")
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      function countClothesMentions(tNorm){
        let count = 0;
        CLOTHES.forEach(c => {
          const fr = normalize(c.fr);
          const bare = fr.replace(/^un\s+|^une\s+|^des\s+/,"");
          if(tNorm.includes(fr) || tNorm.includes(bare)) count += 1;
        });
        return count;
      }

      function freeFeedbackScore(text){
        const t = normalize(text);

        const checks = [
          { ok: /je\s+porte/.test(t) },
          { ok: /j[' ]aime/.test(t) },
          { ok: /je\s+n[' ]aime\s+pas/.test(t) },
          { ok: /parce\s+que/.test(t) },
          { ok: COLORS.some(c => t.includes(normalize(c.fr))) },
          { ok: countClothesMentions(t) >= 2 }
        ];

        return checks.reduce((sum, c) => sum + (c.ok ? 1 : 0), 0);
      }

      function renderFree(){
        freeScoreEl.textContent = S.free.score;
        freeXPEl.textContent = S.free.sessionXP;
      }

      function evaluateFree(){
        const text = freeTextEl.value || "";
        const score = freeFeedbackScore(text);

        const prev = S.free.score || 0;
        S.free.text = text;
        S.free.score = score;

        const diff = Math.max(0, score - prev);
        if(diff > 0){
          const gained = diff * 2;
          S.free.sessionXP += gained;
          addXP(gained);
          toast(`‚ú® +${gained} XP (m√∏nstre)`);
        }

        autoSaveSoft();
        renderFree();
        renderTop();
      }

      freeTextEl.value = S.free.text || "";
      freeTextEl.addEventListener("input", () => {
        const score = freeFeedbackScore(freeTextEl.value || "");
        S.free.text = freeTextEl.value || "";
        S.free.score = score;
        autoSaveSoft();
        renderFree();
      });

      /* =========================
         TOAST + CONFETTI
         ========================= */
      let toastTimer = null;
      function toast(msg){
        clearTimeout(toastTimer);
        let el = document.getElementById("toast");
        if(!el){
          el = document.createElement("div");
          el.id = "toast";
          el.style.position = "fixed";
          el.style.left = "50%";
          el.style.bottom = "18px";
          el.style.transform = "translateX(-50%)";
          el.style.padding = "10px 12px";
          el.style.borderRadius = "14px";
          el.style.border = "1px solid rgba(255,255,255,.14)";
          el.style.background = "rgba(15,23,42,.85)";
          el.style.color = "white";
          el.style.fontWeight = "800";
          el.style.boxShadow = "0 12px 30px rgba(0,0,0,.35)";
          el.style.zIndex = "99999";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.opacity = "1";
        toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
      }

      function confetti(){
        const box = document.getElementById("confetti");
        if(!box) return;
        box.innerHTML = "";
        const colors = ["rgba(124,58,237,.95)","rgba(34,197,94,.95)","rgba(96,165,250,.95)","rgba(245,158,11,.95)"];
        const n = 64;

        for(let i=0; i<n; i++){
          const s = document.createElement("span");
          s.style.left = Math.random()*100 + "vw";
          s.style.animationDelay = (Math.random()*0.25) + "s";
          s.style.transform = `rotate(${Math.random()*360}deg)`;
          s.style.background = colors[Math.floor(Math.random()*colors.length)];
          s.style.width = (8 + Math.random()*8) + "px";
          s.style.height = (10 + Math.random()*14) + "px";
          box.appendChild(s);
        }
        setTimeout(()=> box.innerHTML="", 1400);
      }

      /* =========================
         INIT + RENDER ALL
         ========================= */
      function renderAll(){
        renderTop();
        renderWordbank();
        renderFlashcard();
        renderDD();
        renderSB();
        renderFree();
      }

      // sync
      if(!S.dd.seed) S.dd.seed = Date.now();
      S.dd.score = Object.keys(S.dd.solved || {}).filter(k => S.dd.solved[k]).length;
      if(!S.sb.current) newSBRound();

      // init selects + counts
      fillSBSelects();
      $("countClothes").textContent = CLOTHES.length;
      $("countColors").textContent = COLORS.length;

      renderAll();

    } catch (err) {
      showFatal(err);
    }
  });
})();
</script>
