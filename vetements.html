<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V√™tements ‚Äì iPad-vennlig avatar</title>

  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#b7c4ff;
      --accent:#7dd3fc;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --max: 1080px;
      --card: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(1000px 700px at 80% 0%, rgba(52,211,153,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    header{padding:28px 16px 14px;}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px 40px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .title{font-size: clamp(22px, 3.2vw, 34px); margin:10px 0 6px;}
    .subtitle{color:var(--muted); margin:0 0 14px; max-width: 85ch;}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,51,.6);
      font-size: 13px; color: var(--muted);
    }
    .pill b{color:var(--text)}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{padding:16px 16px 0; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    .hd h2{margin:0; font-size:18px;}
    .bd{padding:14px 16px 16px;}
    .kicker{font-size:12px; text-transform:uppercase; letter-spacing:.12em; color: var(--muted);}
    .small{font-size:13px; color: var(--muted); margin-top:8px;}
    .divider{height:1px; background: var(--border); margin:12px 0;}

    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      touch-action: manipulation;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button.primary{background: rgba(125,211,252,.18); border-color: rgba(125,211,252,.35);}
    button.good{background: rgba(52,211,153,.16); border-color: rgba(52,211,153,.35);}
    button.warn{background: rgba(251,191,36,.15); border-color: rgba(251,191,36,.35);}
    button.bad{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.35);}

    .msg{
      margin-top:10px; padding:10px 12px; border-radius: 14px;
      border:1px solid var(--border); background: rgba(255,255,255,.05);
    }
    .msg.good{border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.10)}
    .msg.bad{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10)}
    .msg.warn{border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.10)}

    /* --- sprite item cards --- */
    .shop{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;}
    @media (max-width: 520px){ .shop{grid-template-columns:1fr} }

    .item{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(16,26,51,.45);
      padding:10px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none; /* IMPORTANT: allows finger dragging */
    }
    .thumb{
      width:64px; height:64px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .meta{min-width:0}
    .fr{font-weight:900}
    .no{color:var(--muted); font-size:13px}
    .tag{
      display:inline-block; margin-top:6px;
      font-size:12px; color: var(--muted);
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:2px 8px; border-radius: 999px;
    }

    /* --- avatar stage --- */
    .stage{
      border:1px solid var(--border);
      border-radius: 18px;
      background: rgba(16,26,51,.35);
      padding:12px;
    }
    .mannequinArea{
      position: relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      min-height: 420px;
    }
    .baseSprite{
      position:absolute; inset: 0;
      display:flex; align-items:center; justify-content:center;
      padding: 10px;
    }
    .baseSprite .baseBox{
      width: 100%;
      height: 100%;
      max-height: 420px;
      aspect-ratio: 16 / 9;
      border-radius: 18px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }

    /* placed clothing preview chips */
    .slotRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 520px){ .slotRow{grid-template-columns:1fr} }
    .slot{
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
      padding:10px;
      min-height: 94px;
    }
    .slot strong{font-size:13px}
    .slot .placed{margin-top:6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .placedThumb{
      width:54px; height:54px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:13px;
      font-weight:800;
    }
    .swatch{
      width:14px; height:14px; border-radius: 4px;
      border:1px solid rgba(255,255,255,.25);
      background:#fff;
    }
    .slot.hot{outline: 2px solid rgba(125,211,252,.45);}
    .controlsRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}

    /* color buttons (touch friendly) */
    .colors{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){ .colors{grid-template-columns: repeat(2, 1fr);} }
    .cbtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(16,26,51,.35);
      border-radius: 14px;
      padding:10px;
      text-align:left;
      touch-action: manipulation;
    }
    .cbtn .box{
      height:28px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      margin-bottom:6px;
    }
    .cbtn b{display:block}
    .cbtn span{color:var(--muted); font-size:12px}
    .cbtn.selected{outline: 2px solid rgba(52,211,153,.55);}

    select, textarea{
      width:100%;
      border:1px solid var(--border);
      background: rgba(16,26,51,.35);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font: inherit;
      outline:none;
    }
    textarea{min-height: 140px; resize: vertical;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 780px){ .two{grid-template-columns:1fr} }

    .hint{
      padding:10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.20);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    /* floating dragged preview */
    .dragGhost{
      position: fixed;
      width: 84px; height:84px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.20);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      pointer-events:none;
      z-index: 9999;
      transform: translate(-9999px,-9999px);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a href="index.html">‚Üê Til meny</a>
        <span class="badge">Salut 9 ¬∑ Kapittel 4 ¬∑ V√™tements (iPad)</span>
      </div>

      <h1 class="title">üëï Kl√¶r og farger: dra plagg til riktig sted</h1>
      <p class="subtitle">
        iPad-vennlig: dra med finger. Velg farge og lag setninger: <i>Il/Elle porte‚Ä¶</i>
      </p>

      <div class="pillrow">
        <span class="pill"><b>M√•l</b> Jeg kan 5 klesord + 3 farger</span>
        <span class="pill"><b>M√•l</b> Jeg kan skrive 6‚Äì10 setninger</span>
        <span class="pill"><b>Touch</b> Hold og dra plagget</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <div>
            <div class="kicker">1) Plagg</div>
            <h2>Dra riktig plagg</h2>
          </div>
          <button class="warn" id="toggleNor">Vis/skjul norsk</button>
        </div>
        <div class="bd">
          <div class="small">
            Dra til: <b>Hode</b>, <b>Overdel</b>, <b>Underdel</b>, <b>F√∏tter</b>.
          </div>

          <div class="shop" id="shop"></div>

          <div id="dragFeedback" class="msg" style="display:none;"></div>

          <div class="divider"></div>

          <div class="playbox">
            <div class="kicker">2) Farger</div>
            <h2 style="margin:6px 0 8px;">Velg farge (touch)</h2>
            <div class="small">Trykk en farge. Den brukes p√• setninger (og lagres med plagget).</div>
            <div class="colors" id="colors"></div>
            <div class="msg" id="colorFeedback" style="display:none;"></div>
          </div>

          <div class="divider"></div>

          <div class="playbox">
            <div class="kicker">3) Setningsbygger</div>
            <h2 style="margin:6px 0 8px;">Lag setning fra outfiten</h2>

            <div class="two">
              <div>
                <label class="small" for="person">Person</label>
                <select id="person"></select>
              </div>
              <div>
                <label class="small" for="pickSlot">Hvilket plagg?</label>
                <select id="pickSlot">
                  <option value="top">Overdel</option>
                  <option value="bottom">Underdel</option>
                  <option value="feet">F√∏tter</option>
                  <option value="head">Hode</option>
                </select>
              </div>
            </div>

            <div class="controlsRow">
              <button class="good" id="makeSentence">Lag setning</button>
              <button id="copySentence">Kopier setning</button>
            </div>

            <div class="msg" id="sentenceOut" style="display:none;"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="hd">
          <div>
            <div class="kicker">Avatar</div>
            <h2>Manneken + slots</h2>
          </div>
          <button class="primary" id="saveOutfit">Lagre outfit</button>
        </div>
        <div class="bd">
          <div class="stage">
            <div class="mannequinArea" id="mannequinArea">
              <div class="baseSprite">
                <div class="baseBox" id="baseBox" aria-label="sprite base"></div>
              </div>
            </div>

            <div class="slotRow">
              <div class="slot" data-slot="head" id="slot_head">
                <strong>Hode</strong>
                <div class="small">casquette</div>
                <div class="placed" id="placed_head"></div>
              </div>

              <div class="slot" data-slot="top" id="slot_top">
                <strong>Overdel</strong>
                <div class="small">t-shirt</div>
                <div class="placed" id="placed_top"></div>
              </div>

              <div class="slot" data-slot="bottom" id="slot_bottom">
                <strong>Underdel</strong>
                <div class="small">pantalon</div>
                <div class="placed" id="placed_bottom"></div>
              </div>

              <div class="slot" data-slot="feet" id="slot_feet">
                <strong>F√∏tter</strong>
                <div class="small">chaussures</div>
                <div class="placed" id="placed_feet"></div>
              </div>
            </div>

            <div class="controlsRow">
              <button class="good" id="checkOutfit">Sjekk: 4 plagg plassert</button>
              <button class="warn" id="loadOutfit">Last inn</button>
              <button class="bad" id="resetOutfit">Nullstill</button>
            </div>

            <div class="msg" id="outfitFeedback" style="display:none;"></div>
          </div>

          <div class="divider"></div>

          <div class="kicker">4) Skriveoppgave</div>
          <h2 style="margin:6px 0 8px;">Beskriv antrekket</h2>

          <div class="hint">
            <b>St√∏tte:</b><br>
            ‚Ä¢ Aujourd‚Äôhui, je porte ‚Ä¶<br>
            ‚Ä¢ Il/Elle porte un/une ‚Ä¶ + couleur<br>
            ‚Ä¢ J‚Äôaime / Je n‚Äôaime pas ‚Ä¶<br><br>
            <b>Regel:</b> farge ofte etter plagg: <i>un pantalon noir</i>.
          </div>

          <div style="margin-top:10px;">
            <label class="small" for="studentText">Din tekst</label>
            <textarea id="studentText" placeholder="Skriv 6‚Äì10 setninger..."></textarea>
          </div>

          <div class="controlsRow">
            <button class="primary" id="saveText">Lagre tekst</button>
            <button id="copyText">Kopier tekst</button>
            <button id="checkTargets">Sjekk m√•l</button>
          </div>

          <div class="msg" id="textFeedback" style="display:none;"></div>
        </div>
      </aside>
    </div>
  </main>

  <div class="dragGhost" id="dragGhost"></div>

<script>
  // =========================================================
  // 1) SETT RIKTIG FILNAVN HER:
  // =========================================================
  const SPRITE_SRC = "assets/img/vetements/SETT-INN-FILNAVN-HER.png";

  // =========================================================
  // 2) Sprite-klipp (ca. prosent). Juster senere om n√∏dvendig.
  //    (Dette er basert p√• bildet du viste: manneken venstre,
  //     t-skjorte √∏verst midt, bukse midt, caps √∏verst h√∏yre,
  //     sko nede.)
  // =========================================================
  // crop: x,y,w,h i 0..1 (andel av hele bildet)
  const CROPS = {
    base:      { x:0.03, y:0.05, w:0.28, h:0.88 }, // manneken
    tshirt:    { x:0.38, y:0.06, w:0.25, h:0.23 },
    pantalon:  { x:0.41, y:0.32, w:0.22, h:0.36 },
    casquette: { x:0.73, y:0.07, w:0.24, h:0.22 },
    chaussures:{ x:0.70, y:0.40, w:0.27, h:0.22 }  // sko (√∏verst av sko-omr√•det)
  };

  // Items i butikken
  const ITEMS = [
    { id:"tshirt", fr:"un t-shirt", no:"t-skjorte", slot:"top", crop:"tshirt" },
    { id:"pantalon", fr:"un pantalon", no:"bukse", slot:"bottom", crop:"pantalon" },
    { id:"casquette", fr:"une casquette", no:"caps", slot:"head", crop:"casquette" },
    { id:"chaussures", fr:"des chaussures", no:"sko", slot:"feet", crop:"chaussures" }
  ];

  const COLORS = [
    { fr:"noir",   no:"svart",   hex:"#111111" },
    { fr:"blanc",  no:"hvit",    hex:"#f6f7fb" },
    { fr:"bleu",   no:"bl√•",     hex:"#2563eb" },
    { fr:"rouge",  no:"r√∏d",     hex:"#ef4444" },
    { fr:"vert",   no:"gr√∏nn",   hex:"#22c55e" },
    { fr:"jaune",  no:"gul",     hex:"#facc15" },
    { fr:"gris",   no:"gr√•",     hex:"#9ca3af" },
    { fr:"rose",   no:"rosa",    hex:"#fb7185" },
    { fr:"violet", no:"lilla",   hex:"#8b5cf6" },
    { fr:"marron", no:"brun",    hex:"#7c4a2d" },
    { fr:"orange", no:"oransje", hex:"#f97316" }
  ];

  const PERSONS = ["Je", "Il", "Elle", "Mon ami", "Mon amie"];

  // =========================================================
  // Helpers
  // =========================================================
  const $ = (id) => document.getElementById(id);

  function spriteStyle(crop, sizePx=64){
    // Klassisk sprite: zoom bakgrunnen slik at "crop" fyller boksen.
    // background-size = (1/crop.w)*100%
    // background-position = -(crop.x/crop.w)*100%
    const c = CROPS[crop];
    const bgSizeX = (1 / c.w) * 100;
    const bgSizeY = (1 / c.h) * 100;
    const bgPosX  = -(c.x / c.w) * 100;
    const bgPosY  = -(c.y / c.h) * 100;

    return `
      width:${sizePx}px; height:${sizePx}px;
      background-image: url('${SPRITE_SRC}');
      background-repeat:no-repeat;
      background-size: ${bgSizeX}% ${bgSizeY}%;
      background-position: ${bgPosX}% ${bgPosY}%;
    `;
  }

  function setSpriteEl(el, crop, sizePx){
    el.style.cssText += spriteStyle(crop, sizePx);
  }

  function copyToClipboard(text){
    return navigator.clipboard.writeText(text);
  }

  // =========================================================
  // State: outfit + chosen color
  // =========================================================
  const outfit = { head:null, top:null, bottom:null, feet:null };
  const outfitColor = { head:"bleu", top:"bleu", bottom:"bleu", feet:"bleu" }; // store french color word
  let selectedColor = COLORS[2]; // bleu default
  let showNorwegian = true;

  // =========================================================
  // Render base sprite (mannequin)
  // =========================================================
  function renderBase(){
    const baseBox = $("baseBox");
    baseBox.style.cssText = `
      ${spriteStyle("base", 420)}
      margin: 0 auto;
      max-width: 520px;
      height: 420px;
      border-radius: 18px;
    `;
  }

  // =========================================================
  // Render shop items (touch-drag)
  // =========================================================
  function renderShop(){
    const shop = $("shop");
    shop.innerHTML = "";
    ITEMS.forEach(it => {
      const card = document.createElement("div");
      card.className = "item";
      card.dataset.itemId = it.id;

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      setSpriteEl(thumb, it.crop, 64);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div class="fr">${it.fr}</div>
        <div class="no" style="display:${showNorwegian?'block':'none'}">${it.no}</div>
        <div class="tag">plass: ${slotLabel(it.slot)}</div>
      `;

      card.appendChild(thumb);
      card.appendChild(meta);

      // iPad-friendly drag
      attachPointerDrag(card, it);

      shop.appendChild(card);
    });
  }

  function slotLabel(slot){
    return ({head:"hode", top:"overdel", bottom:"underdel", feet:"f√∏tter"})[slot] || slot;
  }

  $("toggleNor").addEventListener("click", () => {
    showNorwegian = !showNorwegian;
    renderShop();
  });

  // =========================================================
  // Touch drag system (pointer events)
  // =========================================================
  const ghost = $("dragGhost");
  let dragging = null; // { item, pointerId }

  function attachPointerDrag(card, item){
    card.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      card.setPointerCapture(e.pointerId);

      dragging = { item, pointerId: e.pointerId };

      // show ghost with sprite thumbnail
      ghost.style.cssText = ghost.style.cssText + spriteStyle(item.crop, 84);
      moveGhost(e.clientX, e.clientY);
      ghost.style.transform = `translate(${e.clientX - 42}px, ${e.clientY - 42}px)`;

      highlightSlotAt(e.clientX, e.clientY);
    });

    card.addEventListener("pointermove", (e) => {
      if(!dragging || dragging.pointerId !== e.pointerId) return;
      moveGhost(e.clientX, e.clientY);
      highlightSlotAt(e.clientX, e.clientY);
    });

    card.addEventListener("pointerup", (e) => {
      if(!dragging || dragging.pointerId !== e.pointerId) return;
      clearHighlights();
      const dropSlot = slotFromPoint(e.clientX, e.clientY);
      finishDrop(dropSlot, dragging.item);
      dragging = null;
      hideGhost();
      try{ card.releasePointerCapture(e.pointerId); }catch(_){}
    });

    card.addEventListener("pointercancel", () => {
      dragging = null;
      clearHighlights();
      hideGhost();
    });
  }

  function moveGhost(x,y){
    ghost.style.transform = `translate(${x - 42}px, ${y - 42}px)`;
  }
  function hideGhost(){
    ghost.style.transform = `translate(-9999px,-9999px)`;
    ghost.style.backgroundImage = "";
  }

  function slotFromPoint(x,y){
    const el = document.elementFromPoint(x,y);
    if(!el) return null;
    const slotEl = el.closest?.(".slot");
    return slotEl ? slotEl.dataset.slot : null;
  }

  function highlightSlotAt(x,y){
    clearHighlights();
    const s = slotFromPoint(x,y);
    if(s) $("slot_"+s).classList.add("hot");
  }
  function clearHighlights(){
    ["head","top","bottom","feet"].forEach(s => $("slot_"+s).classList.remove("hot"));
  }

  function finishDrop(slot, item){
    const fb = $("dragFeedback");
    fb.style.display = "block";

    if(!slot){
      fb.className = "msg warn";
      fb.textContent = "Slipp plagget p√• en av rutene (hode/overdel/underdel/f√∏tter).";
      return;
    }

    if(item.slot !== slot){
      fb.className = "msg bad";
      fb.textContent = `‚ùå ${item.fr} h√∏rer til p√• ${slotLabel(item.slot)} (ikke ${slotLabel(slot)}).`;
      return;
    }

    outfit[slot] = item.id;
    outfitColor[slot] = selectedColor.fr;
    renderPlaced();
    fb.className = "msg good";
    fb.textContent = `‚úÖ Riktig! ${item.fr} plassert p√• ${slotLabel(slot)}. Farge satt til ${selectedColor.fr}.`;
  }

  // =========================================================
  // Render placed items in slots
  // =========================================================
  function renderPlaced(){
    ["head","top","bottom","feet"].forEach(slot => {
      const box = $("placed_"+slot);
      box.innerHTML = "";

      const id = outfit[slot];
      if(!id){
        box.innerHTML = `<span class="small">tom</span>`;
        return;
      }

      const it = ITEMS.find(x => x.id === id);
      const thumb = document.createElement("div");
      thumb.className = "placedThumb";
      setSpriteEl(thumb, it.crop, 54);

      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<span>${it.fr}</span><span class="swatch" style="background:${selectedColorHex(outfitColor[slot])}"></span>`;

      box.appendChild(thumb);
      box.appendChild(chip);
    });
  }

  function selectedColorHex(fr){
    const c = COLORS.find(x => x.fr === fr);
    return c ? c.hex : "#7dd3fc";
  }

  // =========================================================
  // Color buttons
  // =========================================================
  function renderColors(){
    const grid = $("colors");
    grid.innerHTML = "";
    COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "cbtn" + (c.fr === selectedColor.fr ? " selected" : "");
      btn.innerHTML = `
        <div class="box" style="background:${c.hex}"></div>
        <b>${c.fr}</b>
        <span>${c.no}</span>
      `;
      btn.addEventListener("click", () => {
        selectedColor = c;
        renderColors();
        const fb = $("colorFeedback");
        fb.style.display = "block";
        fb.className = "msg good";
        fb.textContent = `Farge valgt: ${c.fr} (${c.no}). Dra et plagg og slipp p√• riktig plass.`;
      });
      grid.appendChild(btn);
    });
  }

  // =========================================================
  // Check outfit
  // =========================================================
  $("checkOutfit").addEventListener("click", () => {
    const filled = ["head","top","bottom","feet"].filter(s => outfit[s]).length;
    const fb = $("outfitFeedback");
    fb.style.display = "block";

    if(filled === 4){
      fb.className = "msg good";
      fb.innerHTML = `üéâ Du har plassert <b>4/4</b> plagg! N√•: lag setninger og skriv teksten.`;
    } else {
      fb.className = "msg bad";
      fb.innerHTML = `Du har plassert <b>${filled}/4</b>. Fyll alle fire rutene.`;
    }
  });

  // Save/load outfit
  const LS_OUTFIT = "vetements_outfit_sprite_v1";
  $("saveOutfit").addEventListener("click", () => {
    localStorage.setItem(LS_OUTFIT, JSON.stringify({outfit, outfitColor}));
    const fb = $("outfitFeedback");
    fb.style.display = "block";
    fb.className = "msg good";
    fb.textContent = "‚úÖ Outfit lagret lokalt i nettleseren.";
  });

  $("loadOutfit").addEventListener("click", () => {
    const fb = $("outfitFeedback");
    fb.style.display = "block";
    try{
      const raw = localStorage.getItem(LS_OUTFIT);
      if(!raw) throw new Error("none");
      const obj = JSON.parse(raw);
      Object.assign(outfit, obj.outfit || {});
      Object.assign(outfitColor, obj.outfitColor || {});
      renderPlaced();
      fb.className = "msg good";
      fb.textContent = "‚úÖ Outfit lastet inn.";
    }catch(e){
      fb.className = "msg bad";
      fb.textContent = "Fant ingen lagret outfit enn√•.";
    }
  });

  $("resetOutfit").addEventListener("click", () => {
    if(!confirm("Nullstill outfit?")) return;
    outfit.head = outfit.top = outfit.bottom = outfit.feet = null;
    renderPlaced();
    $("outfitFeedback").style.display = "none";
  });

  // =========================================================
  // Sentence builder
  // =========================================================
  function initPersons(){
    const sel = $("person");
    sel.innerHTML = "";
    PERSONS.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  }

  function makeSentence(){
    const who = $("person").value;
    const slot = $("pickSlot").value;
    const id = outfit[slot];
    const out = $("sentenceOut");
    out.style.display = "block";
    out.className = "msg";

    if(!id){
      out.textContent = `Tips: Dra et plagg til ${slotLabel(slot)} f√∏rst.`;
      return;
    }

    const it = ITEMS.find(x => x.id === id);
    const col = outfitColor[slot] || selectedColor.fr;
    out.textContent = `${who} porte ${it.fr} ${col}.`;
  }

  $("makeSentence").addEventListener("click", makeSentence);

  $("copySentence").addEventListener("click", async () => {
    const out = $("sentenceOut");
    if(out.style.display === "none") return;
    try{
      await copyToClipboard(out.textContent);
      out.className = "msg good";
      out.textContent = "‚úÖ Setningen er kopiert!";
      setTimeout(()=>{ out.className="msg"; }, 700);
    }catch(e){
      alert("Klarte ikke √• kopiere. Marker teksten og kopier manuelt.");
    }
  });

  // =========================================================
  // Writing save/check
  // =========================================================
  const LS_TEXT = "vetements_text_sprite_v1";

  $("saveText").addEventListener("click", () => {
    localStorage.setItem(LS_TEXT, $("studentText").value);
    const fb = $("textFeedback");
    fb.style.display = "block";
    fb.className = "msg good";
    fb.textContent = "‚úÖ Tekst lagret lokalt.";
  });

  $("copyText").addEventListener("click", async () => {
    const txt = $("studentText").value.trim();
    if(!txt){ alert("Skriv litt tekst f√∏rst üôÇ"); return; }
    try{
      await copyToClipboard(txt);
      const fb = $("textFeedback");
      fb.style.display = "block";
      fb.className = "msg good";
      fb.textContent = "‚úÖ Teksten er kopiert.";
    }catch(e){
      alert("Klarte ikke √• kopiere. Marker teksten og kopier manuelt.");
    }
  });

  function countHits(text, arr){
    const t = text.toLowerCase();
    return arr.filter(x => t.includes(x.toLowerCase()));
  }

  $("checkTargets").addEventListener("click", () => {
    const txt = $("studentText").value;
    const fb = $("textFeedback");
    fb.style.display = "block";

    const frClothes = ITEMS.map(x=>x.fr);
    const frColors = COLORS.map(x=>x.fr);

    const usedClothes = countHits(txt, frClothes);
    const usedColors = countHits(txt, frColors);

    const okC = usedClothes.length >= 3;   // med bare 4 plagg i sprite n√•: sett 3 som m√•l
    const okCol = usedColors.length >= 2;  // og 2 farger
    if(okC && okCol){
      fb.className = "msg good";
      fb.innerHTML = `‚úÖ Bra! Du bruker <b>${usedClothes.length}</b> klesord og <b>${usedColors.length}</b> farger.<br>
        <b>Kl√¶r:</b> ${usedClothes.join(", ")}<br>
        <b>Farger:</b> ${usedColors.join(", ")}`;
    } else {
      fb.className = "msg bad";
      fb.innerHTML = `‚ùó M√•l (forel√∏pig): <b>3</b> klesord og <b>2</b> farger.<br>
        Du har: <b>${usedClothes.length}</b> klesord og <b>${usedColors.length}</b> farger.<br><br>
        <b>Kl√¶r brukt:</b> ${usedClothes.join(", ") || "ingen enn√•"}<br>
        <b>Farger brukt:</b> ${usedColors.join(", ") || "ingen enn√•"}`;
    }
  });

  function loadSaved(){
    const t = localStorage.getItem(LS_TEXT);
    if(t) $("studentText").value = t;
  }

  // =========================================================
  // INIT
  // =========================================================
  renderBase();
  renderColors();
  renderShop();
  renderPlaced();
  initPersons();
  loadSaved();

  // Quick warning if sprite path is not set:
  if(SPRITE_SRC.includes("SETT-INN-FILNAVN-HER")){
    const fb = $("dragFeedback");
    fb.style.display = "block";
    fb.className = "msg warn";
    fb.textContent = "Husk √• sette riktig filnavn i SPRITE_SRC √∏verst i koden.";
  }
</script>
</body>
</html>
