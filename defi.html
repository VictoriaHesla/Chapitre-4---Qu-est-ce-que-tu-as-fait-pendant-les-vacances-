<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salut 9 ¬∑ Kapittel 4 ¬∑ D√©fi final</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:#e9ecff;
      --muted:#b7c0ff;
      --accent:#8b7bff;
      --good:#47d18c;
      --bad:#ff5c7a;
      --line:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(139,123,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(71,209,140,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1080px;margin:0 auto;padding:18px 16px 60px}
    a{color:inherit;text-decoration:none}
    h1{margin:18px 0 8px; font-size:2rem}
    .subtitle{color:var(--muted); margin:0 0 16px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(18,26,51,.7);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 20;
    }
    .topbar .left, .topbar .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(15,22,48,.8);
      padding:6px 10px;
      border-radius:999px;
      font-weight:650;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn{
      cursor:pointer;
      border:none;
      background: linear-gradient(180deg, rgba(139,123,255,1), rgba(108,94,255,1));
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
    }
    .btn:active{transform: translateY(1px)}
    .grid{display:grid; gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(18,26,51,.95), rgba(15,22,48,.95));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:1.2rem}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .small{font-size:.92rem;color:var(--muted)}
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }
    select{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      cursor:pointer;
      font-weight:800;
    }

    /* BOARD (30 steps) */
    .board{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.04);
      padding:14px;
      overflow:hidden;
    }
    .track{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:10px;
    }
    .tile{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      min-height:78px;
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative;
    }
    .tile .n{font-weight:900}
    .tile .tag{font-size:.85rem;color:var(--muted)}
    .tile.check{background: rgba(71,209,140,.10)}
    .tile.boss{background: rgba(245,158,11,.12)}
    .slot{
      height:42px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sprite{
      width:42px;height:42px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      background: rgba(139,123,255,.22);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      transition: transform .18s ease;
    }

    /* QUIZ */
    .prompt{
      font-size:1.15rem;
      font-weight:900;
      margin:6px 0 10px;
    }
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .choice{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:800;
    }
    .choice:hover{background: rgba(255,255,255,.09)}
    .choice.correct{border-color: rgba(71,209,140,.85)}
    .choice.wrong{border-color: rgba(255,92,122,.85)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px; border:1px solid var(--line)}
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="left">
        <a class="pill" href="index.html">‚Üê Til meny</a>
        <span class="pill">Salut 9 ¬∑ Kapittel 4</span>
      </div>

      <div class="right">
        <span class="pill">‚≠ê XP: <span id="xp">0</span></span>
        <span class="pill">üèÖ Best: <span id="best">0</span>/30</span>
        <button class="btn secondary" id="musicBtn">üéµ Musikk: AV</button>
      </div>
    </div>

    <h1>üèÅ D√©fi final: Boss-run (30 oppgaver)</h1>
    <p class="subtitle">Svar riktig for √• flytte üßç fremover. 30 oppgaver p√• kryss og tvers av alle temaene.</p>

    <div class="grid">

      <section class="card">
        <h2>üéÆ Spillebrett</h2>
        <div class="row">
          <span class="pill">Oppgave: <strong id="round">0</strong>/30</span>
          <span class="pill">Riktige: <strong id="score">0</strong></span>

          <label class="pill" style="gap:10px">
            Boss-type:
            <select id="bossType">
              <option value="easy">üü¢ Lett</option>
              <option value="mid" selected>üü° Middels</option>
              <option value="hard">üî¥ Hard</option>
            </select>
          </label>

          <button class="btn" id="start">Start</button>
          <button class="btn secondary" id="reset">Nullstill</button>
          <button class="btn secondary" id="wipe">Slett XP/best</button>
        </div>

        <div class="board" style="margin-top:12px">
          <div class="track" id="track"></div>
        </div>

        <div class="feedback" id="boardMsg">
          Trykk <strong>Start</strong>. Riktig svar = +1 steg. (Du kan fortsatt fullf√∏re selv om du svarer feil.)
        </div>
      </section>

      <section class="card">
        <h2>üß† Oppgave</h2>
        <div class="prompt" id="prompt">‚Äî</div>
        <div class="small" id="topic">‚Äî</div>

        <div class="choices" id="choices" style="margin-top:12px"></div>

        <div class="feedback" id="result">Trykk Start for √• begynne.</div>

        <div class="small" style="margin-top:10px">
          Hvis musikk ikke starter: trykk <span class="kbd">üéµ Musikk</span> etter Start (iPad/Chrome krever brukerklikk).
        </div>
      </section>

      <section class="card">
        <h2>üèÜ M√•l</h2>
        <div class="feedback" id="reward">
          Lett/middels: m√•l <strong>22/30</strong>. Hard: m√•l <strong>26/30</strong>.
        </div>
      </section>

    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ------------------ STORAGE ------------------
  const LS = "chap4_defi_run_v4";
  const state = load() || { xp:0, best:0 };
  function load(){ try{ return JSON.parse(localStorage.getItem(LS)); }catch(e){ return null; } }
  function save(){ localStorage.setItem(LS, JSON.stringify(state)); }

  const xpEl = document.getElementById("xp");
  const bestEl = document.getElementById("best");
  function renderTop(){
    xpEl.textContent = state.xp || 0;
    bestEl.textContent = state.best || 0;
  }
  renderTop();

  // ------------------ MUSIC ------------------
  let audioCtx = null;
  let musicOn = false;
  let musicTimer = null;
  const musicBtn = document.getElementById("musicBtn");

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  function playBeep(freq, dur=0.12, type="square", gain=0.05){
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;

    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(gain, now + 0.01);
    g.gain.linearRampToValueAtTime(0.0001, now + dur);

    o.connect(g); g.connect(audioCtx.destination);
    o.start(now); o.stop(now + dur + 0.02);
  }
  // egen ‚Äúretro‚Äù-loop (ikke en kopi av kjent melodi)
  const melody = [523,659,784,659,587,659,698,659,523,587,659,587,494,587,659,587,523,494,440,494];
  let melodyIdx = 0;
  function startMusic(){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();
    stopMusic();
    melodyIdx = 0;
    musicTimer = setInterval(() => {
      const f = melody[melodyIdx % melody.length];
      playBeep(f, 0.10, "square", 0.032);
      melodyIdx++;
    }, 130);
  }
  function stopMusic(){
    if(musicTimer) clearInterval(musicTimer);
    musicTimer = null;
  }
  function sfxGood(){ ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); playBeep(880,0.08,"square",0.06); playBeep(1175,0.08,"square",0.05); }
  function sfxBad(){ ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); playBeep(220,0.14,"sawtooth",0.05); }

  musicBtn.addEventListener("click", () => {
    musicOn = !musicOn;
    musicBtn.textContent = musicOn ? "üéµ Musikk: P√Ö" : "üéµ Musikk: AV";
    if(musicOn) startMusic(); else stopMusic();
  });

  // ------------------ UI ------------------
  const trackEl = document.getElementById("track");
  const roundEl = document.getElementById("round");
  const scoreEl = document.getElementById("score");
  const boardMsg = document.getElementById("boardMsg");

  const promptEl = document.getElementById("prompt");
  const topicEl = document.getElementById("topic");
  const choicesEl = document.getElementById("choices");
  const resultEl = document.getElementById("result");
  const rewardEl = document.getElementById("reward");

  const startBtn = document.getElementById("start");
  const resetBtn = document.getElementById("reset");
  const wipeBtn = document.getElementById("wipe");
  const bossTypeEl = document.getElementById("bossType");

  // ------------------ QUESTIONS (30+) ------------------
  // Use {a: correctAnswerText} so correct isn‚Äôt tied to A/0 index.
  // Then we shuffle options every time.
  const BANK = [
    // M√âT√âO
    {diff:"easy", topic:"‚òÄÔ∏è M√©t√©o", q:"Hvilket passer best: ¬´___ beau.¬ª", a:"Il fait", opts:["Il fait","Il y a","Il est","Je fais"], explain:"V√¶r + adjektiv: Il fait + adjektiv."},
    {diff:"easy", topic:"‚òÄÔ∏è M√©t√©o", q:"Velg riktig: ¬´___ du vent.¬ª", a:"Il y a", opts:["Il fait","Il y a","Il est","Il suis"], explain:"Substantiv: Il y a + du/ de la/ des."},
    {diff:"easy", topic:"‚òÄÔ∏è M√©t√©o", q:"Hva betyr ¬´Il pleut.¬ª", a:"Det regner.", opts:["Det regner.","Det sn√∏r.","Det er sol.","Det bl√•ser."], explain:"Il pleut = Det regner."},
    {diff:"mid",  topic:"‚òÄÔ∏è M√©t√©o", q:"Hva betyr ¬´Il y a du soleil.¬ª", a:"Det er sol.", opts:["Det er sol.","Det er kaldt.","Det er t√•ke.","Det er storm."], explain:"Il y a du soleil = Det er sol."},
    {diff:"mid",  topic:"‚òÄÔ∏è M√©t√©o", q:"Velg riktig: ¬´Il fait ___¬ª (tr√®s chaud)", a:"chaud", opts:["chaud","chaude","chauds","chaudes"], explain:"Il fait chaud (fast uttrykk)."},
    {diff:"hard", topic:"‚òÄÔ∏è M√©t√©o", q:"Velg riktig: ¬´En hiver, il ___ souvent.¬ª", a:"neige", opts:["neige","neiger","neiges","neig√©"], explain:"Il neige = det sn√∏r."},

    // PASS√â COMPOS√â
    {diff:"easy", topic:"‚è≥ Pass√© compos√©", q:"Velg riktig: ¬´J‚Äô___ mang√©.¬ª", a:"ai", opts:["ai","as","a","avons"], explain:"Je ‚Üí j‚Äôai"},
    {diff:"easy", topic:"‚è≥ Pass√© compos√©", q:"Velg riktig: ¬´Tu ___ jou√©.¬ª", a:"as", opts:["ai","as","a","ont"], explain:"Tu ‚Üí as"},
    {diff:"mid",  topic:"‚è≥ Pass√© compos√©", q:"Perfektum partisipp: ¬´visiter ‚Üí j‚Äôai ___ Paris.¬ª", a:"visit√©", opts:["visit√©","visiti","visiter","visit√©e"], explain:"-ER ‚Üí ofte -√©."},
    {diff:"mid",  topic:"‚è≥ Pass√© compos√©", q:"Velg riktig: ¬´Nous ___ fini.¬ª", a:"avons", opts:["avons","a","ont","ai"], explain:"Nous ‚Üí avons"},
    {diff:"hard", topic:"‚è≥ Pass√© compos√©", q:"Negasjon: ¬´J‚Äôai mang√©.¬ª ‚Üí", a:"Je n‚Äôai pas mang√©.", opts:["Je n‚Äôai pas mang√©.","Je ne pas ai mang√©.","Je n‚Äôai mang√© pas.","Je ne mang√© pas."], explain:"ne‚Ä¶pas rundt hjelpeverbet."},
    {diff:"hard", topic:"‚è≥ Pass√© compos√©", q:"Velg riktig: ¬´Ils ___ pris le bus.¬ª", a:"ont", opts:["ont","a","avons","ai"], explain:"Ils ‚Üí ont"},

    // N√âGATION
    {diff:"easy", topic:"üö´ N√©gation", q:"Gj√∏r negativ: ¬´Je regarde Netflix.¬ª", a:"Je ne regarde pas Netflix.", opts:["Je ne regarde pas Netflix.","Je regarde ne pas Netflix.","Je pas regarde Netflix.","Je ne pas regarde Netflix."], explain:"ne + verb + pas"},
    {diff:"easy", topic:"üö´ N√©gation", q:"Velg riktig: ¬´Je ___ mange pas.¬ª", a:"ne", opts:["ne","n‚Äô","pas","plus"], explain:"Je ne mange pas."},
    {diff:"mid",  topic:"üö´ N√©gation", q:"Velg riktig: ¬´Je ___ ai pas visit√© Paris.¬ª", a:"n‚Äô", opts:["ne","n‚Äô","pas","plus"], explain:"n‚Äô foran vokal: je n‚Äôai pas‚Ä¶"},
    {diff:"mid",  topic:"üö´ N√©gation", q:"Hvor st√•r ¬´pas¬ª?", a:"Etter verbet.", opts:["Etter verbet.","F√∏r subjektet.","Etter subjektet.","Helt til slutt uansett."], explain:"Je ne mange pas."},
    {diff:"hard", topic:"üö´ N√©gation", q:"Pass√© compos√©: Hvor st√•r ne‚Ä¶pas?", a:"Rundt hjelpeverbet (avoir/√™tre).", opts:["Rundt hjelpeverbet (avoir/√™tre).","Rundt partisippet.","Etter partisippet.","F√∏r subjektet."], explain:"Je n‚Äôai pas mang√©."},
    {diff:"hard", topic:"üö´ N√©gation", q:"Velg riktig: ¬´Nous ___ sommes pas all√©s.¬ª", a:"ne", opts:["ne","n‚Äô","pas","plus"], explain:"Nous ne sommes pas all√©s."},

    // V√äTEMENTS
    {diff:"easy", topic:"üëï V√™tements", q:"Hva betyr ¬´un pantalon¬ª?", a:"en bukse", opts:["en bukse","en kjole","en genser","en caps"], explain:"pantalon = bukse"},
    {diff:"easy", topic:"üëï V√™tements", q:"Hva betyr ¬´une robe¬ª?", a:"en kjole", opts:["en kjole","en jakke","et skjerf","sko"], explain:"robe = kjole"},
    {diff:"easy", topic:"üëï V√™tements", q:"Velg riktig farge: ¬´bleu¬ª", a:"bl√•", opts:["bl√•","gr√∏nn","gul","svart"], explain:"bleu = bl√•"},
    {diff:"mid",  topic:"üëï V√™tements", q:"Fullf√∏r: ¬´Je porte ___ T-shirt.¬ª", a:"un", opts:["un","une","des","de"], explain:"un T-shirt"},
    {diff:"mid",  topic:"üëï V√™tements", q:"Hva betyr ¬´des chaussures¬ª?", a:"sko", opts:["sko","sokker","hansker","belte"], explain:"chaussures = sko"},
    {diff:"hard", topic:"üëï V√™tements", q:"Velg riktig: ¬´une ___¬ª (skj√∏rt)", a:"jupe", opts:["jupe","pull","pantalon","manteau"], explain:"jupe = skj√∏rt"},

    // PAYSAGE
    {diff:"easy", topic:"üèûÔ∏è Paysage", q:"Hva betyr ¬´la plage¬ª?", a:"stranden", opts:["stranden","skogen","byen","dalen"], explain:"plage = strand"},
    {diff:"easy", topic:"üèûÔ∏è Paysage", q:"Velg riktig: ¬´la for√™t¬ª", a:"skogen", opts:["skogen","fjell","√∏rkenen","√∏ya"], explain:"for√™t = skog"},
    {diff:"easy", topic:"üèûÔ∏è Paysage", q:"Hva betyr ¬´la mer¬ª?", a:"havet", opts:["havet","innsj√∏en","elva","landet"], explain:"la mer = havet"},
    {diff:"mid",  topic:"üèûÔ∏è Paysage", q:"Hva betyr ¬´le d√©sert¬ª?", a:"√∏rkenen", opts:["√∏rkenen","√∏ya","dalen","byen"], explain:"d√©sert = √∏rken"},
    {diff:"mid",  topic:"üèûÔ∏è Paysage", q:"Velg riktig: ¬´la montagne¬ª", a:"fjellet", opts:["fjellet","stranden","byen","skogen"], explain:"montagne = fjell"},
    {diff:"hard", topic:"üèûÔ∏è Paysage", q:"Velg riktig: ¬´la vall√©e¬ª", a:"dalen", opts:["dalen","√∏ya","√∏rkenen","innsj√∏en"], explain:"vall√©e = dal"}
  ];

  // ------------------ BOSS TYPES ------------------
  const BOSS = {
    easy: { label:"üü¢ Lett", goal:22, mix:{easy:18, mid:12, hard:0}, xpPerCorrect:4 },
    mid:  { label:"üü° Middels", goal:22, mix:{easy:14, mid:12, hard:4}, xpPerCorrect:5 },
    hard: { label:"üî¥ Hard", goal:26, mix:{easy:10, mid:12, hard:8}, xpPerCorrect:6 }
  };

  // ------------------ GAME STATE ------------------
  let round = 0;        // 0..29
  let correctCount = 0; // score
  let pos = 0;          // 0..29
  let deck = [];
  let current = null;
  let locked = true;
  let bossMode = BOSS.mid;

  // sprite as DOM element moved into slot
  const sprite = document.createElement("div");
  sprite.className = "sprite";
  sprite.textContent = "üßç";

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function drawTrack(){
    trackEl.innerHTML = "";
    for(let i=0;i<30;i++){
      const t = document.createElement("div");
      t.className = "tile";
      if(i===9 || i===19) t.classList.add("check");
      if(i===29) t.classList.add("boss");
      const tag = (i===29) ? "BOSS" : ((i===9||i===19) ? "CHECK" : "");
      t.innerHTML = `
        <div class="n">${i+1}</div>
        <div class="tag">${tag}</div>
        <div class="slot"></div>
      `;
      trackEl.appendChild(t);
    }
    moveSpriteTo(0);
  }

  function moveSpriteTo(index){
    const tiles = [...trackEl.querySelectorAll(".tile")];
    const tile = tiles[Math.max(0, Math.min(index, tiles.length-1))];
    const slot = tile.querySelector(".slot");
    slot.appendChild(sprite);
    // lite ‚Äúnudge‚Äù for √• gi bevegelsesf√∏lelse
    sprite.style.transform = "scale(1.05)";
    setTimeout(()=> sprite.style.transform = "scale(1)", 140);
  }

  function renderStats(){
    roundEl.textContent = round;
    scoreEl.textContent = correctCount;
    renderTop();
  }

  function sample(list, n){
    const a = shuffle(list);
    return a.slice(0, Math.min(n, a.length));
  }

  function buildDeck(){
    // bygger n√∏yaktig 30 sp√∏rsm√•l etter boss-mix
    const easy = BANK.filter(x=>x.diff==="easy");
    const mid  = BANK.filter(x=>x.diff==="mid");
    const hard = BANK.filter(x=>x.diff==="hard");

    const need = bossMode.mix;
    let chosen = [
      ...sample(easy, need.easy),
      ...sample(mid, need.mid),
      ...sample(hard, need.hard),
    ];

    // hvis vi ikke har nok (pga f√• hard), fyll fra mid/easy uten duplikat
    while(chosen.length < 30){
      const pool = [...mid, ...easy, ...hard].filter(x=>!chosen.includes(x));
      if(pool.length === 0) break;
      chosen.push(pool[Math.floor(Math.random()*pool.length)]);
    }
    deck = shuffle(chosen).slice(0, 30);
  }

  function showQuestion(){
    current = deck[round];
    if(!current) return;

    promptEl.textContent = current.q;
    topicEl.textContent = `${current.topic} ¬∑ ${bossMode.label}`;

    // shuffle options each time and compute correctIndex by text match
    const opts = shuffle(current.opts);
    const correctIndex = opts.findIndex(x => x === current.a);

    choicesEl.innerHTML = "";
    resultEl.innerHTML = "Velg et svar.";

    opts.forEach((txt, i) => {
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = txt;
      b.addEventListener("click", () => answer(i, correctIndex, opts));
      choicesEl.appendChild(b);
    });
  }

  function answer(chosenIndex, correctIndex, opts){
    if(locked) return;
    locked = true;

    const isCorrect = chosenIndex === correctIndex;

    const all = [...choicesEl.querySelectorAll(".choice")];
    all.forEach((b, idx)=>{
      if(idx === correctIndex) b.classList.add("correct");
      if(idx === chosenIndex && !isCorrect) b.classList.add("wrong");
      b.disabled = true;
    });

    if(isCorrect){
      correctCount += 1;
      pos = Math.min(29, pos + 1);
      moveSpriteTo(pos);
      sfxGood();
      resultEl.innerHTML = `‚úÖ Riktig! <span class="small">(${current.explain})</span>`;
    }else{
      sfxBad();
      resultEl.innerHTML = `‚ùå Feil. Riktig er: <strong>${opts[correctIndex]}</strong><br><span class="small">${current.explain}</span>`;
    }

    renderStats();

    setTimeout(() => {
      round += 1;
      if(round >= 30){
        endGame();
        return;
      }
      locked = false;
      showQuestion();

      if(round === 10 || round === 20){
        boardMsg.innerHTML = `‚úÖ Checkpoint! Du er p√• <strong>${round}/30</strong>.`;
      }else if(round === 29){
        boardMsg.innerHTML = `üëæ Boss-sp√∏rsm√•l! Oppgave <strong>30/30</strong>.`;
      }else{
        boardMsg.innerHTML = `Fortsett! Du er p√• <strong>${round}/30</strong>. M√•l: <strong>${bossMode.goal}/30</strong>.`;
      }
    }, 850);
  }

  function endGame(){
    locked = true;

    state.best = Math.max(state.best || 0, correctCount);
    state.xp = (state.xp || 0) + (correctCount * bossMode.xpPerCorrect);
    save();
    renderTop();

    const win = correctCount >= bossMode.goal;
    if(win){
      rewardEl.innerHTML = `üéâ <strong>Du vant (${bossMode.label})!</strong> Kodeord: <span class="kbd">BRAVO-9</span><br><span class="small">Vis kodeordet til l√¶reren.</span>`;
      boardMsg.innerHTML = `üèÜ Du klarte <strong>${correctCount}/30</strong> (m√•l ${bossMode.goal}).`;
      sfxGood();
    }else{
      rewardEl.innerHTML = `üîí Ikke helt enda. Du fikk <strong>${correctCount}/30</strong>. M√•l: <strong>${bossMode.goal}/30</strong>.`;
      boardMsg.innerHTML = `Pr√∏v igjen! Velg gjerne Lett f√∏rst, og jobb deg opp.`;
      sfxBad();
    }
  }

  function startGame(){
    ensureAudio(); // gj√∏r audio klar etter brukerklikk

    bossMode = BOSS[bossTypeEl.value] || BOSS.mid;
    rewardEl.innerHTML = `M√•l: <strong>${bossMode.goal}/30</strong> (${bossMode.label}).`;

    buildDeck();
    round = 0;
    correctCount = 0;
    pos = 0;
    moveSpriteTo(0);
    locked = false;

    boardMsg.innerHTML = `Runde startet (${bossMode.label}). Riktig svar flytter üßç fremover.`;
    renderStats();
    showQuestion();
  }

  function resetGame(){
    locked = true;
    promptEl.textContent = "‚Äî";
    topicEl.textContent = "‚Äî";
    choicesEl.innerHTML = "";
    resultEl.innerHTML = "Trykk Start for √• begynne.";
    boardMsg.innerHTML = `Trykk <strong>Start</strong>. Riktig svar = +1 steg.`;
    rewardEl.innerHTML = `Lett/middels: m√•l <strong>22/30</strong>. Hard: m√•l <strong>26/30</strong>.`;
    round = 0;
    correctCount = 0;
    pos = 0;
    moveSpriteTo(0);
    renderStats();
  }

  // buttons
  startBtn.addEventListener("click", startGame);
  resetBtn.addEventListener("click", resetGame);

  wipeBtn.addEventListener("click", () => {
    if(!confirm("Slette XP og best score?")) return;
    localStorage.removeItem(LS);
    state.xp = 0; state.best = 0;
    renderTop();
    resetGame();
  });

  // init
  drawTrack();
  resetGame();
});
</script>
</body>
</html>
