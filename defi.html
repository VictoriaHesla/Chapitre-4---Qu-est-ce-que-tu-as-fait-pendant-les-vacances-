<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salut 9 Â· Kapittel 4 Â· DÃ©fi final</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --text:#e9ecff;
      --muted:#b7c0ff;
      --accent:#8b7bff;
      --good:#47d18c;
      --bad:#ff5c7a;
      --line:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 0%, rgba(139,123,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(71,209,140,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1020px;margin:0 auto;padding:18px 16px 60px}
    a{color:inherit;text-decoration:none}
    h1{margin:18px 0 8px; font-size:2rem}
    .subtitle{color:var(--muted); margin:0 0 16px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(18,26,51,.7);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 20;
    }
    .topbar .left, .topbar .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(15,22,48,.8);
      padding:6px 10px;
      border-radius:999px;
      font-weight:650;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn{
      cursor:pointer;
      border:none;
      background: linear-gradient(180deg, rgba(139,123,255,1), rgba(108,94,255,1));
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
    }
    .btn:active{transform: translateY(1px)}
    .grid{display:grid; gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(18,26,51,.95), rgba(15,22,48,.95));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:1.2rem}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .small{font-size:.92rem;color:var(--muted)}
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }
    select{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      cursor:pointer;
      font-weight:800;
    }

    /* GAME BOARD */
    .boardWrap{padding:14px}
    .board{
      position:relative;
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.04);
      overflow:hidden;
      padding:14px;
    }
    .track{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:10px;
      align-items:stretch;
    }
    .tile{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      min-height:74px;
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .tile .n{font-weight:900}
    .tile .tag{font-size:.85rem;color:var(--muted)}
    .tile.goal{background: rgba(245,158,11,.12)}
    .tile.check{background: rgba(71,209,140,.10)}
    .sprite{
      position:absolute;
      width:42px;height:42px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      background: rgba(139,123,255,.22);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      transition: transform .35s ease;
      transform: translate(0,0);
      pointer-events:none;
    }
    .boss{
      position:absolute;
      right:10px; top:10px;
      font-size:28px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
    }

    /* QUIZ */
    .prompt{
      font-size:1.15rem;
      font-weight:900;
      margin:6px 0 10px;
    }
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .choice{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:800;
    }
    .choice:hover{background: rgba(255,255,255,.09)}
    .choice.correct{border-color: rgba(71,209,140,.85)}
    .choice.wrong{border-color: rgba(255,92,122,.85)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px; border:1px solid var(--line)}
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="left">
        <a class="pill" href="index.html">â† Til meny</a>
        <span class="pill">Salut 9 Â· Kapittel 4</span>
      </div>

      <div class="right">
        <span class="pill">â­ XP: <span id="xp">0</span></span>
        <span class="pill">ğŸ… Best: <span id="best">0</span>/10</span>
        <button class="btn secondary" id="musicBtn">ğŸµ Musikk: AV</button>
      </div>
    </div>

    <h1>ğŸ DÃ©fi final: â€œBoss runâ€</h1>
    <p class="subtitle">Velg boss-type (lett/middels/hard). Svar riktig for Ã¥ flytte ğŸ§ fremover. 10 oppgaver fra alle temaene.</p>

    <div class="grid">

      <section class="card boardWrap">
        <h2>ğŸ® Spillebrett</h2>
        <div class="row">
          <span class="pill">Runde: <strong id="round">0</strong>/10</span>
          <span class="pill">Poeng: <strong id="score">0</strong></span>

          <label class="pill" style="gap:10px">
            Boss-type:
            <select id="bossType">
              <option value="easy">ğŸŸ¢ Lett</option>
              <option value="mid" selected>ğŸŸ¡ Middels</option>
              <option value="hard">ğŸ”´ Hard</option>
            </select>
          </label>

          <button class="btn" id="start">Start runde</button>
          <button class="btn secondary" id="reset">Nullstill</button>
          <button class="btn secondary" id="wipe">Slett XP/best</button>
        </div>

        <div class="board" id="board" style="margin-top:12px">
          <div class="boss" title="Boss">ğŸ‘¾</div>

          <div class="track" id="track"></div>

          <!-- FIGUR: den fÃ¸rste (ğŸ§) -->
          <div class="sprite" id="sprite" aria-label="figur">ğŸ§</div>
        </div>

        <div class="feedback" id="boardMsg">
          Trykk <strong>Start runde</strong>. Riktig svar = +1 felt.
        </div>
      </section>

      <section class="card">
        <h2>ğŸ§  Oppgave</h2>
        <div class="prompt" id="prompt">â€”</div>
        <div class="small" id="topic">â€”</div>

        <div class="choices" id="choices" style="margin-top:12px"></div>

        <div class="feedback" id="result">Trykk Start runde for Ã¥ begynne.</div>

        <div class="small" style="margin-top:10px">
          Tips: Musikk mÃ¥ ofte startes med et klikk (nettleserregel). Trykk <span class="kbd">ğŸµ Musikk</span> etter Start hvis nÃ¸dvendig.
        </div>
      </section>

      <section class="card">
        <h2>ğŸ† BelÃ¸nning</h2>
        <div class="feedback" id="reward">
          Lett/middels: mÃ¥l <strong>8/10</strong>. Hard: mÃ¥l <strong>9/10</strong>.
        </div>
      </section>

    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ------------------ STORAGE ------------------
  const LS = "chap4_defi_run_v3";
  const state = load() || { xp:0, best:0 };
  function load(){ try{ return JSON.parse(localStorage.getItem(LS)); }catch(e){ return null; } }
  function save(){ localStorage.setItem(LS, JSON.stringify(state)); }

  const xpEl = document.getElementById("xp");
  const bestEl = document.getElementById("best");
  function renderTop(){
    xpEl.textContent = state.xp || 0;
    bestEl.textContent = state.best || 0;
  }
  renderTop();

  // ------------------ GAME UI ------------------
  const trackEl = document.getElementById("track");
  const spriteEl = document.getElementById("sprite");
  const boardEl = document.getElementById("board");

  const roundEl = document.getElementById("round");
  const scoreEl = document.getElementById("score");
  const boardMsg = document.getElementById("boardMsg");

  const promptEl = document.getElementById("prompt");
  const topicEl = document.getElementById("topic");
  const choicesEl = document.getElementById("choices");
  const resultEl = document.getElementById("result");
  const rewardEl = document.getElementById("reward");

  const startBtn = document.getElementById("start");
  const resetBtn = document.getElementById("reset");
  const wipeBtn = document.getElementById("wipe");
  const bossTypeEl = document.getElementById("bossType");

  // ------------------ MUSIC (WebAudio â€œretro vibeâ€) ------------------
  let audioCtx = null;
  let musicOn = false;
  let musicTimer = null;

  const musicBtn = document.getElementById("musicBtn");

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  function playBeep(freq, dur=0.12, type="square", gain=0.05){
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;

    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(gain, now + 0.01);
    g.gain.linearRampToValueAtTime(0.0001, now + dur);

    o.connect(g);
    g.connect(audioCtx.destination);
    o.start(now);
    o.stop(now + dur + 0.02);
  }

  // own tiny loop (not a copy of any known tune)
  const melody = [523,659,784,659,587,659,698,659,523,587,659,587,494,587,659,587,523,494,440,494];
  let melodyIdx = 0;

  function startMusic(){
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();
    stopMusic();
    melodyIdx = 0;
    musicTimer = setInterval(() => {
      const f = melody[melodyIdx % melody.length];
      playBeep(f, 0.10, "square", 0.035);
      melodyIdx++;
    }, 130);
  }
  function stopMusic(){
    if(musicTimer) clearInterval(musicTimer);
    musicTimer = null;
  }

  musicBtn.addEventListener("click", () => {
    musicOn = !musicOn;
    musicBtn.textContent = musicOn ? "ğŸµ Musikk: PÃ…" : "ğŸµ Musikk: AV";
    if(musicOn) startMusic(); else stopMusic();
  });

  function sfxGood(){ ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); playBeep(880,0.08,"square",0.06); playBeep(1175,0.08,"square",0.05); }
  function sfxBad(){ ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); playBeep(220,0.14,"sawtooth",0.05); }
  function sfxStep(){ ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); playBeep(440,0.05,"square",0.03); }

  // ------------------ QUESTION BANK ------------------
  // Each: {topic, q, options, answerIndex, explain, diff:"easy"|"mid"|"hard"}
  const Q = [];

  // MÃ‰TÃ‰O
  Q.push(
    {diff:"easy", topic:"â˜€ï¸ MÃ©tÃ©o", q:"Hvilket passer best: Â«___ beau.Â»", options:["Il fait","Il y a","Il"], answerIndex:0, explain:"VÃ¦r + adjektiv: Il fait + adjektiv."},
    {diff:"easy", topic:"â˜€ï¸ MÃ©tÃ©o", q:"Velg riktig: Â«___ du vent.Â»", options:["Il fait","Il y a","Il est"], answerIndex:1, explain:"Substantiv: Il y a + du/ de la/ des."},
    {diff:"mid",  topic:"â˜€ï¸ MÃ©tÃ©o", q:"Hva betyr Â«Il y a du soleil.Â»", options:["Det er sol.","Det er varmt.","Det regner."], answerIndex:0, explain:"Il y a du soleil = Det er sol."}
  );

  // PASSÃ‰ COMPOSÃ‰ (avoir)
  Q.push(
    {diff:"easy", topic:"â³ PassÃ© composÃ©", q:"Velg riktig: Â«Jâ€™___ mangÃ©.Â»", options:["ai","as","a"], answerIndex:0, explain:"Je â†’ jâ€™ai"},
    {diff:"mid",  topic:"â³ PassÃ© composÃ©", q:"Perfektum partisipp: Â«visiter â†’ jâ€™ai ___ Paris.Â»", options:["visitÃ©","visiti","visitÃ©e"], answerIndex:0, explain:"-ER â†’ ofte -Ã© (visitÃ©)."},
    {diff:"hard", topic:"â³ PassÃ© composÃ©", q:"Velg riktig: Â«Nous ___ fini.Â»", options:["avons","a","ont"], answerIndex:0, explain:"Nous â†’ avons."}
  );

  // NÃ‰GATION
  Q.push(
    {diff:"easy", topic:"ğŸš« NÃ©gation", q:"GjÃ¸r negativ: Â«Je regarde Netflix.Â»", options:["Je ne regarde pas Netflix.","Je regarde ne pas Netflix.","Je pas regarde Netflix."], answerIndex:0, explain:"ne + verb + pas"},
    {diff:"mid",  topic:"ğŸš« NÃ©gation", q:"Velg riktig: Â«Je ___ ai pas visitÃ© Paris.Â»", options:["ne","nâ€™","pas"], answerIndex:1, explain:"nâ€™ foran vokal: je nâ€™ai pas..."},
    {diff:"hard", topic:"ğŸš« NÃ©gation", q:"PassÃ© composÃ©: Hvor stÃ¥r neâ€¦pas?", options:["Rundt hjelpeverbet","Rundt partisippet","Uten verb"], answerIndex:0, explain:"Je nâ€™ai pas mangÃ©."}
  );

  // VÃŠTEMENTS
  Q.push(
    {diff:"easy", topic:"ğŸ‘• VÃªtements", q:"Hva betyr Â«un pantalonÂ»?", options:["en bukse","en kjole","en genser"], answerIndex:0, explain:"pantalon = bukse"},
    {diff:"easy", topic:"ğŸ‘• VÃªtements", q:"Velg riktig farge: Â«bleuÂ»", options:["blÃ¥","grÃ¸nn","gul"], answerIndex:0, explain:"bleu = blÃ¥"},
    {diff:"mid",  topic:"ğŸ‘• VÃªtements", q:"FullfÃ¸r: Â«Je porte ___ T-shirt.Â»", options:["un","une","des"], answerIndex:0, explain:"un T-shirt"}
  );

  // PAYSAGE
  Q.push(
    {diff:"easy", topic:"ğŸï¸ Paysage", q:"Hva betyr Â«la plageÂ»?", options:["stranden","skogen","byen"], answerIndex:0, explain:"plage = strand"},
    {diff:"easy", topic:"ğŸï¸ Paysage", q:"Velg riktig: Â«la forÃªtÂ»", options:["skogen","fjell","Ã¸rkenen"], answerIndex:0, explain:"forÃªt = skog"},
    {diff:"mid",  topic:"ğŸï¸ Paysage", q:"Hva betyr Â«le dÃ©sertÂ»?", options:["Ã¸rkenen","Ã¸ya","dalen"], answerIndex:0, explain:"dÃ©sert = Ã¸rken"}
  );

  // ------------------ BOSS TYPES ------------------
  const BOSS = {
    easy: { label:"ğŸŸ¢ Lett", goal:8, mix:{easy:7, mid:3, hard:0}, xpPerCorrect:6 },
    mid:  { label:"ğŸŸ¡ Middels", goal:8, mix:{easy:5, mid:4, hard:1}, xpPerCorrect:7 },
    hard: { label:"ğŸ”´ Hard", goal:9, mix:{easy:3, mid:4, hard:3}, xpPerCorrect:8 }
  };

  // ------------------ ROUND STATE ------------------
  let round = 0;
  let score = 0;
  let pos = 0;
  let deck = [];
  let current = null;
  let locked = true;
  let bossMode = BOSS.mid;

  function drawTrack(){
    trackEl.innerHTML = "";
    for(let i=0;i<10;i++){
      const t = document.createElement("div");
      t.className = "tile";
      if(i===4 || i===7) t.classList.add("check");
      if(i===9) t.classList.add("goal");
      t.innerHTML = `
        <div class="n">${i+1}</div>
        <div class="tag">${i===9 ? "BOSS" : (i===4||i===7 ? "CHECK" : "")}</div>
      `;
      trackEl.appendChild(t);
    }
    positionSprite(0, true);
  }

  function positionSprite(idx, instant=false){
    const tiles = [...trackEl.children];
    const tile = tiles[Math.min(Math.max(idx,0), tiles.length-1)];
    if(!tile) return;

    const b = boardEl.getBoundingClientRect();
    const r = tile.getBoundingClientRect();

    const x = (r.left - b.left) + (r.width/2) - 21;
    const y = (r.top - b.top) + 10;

    if(instant) spriteEl.style.transition = "none";
    spriteEl.style.transform = `translate(${x}px, ${y}px)`;
    if(instant) setTimeout(()=> spriteEl.style.transition = "transform .35s ease", 10);
  }

  function renderStats(){
    roundEl.textContent = round;
    scoreEl.textContent = score;
    renderTop();
  }

  function sample(list, n){
    const a = list.slice().sort(()=>Math.random()-0.5);
    return a.slice(0, Math.min(n, a.length));
  }

  function pickDeck(){
    // velg 10 spÃ¸rsmÃ¥l etter boss-mix
    const easy = Q.filter(x=>x.diff==="easy");
    const mid  = Q.filter(x=>x.diff==="mid");
    const hard = Q.filter(x=>x.diff==="hard");

    const need = bossMode.mix;
    let chosen = [
      ...sample(easy, need.easy),
      ...sample(mid, need.mid),
      ...sample(hard, need.hard),
    ];

    // hvis noe mangler (pga fÃ¥ hard-spÃ¸rsmÃ¥l), fyll fra mid/easy
    while(chosen.length < 10){
      const pool = [...mid, ...easy].filter(x=>!chosen.includes(x));
      if(pool.length===0) break;
      chosen.push(pool[Math.floor(Math.random()*pool.length)]);
    }

    // hvis for mange, kutt
    chosen = chosen.slice(0, 10);

    // shuffle og sÃ¸rg for variasjon
    deck = chosen.sort(()=>Math.random()-0.5);
  }

  function showQuestion(){
    current = deck[round];
    if(!current) return;

    promptEl.textContent = current.q;
    topicEl.textContent = `${current.topic} Â· ${bossMode.label}`;

    choicesEl.innerHTML = "";
    resultEl.innerHTML = "Velg et svar.";

    current.options.forEach((txt, i) => {
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = txt;
      b.addEventListener("click", () => answer(i));
      choicesEl.appendChild(b);
    });
  }

  function endRound(){
    locked = true;

    state.best = Math.max(state.best || 0, score);
    state.xp = (state.xp || 0) + score * bossMode.xpPerCorrect;
    save();
    renderTop();

    const win = score >= bossMode.goal;
    if(win){
      rewardEl.innerHTML = `ğŸ‰ <strong>Du vant (${bossMode.label})!</strong> Kodeord: <span class="kbd">BRAVO-9</span>`;
      boardMsg.innerHTML = `ğŸ† Boss beseiret! Du klarte <strong>${score}/10</strong>.`;
      sfxGood();
    }else{
      rewardEl.innerHTML = `ğŸ”’ Ikke helt enda. Du fikk <strong>${score}/10</strong>. MÃ¥l: <strong>${bossMode.goal}/10</strong>.`;
      boardMsg.innerHTML = `ğŸ‘¾ Bossen vantâ€¦ Du fikk <strong>${score}/10</strong>. Trykk Start runde og prÃ¸v igjen!`;
      sfxBad();
    }
  }

  function answer(i){
    if(locked) return;
    locked = true;

    const correct = (i === current.answerIndex);

    const all = [...choicesEl.querySelectorAll(".choice")];
    all.forEach((b, idx)=>{
      if(idx === current.answerIndex) b.classList.add("correct");
      if(idx === i && !correct) b.classList.add("wrong");
      b.disabled = true;
    });

    if(correct){
      score += 1;
      pos = Math.min(9, pos + 1);
      sfxGood(); sfxStep();
      positionSprite(pos);
      resultEl.innerHTML = `âœ… Riktig! <span class="small">(${current.explain})</span>`;
    }else{
      sfxBad();
      resultEl.innerHTML = `âŒ Feil. Riktig er: <strong>${current.options[current.answerIndex]}</strong><br><span class="small">${current.explain}</span>`;
    }

    renderStats();

    setTimeout(() => {
      round += 1;
      if(round >= 10){
        endRound();
        return;
      }
      locked = false;
      showQuestion();
      boardMsg.innerHTML = `Fortsett! Du er pÃ¥ <strong>${round}/10</strong>. MÃ¥l: <strong>${bossMode.goal}/10</strong>.`;
    }, 900);
  }

  function startGame(){
    ensureAudio(); // gjÃ¸r audio klar etter brukerklikk

    bossMode = BOSS[bossTypeEl.value] || BOSS.mid;

    pickDeck();
    round = 0;
    score = 0;
    pos = 0;
    locked = false;

    rewardEl.innerHTML = `MÃ¥l: <strong>${bossMode.goal}/10</strong> (${bossMode.label}).`;
    boardMsg.innerHTML = `Runde startet (${bossMode.label}). Riktig svar flytter figuren frem.`;
    renderStats();
    positionSprite(0, false);
    showQuestion();
    sfxStep();
  }

  function resetGame(){
    locked = true;
    promptEl.textContent = "â€”";
    topicEl.textContent = "â€”";
    choicesEl.innerHTML = "";
    resultEl.innerHTML = "Trykk Start runde for Ã¥ begynne.";
    boardMsg.innerHTML = `Trykk <strong>Start runde</strong>. Riktig svar = +1 felt.`;
    rewardEl.innerHTML = `Lett/middels: mÃ¥l <strong>8/10</strong>. Hard: mÃ¥l <strong>9/10</strong>.`;
    round = 0; score = 0; pos = 0;
    renderStats();
    positionSprite(0, false);
  }

  startBtn.addEventListener("click", startGame);
  resetBtn.addEventListener("click", resetGame);

  wipeBtn.addEventListener("click", () => {
    if(!confirm("Slette XP og best score?")) return;
    localStorage.removeItem(LS);
    state.xp = 0; state.best = 0;
    renderTop();
    resetGame();
  });

  // init
  drawTrack();
  resetGame();
  window.addEventListener("resize", () => positionSprite(pos, true));
});
</script>
</body>
</html>
