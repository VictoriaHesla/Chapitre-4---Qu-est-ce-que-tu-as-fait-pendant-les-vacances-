<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D√©fi final ‚Äì Salut 9 kap. 4</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --text:#eaf0ff;
      --muted:#b7c4ff;
      --accent:#7dd3fc;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --max: 980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
                  radial-gradient(1000px 700px at 80% 0%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    header{padding:28px 16px 14px;}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px 40px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .title{
      font-size: clamp(22px, 3.2vw, 34px);
      margin:10px 0 6px;
      letter-spacing:.2px;
    }
    .subtitle{color:var(--muted); margin:0 0 14px; max-width: 85ch;}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,51,.6);
      font-size: 13px;
      color: var(--muted);
    }
    .pill b{color:var(--text)}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 0;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .card .hd h2{margin:0; font-size:18px;}
    .card .bd{padding:14px 16px 16px;}

    .kicker{font-size:12px; text-transform:uppercase; letter-spacing:.12em; color: var(--muted);}
    .small{font-size:13px; color: var(--muted); margin-top:8px;}
    .divider{height:1px; background: var(--border); margin:12px 0;}

    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button.primary{
      background: rgba(125,211,252,.18);
      border-color: rgba(125,211,252,.35);
    }
    button.good{
      background: rgba(52,211,153,.16);
      border-color: rgba(52,211,153,.35);
    }
    button.warn{
      background: rgba(251,191,36,.15);
      border-color: rgba(251,191,36,.35);
    }
    button.bad{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.35);
    }

    .playbox{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(16,26,51,.35);
      padding:12px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .msg.good{border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.10)}
    .msg.bad{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10)}
    .msg.warn{border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.10)}

    .hud{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .statrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .stat{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,51,.6);
      color: var(--muted);
      font-size: 13px;
    }
    .stat b{color:var(--text)}
    .progress{
      width:100%;
      height:12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      overflow:hidden;
      margin-top:10px;
    }
    .bar{
      height:100%;
      width:0%;
      background: rgba(125,211,252,.35);
    }

    .choices{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;}
    .qtitle{font-weight:900; font-size:16px;}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,.05);
      color: var(--text);
    }

    .badgegrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 540px){ .badgegrid{grid-template-columns:1fr} }
    .badgecard{
      border:1px solid var(--border);
      background: rgba(16,26,51,.35);
      border-radius: 16px;
      padding:12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .emoji{font-size:22px; line-height:1;}
    .badgecard .name{font-weight:900}
    .lock{opacity:.55}

    .reward{
      position: relative;
      border:1px solid rgba(52,211,153,.35);
      background: rgba(52,211,153,.10);
      border-radius: 18px;
      padding:12px;
      overflow:hidden;
    }
    .sparkle{
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 20% 30%, rgba(125,211,252,.18), transparent 35%),
                  radial-gradient(circle at 80% 20%, rgba(52,211,153,.18), transparent 35%),
                  radial-gradient(circle at 50% 80%, rgba(251,191,36,.16), transparent 35%);
      filter: blur(2px);
      animation: floaty 4.8s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{transform: translateY(0px)}
      50%{transform: translateY(10px)}
    }

    footer{padding:18px 16px 28px; color: var(--muted); text-align:center}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a href="index.html">‚Üê Til meny</a>
        <span class="badge">Salut 9 ¬∑ Kapittel 4 ¬∑ D√©fi final</span>
      </div>

      <h1 class="title">üèÜ D√©fi final: Boss fight!</h1>
      <p class="subtitle">
        Siste utfordring: blandet quiz fra hele kapittelet (v√¶r, pass√© compos√©, landskap, kl√¶r og ne‚Ä¶pas).
        Klarer du <b>8/10</b> og l√•ser opp bel√∏nningen?
      </p>

      <div class="pillrow">
        <span class="pill"><b>M√•l</b> 8/10 riktige i finalen</span>
        <span class="pill"><b>Bel√∏nning</b> ‚ÄúChampion‚Äù-badge + kodeord</span>
        <span class="pill"><b>Lagring</b> XP og badges lagres lokalt</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: GAME -->
      <section class="card">
        <div class="hd">
          <div>
            <div class="kicker">Spill</div>
            <h2>Finale-quiz</h2>
          </div>
          <div class="statrow">
            <span class="stat">XP: <b id="xp">0</b></span>
            <span class="stat">Best: <b id="best">0</b>/10</span>
          </div>
        </div>

        <div class="bd">
          <div class="playbox">
            <div class="hud">
              <div class="statrow">
                <span class="stat">Runde: <b id="round">0</b>/10</span>
                <span class="stat">Poeng: <b id="score">0</b></span>
              </div>
              <div class="statrow">
                <button class="primary" id="start">Start runde</button>
                <button id="resetRound">Nullstill runde</button>
              </div>
            </div>

            <div class="progress" aria-label="progress">
              <div class="bar" id="bar"></div>
            </div>

            <div class="divider"></div>

            <div id="qa">
              <div class="qtitle" id="qtext">Trykk ‚ÄúStart runde‚Äù.</div>
              <div class="choices" id="choices"></div>
              <div id="feedback" class="msg" style="display:none;"></div>
            </div>

            <div id="endScreen" style="display:none;">
              <div class="msg" id="endMsg"></div>
              <div class="reward" id="rewardBox" style="display:none; margin-top:10px;">
                <div class="sparkle" aria-hidden="true"></div>
                <div style="position:relative;">
                  <div style="font-weight:900; font-size:16px;">üéâ Bel√∏nning l√•st opp!</div>
                  <div class="small" style="color:rgba(234,240,255,.9); margin-top:6px;">
                    Kodeordet er: <span class="kbd">BRAVO-9</span><br>
                    (Du kan bruke det som ‚Äúexit ticket‚Äù eller for √• f√• en liten bonus i timen.)
                  </div>
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                <button class="good" id="playAgain">Spill igjen</button>
                <button class="warn" id="clearAll">Slett XP/badges</button>
              </div>
            </div>

            <p class="small">
              Tips: Les hele setningen. Mange feil handler om <b>plassering</b> (ne‚Ä¶pas) eller <b>hjelpeverb</b> (pass√© compos√©).
            </p>
          </div>
        </div>
      </section>

      <!-- RIGHT: BADGES / PEDAGOGY -->
      <aside class="card">
        <div class="hd">
          <div>
            <div class="kicker">Progresjon</div>
            <h2>Badges</h2>
          </div>
          <button class="warn" id="toggleExplain">Vis/skjul l√¶rerblikk</button>
        </div>

        <div class="bd">
          <div class="small">
            Du kan samle badges. De lagres lokalt i nettleseren din.
          </div>

          <div class="badgegrid" id="badgeGrid"></div>

          <div class="divider"></div>

          <div id="teacherView" class="hint" style="display:none;">
            <b>Pedagogisk begrunnelse (kort):</b><br>
            ‚Ä¢ <b>Spillifisering</b>: m√•l (8/10), XP og badges gir mestring og motivasjon.<br>
            ‚Ä¢ <b>H√∏y repetisjon</b>: korte runder med umiddelbar feedback st√∏tter automatisering av form (ne‚Ä¶pas / PC).<br>
            ‚Ä¢ <b>Form + mening</b>: sp√∏rsm√•lene kombinerer grammatikk og ordforr√•d i kontekst (ferie-tema).<br>
            ‚Ä¢ <b>Differensiering</b>: samme runde for alle, men eleven kan spille flere ganger og forbedre ‚Äúbest score‚Äù.<br>
            ‚Ä¢ <b>Feedback</b>: riktig svar vises alltid ‚Äì eleven l√¶rer av feil uten √• ‚Äústoppes‚Äù.
          </div>

          <div class="divider"></div>

          <div class="playbox">
            <div class="kicker">Mini-m√•l</div>
            <div class="small">Ekstra: Klarer du √• f√• <b>10/10</b>? Da l√•ser du ‚ÄúLegend‚Äù-badge.</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    Laget for GitHub Pages ¬∑ Alt lagres lokalt (ingen innlogging)
  </footer>

<script>
  // ---------------- STORAGE ----------------
  const LS_XP = "defi_xp";
  const LS_BEST = "defi_best10";
  const LS_BADGES = "defi_badges"; // JSON array

  function loadNumber(key, fallback=0){
    const v = localStorage.getItem(key);
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }
  function saveNumber(key, value){
    localStorage.setItem(key, String(value));
  }
  function loadBadges(){
    try{
      const raw = localStorage.getItem(LS_BADGES);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveBadges(arr){
    localStorage.setItem(LS_BADGES, JSON.stringify(arr));
  }
  function hasBadge(id){
    return loadBadges().includes(id);
  }
  function awardBadge(id){
    const b = loadBadges();
    if(!b.includes(id)){
      b.push(id);
      saveBadges(b);
    }
  }

  // ---------------- QUESTION BANK ----------------
  // Blandet: m√©t√©o / pass√© compos√© / paysage / v√™tements / n√©gation
  // Format:
  // { cat:"...", q:"...", a:["...","...","..."], correct: index, explain:"..." }
  const Q = [
    // METEO
    {
      cat:"M√©t√©o",
      q:"Velg riktig: ¬´____ beau¬ª (det er fint v√¶r).",
      a:["Il y a", "Il fait", "Il"],
      correct: 1,
      explain:"V√¶r/temperatur: ¬´Il fait beau / froid / chaud¬ª."
    },
    {
      cat:"M√©t√©o",
      q:"Velg riktig: ¬´____ du vent¬ª (det bl√•ser).",
      a:["Il y a", "Il fait", "Il est"],
      correct: 0,
      explain:"¬´Il y a du vent / du soleil / des nuages¬ª."
    },
    {
      cat:"M√©t√©o",
      q:"Velg riktig: ¬´____ pleut¬ª (det regner).",
      a:["Il", "Il fait", "Il y a"],
      correct: 0,
      explain:"Med verb: ¬´Il pleut / Il neige¬ª."
    },

    // PASSE COMPOSE (avoir/√™tre)
    {
      cat:"Pass√© compos√©",
      q:"Velg riktig: ¬´J‚Äô____ visit√© Paris.¬ª",
      a:["ai", "as", "est"],
      correct: 0,
      explain:"Je + avoir: ¬´j‚Äôai visit√©¬ª."
    },
    {
      cat:"Pass√© compos√©",
      q:"Velg riktig: ¬´Tu ____ mang√© une glace.¬ª",
      a:["as", "ai", "a"],
      correct: 0,
      explain:"Tu + avoir: ¬´tu as mang√©¬ª."
    },
    {
      cat:"Pass√© compos√©",
      q:"Velg riktig: ¬´Elle ____ all√©e √† la plage.¬ª",
      a:["a", "est", "ai"],
      correct: 1,
      explain:"Aller bruker √™tre: ¬´elle est all√©e¬ª."
    },

    // NEGATION
    {
      cat:"N√©gation",
      q:"Hvilken setning er riktig?",
      a:[
        "Je ne regarde pas la t√©l√©.",
        "Je regarde ne pas la t√©l√©.",
        "Je ne pas regarde la t√©l√©."
      ],
      correct: 0,
      explain:"ne + verb + pas."
    },
    {
      cat:"N√©gation",
      q:"Gj√∏r korrekt i pass√© compos√©:",
      a:[
        "Je n‚Äôai pas visit√© Paris.",
        "Je ne ai pas visit√© Paris.",
        "Je n‚Äôai visit√© pas Paris."
      ],
      correct: 0,
      explain:"ne‚Ä¶pas rundt hjelpeverbet: n‚Äôai pas + partisipp."
    },

    // PAYSAGE (landskap)
    {
      cat:"Paysage",
      q:"Hva betyr ¬´la montagne¬ª?",
      a:["fjellet", "havet", "skogen"],
      correct: 0,
      explain:"la montagne = fjellet."
    },
    {
      cat:"Paysage",
      q:"Hva betyr ¬´la plage¬ª?",
      a:["stranda", "byen", "√∏rkenen"],
      correct: 0,
      explain:"la plage = stranda."
    },

    // VETEMENTS (kl√¶r/farger)
    {
      cat:"V√™tements",
      q:"Hva betyr ¬´un pantalon¬ª?",
      a:["bukse", "genser", "kjole"],
      correct: 0,
      explain:"un pantalon = bukse."
    },
    {
      cat:"V√™tements",
      q:"Velg riktig (farge etter plagg):",
      a:["un pantalon noir", "un noir pantalon", "noir un pantalon"],
      correct: 0,
      explain:"Forenklet regel: farge kommer etter plagget."
    }
  ];

  // ---------------- GAME STATE ----------------
  const $ = (id) => document.getElementById(id);
  const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  let round = [];
  let idx = 0;
  let score = 0;
  let locked = false;

  function setHUD(){
    $("round").textContent = String(idx);
    $("score").textContent = String(score);
    const pct = (idx / 10) * 100;
    $("bar").style.width = pct + "%";
  }

  function renderMeta(){
    const xp = loadNumber(LS_XP, 0);
    const best = loadNumber(LS_BEST, 0);
    $("xp").textContent = xp;
    $("best").textContent = best;
    renderBadges();
  }

  function startRound(){
    locked = false;
    round = shuffle([...Q]).slice(0, 10);
    idx = 0;
    score = 0;
    $("feedback").style.display = "none";
    $("endScreen").style.display = "none";
    $("qa").style.display = "block";
    nextQ();
  }

  function nextQ(){
    setHUD();

    if(idx >= 10){
      endRound();
      return;
    }

    const item = round[idx];
    $("qtext").innerHTML = `<span class="kbd">${item.cat}</span> ${item.q}`;

    const choices = $("choices");
    choices.innerHTML = "";
    item.a.forEach((opt, i) => {
      const b = document.createElement("button");
      b.textContent = opt;
      b.addEventListener("click", () => choose(i));
      choices.appendChild(b);
    });
  }

  function choose(choiceIndex){
    if(locked) return;
    locked = true;

    const item = round[idx];
    const ok = (choiceIndex === item.correct);
    if(ok) score += 1;

    const fb = $("feedback");
    fb.style.display = "block";
    fb.className = "msg " + (ok ? "good" : "bad");
    fb.innerHTML = ok
      ? `‚úÖ Riktig! <b>${item.a[item.correct]}</b><br><span class="small" style="color:rgba(234,240,255,.85)">${item.explain}</span>`
      : `‚ùå Riktig svar: <b>${item.a[item.correct]}</b><br><span class="small" style="color:rgba(234,240,255,.85)">${item.explain}</span>`;

    // highlight correct choice quickly (optional feel)
    setTimeout(() => {
      idx += 1;
      locked = false;
      $("feedback").style.display = "none";
      nextQ();
    }, 900);

    $("score").textContent = String(score);
  }

  function endRound(){
    $("qa").style.display = "none";
    $("endScreen").style.display = "block";

    // XP: 10 per riktig + bonus hvis 8+ / 10/10
    let xpGain = score * 10;
    if(score >= 8) xpGain += 30;
    if(score === 10) xpGain += 50;

    const currentXP = loadNumber(LS_XP, 0) + xpGain;
    saveNumber(LS_XP, currentXP);

    // best score
    const best = loadNumber(LS_BEST, 0);
    if(score > best) saveNumber(LS_BEST, score);

    // badges
    if(score >= 8) awardBadge("champion");
    if(score === 10) awardBadge("legend");
    if(score >= 6) awardBadge("finisher"); // lavere terskel, flere f√•r noe

    const end = $("endMsg");
    if(score >= 8){
      end.className = "msg good";
      end.innerHTML = `üéØ Du fikk <b>${score}/10</b>! Du klarte m√•let og fikk <b>${xpGain} XP</b>.`;
      $("rewardBox").style.display = "block";
    } else if(score >= 6){
      end.className = "msg warn";
      end.innerHTML = `Nesten! Du fikk <b>${score}/10</b>. Du f√•r <b>${xpGain} XP</b>. Pr√∏v igjen for √• n√• <b>8/10</b>.`;
      $("rewardBox").style.display = "none";
    } else {
      end.className = "msg bad";
      end.innerHTML = `Du fikk <b>${score}/10</b>. Du f√•r <b>${xpGain} XP</b>. Spill igjen ‚Äì du l√¶rer av hvert fors√∏k!`;
      $("rewardBox").style.display = "none";
    }

    // progress to 100%
    $("bar").style.width = "100%";

    renderMeta();
  }

  function resetRound(){
    round = [];
    idx = 0;
    score = 0;
    locked = false;
    $("qtext").textContent = "Trykk ‚ÄúStart runde‚Äù.";
    $("choices").innerHTML = "";
    $("feedback").style.display = "none";
    $("endScreen").style.display = "none";
    $("qa").style.display = "block";
    $("bar").style.width = "0%";
    setHUD();
  }

  // ---------------- BADGES UI ----------------
  const BADGE_DEFS = [
    { id:"finisher", emoji:"‚úÖ", name:"Finisher", desc:"Spill en runde og f√• 6/10+." },
    { id:"champion", emoji:"üèÜ", name:"Champion", desc:"N√• 8/10 og l√•s opp bel√∏nning." },
    { id:"legend",   emoji:"üåü", name:"Legend",   desc:"Perfekt runde: 10/10." }
  ];

  function renderBadges(){
    const grid = $("badgeGrid");
    grid.innerHTML = "";
    BADGE_DEFS.forEach(b => {
      const owned = hasBadge(b.id);
      const div = document.createElement("div");
      div.className = "badgecard" + (owned ? "" : " lock");
      div.innerHTML = `
        <div class="emoji">${b.emoji}</div>
        <div>
          <div class="name">${b.name} ${owned ? "" : "üîí"}</div>
          <div class="small" style="margin-top:4px;">${b.desc}</div>
        </div>
      `;
      grid.appendChild(div);
    });
  }

  // ---------------- TEACHER VIEW TOGGLE ----------------
  $("toggleExplain").addEventListener("click", () => {
    const box = $("teacherView");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  });

  // ---------------- BUTTONS ----------------
  $("start").addEventListener("click", startRound);
  $("resetRound").addEventListener("click", resetRound);
  $("playAgain").addEventListener("click", startRound);

  $("clearAll").addEventListener("click", () => {
    if(!confirm("Vil du slette XP, best score og badges?")) return;
    localStorage.removeItem(LS_XP);
    localStorage.removeItem(LS_BEST);
    localStorage.removeItem(LS_BADGES);
    renderMeta();
    resetRound();
  });

  // ---------------- INIT ----------------
  renderMeta();
  resetRound();
</script>
</body>
</html>
