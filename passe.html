<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salut 9 ¬∑ Kapittel 4 ¬∑ Pass√© compos√© (avoir)</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      Salut 9 <small>Kapittel 4</small>
    </div>
    <div class="pills">
      <span class="badge" id="xpBadge">‚≠ê XP: 0</span>
      <a class="btn" href="index.html">‚Üê Til meny</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1>‚è±Ô∏è Pass√© compos√© (avec <i>avoir</i>)</h1>
        <p>Terp hjelpeverbet <b>avoir</b> + perfektum partisipp (ER/IR/RE).</p>
      </div>
      <div style="min-width:260px; width:360px; max-width:100%;">
        <div class="small" style="display:flex; justify-content:space-between; margin-bottom:6px;">
          <span>Fremdrift</span><span id="progressText">0%</span>
        </div>
        <div class="progress"><div id="progressBar"></div></div>
        <div class="small" style="margin-top:6px;">Tips: Fullf√∏r oppgavene for √• l√•se opp üèÖ</div>
      </div>
    </section>

    <section class="card">
      <h2>üéØ M√•l</h2>
      <div class="grid">
        <div class="toast">
          <b>Jeg kan‚Ä¶</b>
          <ul class="small" style="margin:8px 0 0; padding-left:18px;">
            <li>velge riktig form av <b>avoir</b> i presens</li>
            <li>lage perfektum partisipp av <b>ER/IR/RE</b>-verb</li>
            <li>skrive setninger i <b>pass√© compos√©</b> med <b>avoir</b></li>
          </ul>
        </div>
        <div class="toast">
          <b>Bel√∏nning</b>
          <p class="small" style="margin:8px 0 0;">
            Du f√•r XP for riktige treff og fullf√∏rte deler.
            N√•r du n√•r 100 XP ‚Üí üèÖ ‚ÄúPass√© Pro‚Äù.
          </p>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="meteo.html">La m√©t√©o</a>
        <a class="btn" href="vetements.html">V√™tements</a>
        <a class="btn" href="negation.html">N√©gation</a>
        <a class="btn" href="defi.html">D√©fi</a>
      </div>
    </section>

    <!-- DEL 1: MODELL -->
    <section class="card" id="sectionModels">
      <h2>1) Modell (byggestein)</h2>
      <div class="grid">
        <div class="toast">
          <b>Struktur</b>
          <p class="small" style="margin:8px 0 0;">
            <b>Subjekt</b> + <b>avoir</b> (i presens) + <b>participe pass√©</b>.
          </p>
        </div>
        <div class="toast">
          <b>Huskeliste</b>
          <p class="small" style="margin:8px 0 0;">
            ER ‚Üí ofte slutter p√• <b>-√©</b><br>
            IR ‚Üí ofte slutter p√• <b>-i</b><br>
            RE ‚Üí ofte slutter p√• <b>-u</b>
          </p>
        </div>
      </div>
      <p class="small" style="margin-top:10px;">
        Merk: P√• denne siden trener vi <b>bare</b> pass√© compos√© med <b>avoir</b> (ikke √™tre).
      </p>
    </section>

    <!-- DEL 2: UTFYLLING -->
    <section class="card" id="sectionFill">
      <h2>2) Fyll inn (avoir + perfektum partisipp)</h2>
      <p class="small">
        Fyll inn riktig form av <b>avoir</b> og riktig <b>participe pass√©</b>.
        (Hint: infinitiv st√•r i parentes.)
      </p>

      <div id="fillRoot"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveFill" class="btn btn-success">Lagre lokalt</button>
        <button id="resetFill" class="btn btn-danger">Nullstill</button>
      </div>

      <p id="fillTotal" style="margin:10px 0 0; font-weight:800;"></p>
      <p id="fillSaved" class="small" style="margin:6px 0 0;"></p>
      <div class="toast" id="fillToast" style="display:none;"></div>
    </section>

    <!-- DEL 3: KONVERTER -->
    <section class="card" id="sectionConvert">
      <h2>3) Gj√∏r om (presens ‚Üí pass√© compos√© med avoir)</h2>
      <p class="small">
        Skriv hele setningen p√• nytt i <b>pass√© compos√©</b>. (Ikke kopier presens ‚Äì skriv den om.)
      </p>

      <div id="convertRoot"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveConvert" class="btn btn-success">Lagre lokalt</button>
        <button id="resetConvert" class="btn btn-danger">Nullstill</button>
      </div>

      <p id="convertTotal" style="margin:10px 0 0; font-weight:800;"></p>
      <p id="convertSaved" class="small" style="margin:6px 0 0;"></p>
      <div class="toast" id="convertToast" style="display:none;"></div>
    </section>

    <!-- DEL 4: OVERSSETTELSER -->
    <section class="card" id="sectionTranslate">
      <h2>4) Enkle oversettelser (til fransk i pass√© compos√©)</h2>
      <p class="small">
        Oversett til fransk. Bruk <b>pass√© compos√© med avoir</b>.
      </p>

      <div id="transRoot"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveTrans" class="btn btn-success">Lagre lokalt</button>
        <button id="resetTrans" class="btn btn-danger">Nullstill</button>
      </div>

      <p id="transTotal" style="margin:10px 0 0; font-weight:800;"></p>
      <p id="transSaved" class="small" style="margin:6px 0 0;"></p>
      <div class="toast" id="transToast" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>üèÅ Ferdig?</h2>
      <p class="small">N√•r du har gjort alt, g√• videre til neste modul.</p>
      <div class="nav">
        <a class="btn btn-primary" href="meteo.html">Tilbake: La m√©t√©o ‚Üí</a>
        <a class="btn" href="index.html">Til meny</a>
      </div>
    </section>
  </main>

  <canvas id="confetti" style="position:fixed; inset:0; pointer-events:none; z-index:999;"></canvas>

<script>
(() => {
  // -------------------------
  // GLOBAL: XP + Progress + Confetti
  // -------------------------
  const XP_KEY = "salut9_xp_v1";
  const DONE_KEY = "passe_avoir_done_v1";

  const xpBadge = document.getElementById("xpBadge");
  const progressText = document.getElementById("progressText");
  const progressBar = document.getElementById("progressBar");

  const confetti = document.getElementById("confetti");
  const ctx = confetti.getContext("2d");
  let confettiPieces = [];
  let confettiRAF = null;

  function resizeConfetti(){
    confetti.width = Math.floor(window.innerWidth * devicePixelRatio);
    confetti.height = Math.floor(window.innerHeight * devicePixelRatio);
  }
  window.addEventListener("resize", resizeConfetti);
  resizeConfetti();

  function getXP(){ return Number(localStorage.getItem(XP_KEY) || "0"); }
  function setXP(v){
    localStorage.setItem(XP_KEY, String(v));
    xpBadge.textContent = `‚≠ê XP: ${v}`;
    updateProgress();
  }

  function toast(el, msg){
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(() => { el.style.display = "none"; }, 1600);
  }

  function toastGlobal(msg){
    // vis en toast i den delen som finnes (fungerer fint p√• mobil)
    const el = document.getElementById("fillToast") || document.getElementById("convertToast") || document.getElementById("transToast");
    toast(el, msg);
  }

  function addXP(delta, reason){
    const before = getXP();
    const after = Math.max(0, before + delta);
    setXP(after);
    if (delta > 0) toastGlobal(`+${delta} XP ${reason ? "¬∑ " + reason : ""}`);
    if (before < 100 && after >= 100){
      toastGlobal("üèÖ L√•st opp: Pass√© Pro!");
      burstConfetti();
    }
  }

  function updateProgress(){
    const done = JSON.parse(localStorage.getItem(DONE_KEY) || "{}");
    const parts = [!!done.fill, !!done.convert, !!done.translate, true]; // + modell
    const pct = Math.round((parts.filter(Boolean).length / parts.length) * 100);
    progressText.textContent = `${pct}%`;
    progressBar.style.width = `${pct}%`;
  }

  function markDone(part){
    const done = JSON.parse(localStorage.getItem(DONE_KEY) || "{}");
    if (!done[part]){
      done[part] = true;
      localStorage.setItem(DONE_KEY, JSON.stringify(done));
      addXP(10, "Fullf√∏rt del");
      if (done.fill && done.convert && done.translate) burstConfetti();
    }
    updateProgress();
  }

  function burstConfetti(){
    const n = 120;
    confettiPieces = [];
    for (let i=0;i<n;i++){
      confettiPieces.push({
        x: (Math.random()*window.innerWidth) * devicePixelRatio,
        y: (-20 - Math.random()*200) * devicePixelRatio,
        vx: (Math.random()*2-1) * devicePixelRatio * 2.2,
        vy: (Math.random()*2+2) * devicePixelRatio * 2.6,
        r: (Math.random()*6+3) * devicePixelRatio,
        a: Math.random()*Math.PI*2,
        va: (Math.random()*0.2-0.1),
        life: 220 + Math.random()*120
      });
    }
    if (!confettiRAF) confettiRAF = requestAnimationFrame(drawConfetti);
  }

  function drawConfetti(){
    ctx.clearRect(0,0,confetti.width, confetti.height);
    ctx.save();
    ctx.globalAlpha = 0.9;

    for (const p of confettiPieces){
      p.x += p.vx;
      p.y += p.vy;
      p.a += p.va;
      p.vy += 0.01 * devicePixelRatio; // gravitasjon
      p.life -= 1;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = `hsl(${Math.floor((p.a*50)%360)}, 90%, 60%)`;
      ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
      ctx.restore();
    }

    ctx.restore();
    confettiPieces = confettiPieces.filter(p => p.life > 0 && p.y < confetti.height + 50*devicePixelRatio);

    if (confettiPieces.length){
      confettiRAF = requestAnimationFrame(drawConfetti);
    } else {
      cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      ctx.clearRect(0,0,confetti.width, confetti.height);
    }
  }

  // init badge/progress
  setXP(getXP());
  updateProgress();

  // -------------------------
  // HELPERS: normalisering og ‚Äúsnill‚Äù sjekk
  // -------------------------
  const norm = (s) => (s || "")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .replace(/[‚Äô']/g, "'")
    .trim();

  // Tillat sm√•variasjoner (f.eks. "j'ai" vs "jai" er ikke tillatt ‚Äî men ekstra mellomrom ok)
  const eq = (a,b) => norm(a) === norm(b);

  // -------------------------
  // DEL 2: Fill (avoir + participe pass√©)
  // -------------------------
  const FILL_KEY = "passe_avoir_fill_v1";
  const fillRoot = document.getElementById("fillRoot");
  const fillTotal = document.getElementById("fillTotal");
  const fillSaved = document.getElementById("fillSaved");

  const fillItems = [
    { left: "Hier, je", hint: "(manger)", right: "une pizza.", a:["ai"], pp:["mang√©"] },
    { left: "Nous", hint: "(finir)", right: "nos devoirs.", a:["avons"], pp:["fini"] },
    { left: "Tu", hint: "(vendre)", right: "ton v√©lo.", a:["as"], pp:["vendu"] },
    { left: "Ils", hint: "(choisir)", right: "un film.", a:["ont"], pp:["choisi"] },
    { left: "Elle", hint: "(attendre)", right: "le bus.", a:["a"], pp:["attendu"] },
    { left: "Vous", hint: "(r√©pondre)", right: "√† la question.", a:["avez"], pp:["r√©pondu"] },
    { left: "On", hint: "(regarder)", right: "la t√©l√©.", a:["a"], pp:["regard√©"] },
    { left: "J‚Äô", hint: "(r√©ussir)", right: "le test.", a:["ai"], pp:["r√©ussi"] },
  ];

  function renderFill(){
    const saved = JSON.parse(localStorage.getItem(FILL_KEY) || "{}");
    fillRoot.innerHTML = "";

    fillItems.forEach((it, i) => {
      const row = document.createElement("div");
      row.className = "row";
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 110px 140px 1fr";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.margin = "10px 0";

      const s1 = document.createElement("div");
      s1.innerHTML = `<span class="small">${it.left}</span>`;

      const inA = document.createElement("input");
      inA.className = "input";
      inA.placeholder = "avoir";
      inA.value = saved[`a_${i}`] || "";

      const inPP = document.createElement("input");
      inPP.className = "input";
      inPP.placeholder = "participe";
      inPP.value = saved[`pp_${i}`] || "";

      const s2 = document.createElement("div");
      s2.innerHTML = `<span class="small">${it.hint} ${it.right}</span>`;

      // feedback p√• blur
      function checkOne(){
        const okA = it.a.some(ans => eq(inA.value, ans));
        const okPP = it.pp.some(ans => eq(inPP.value, ans));
        inA.style.outline = okA ? "2px solid var(--success)" : (norm(inA.value) ? "2px solid var(--danger)" : "");
        inPP.style.outline = okPP ? "2px solid var(--success)" : (norm(inPP.value) ? "2px solid var(--danger)" : "");
        if (okA) addXP(1, "avoir");
        if (okPP) addXP(1, "participe");
        updateFillScore();
      }
      inA.addEventListener("blur", checkOne);
      inPP.addEventListener("blur", checkOne);

      row.appendChild(s1);
      row.appendChild(inA);
      row.appendChild(inPP);
      row.appendChild(s2);
      fillRoot.appendChild(row);
    });

    updateFillScore();
  }

  function updateFillScore(){
    const inputs = [...fillRoot.querySelectorAll("input")];
    let ok = 0;
    let total = fillItems.length * 2;

    fillItems.forEach((it, i) => {
      const inA = inputs[i*2];
      const inPP = inputs[i*2+1];
      if (it.a.some(ans => eq(inA.value, ans))) ok++;
      if (it.pp.some(ans => eq(inPP.value, ans))) ok++;
    });

    fillTotal.textContent = `Treff: ${ok} / ${total}`;
    if (ok === total) markDone("fill");
  }

  document.getElementById("saveFill").addEventListener("click", () => {
    const inputs = [...fillRoot.querySelectorAll("input")];
    const data = {};
    fillItems.forEach((_, i) => {
      data[`a_${i}`] = inputs[i*2].value;
      data[`pp_${i}`] = inputs[i*2+1].value;
    });
    localStorage.setItem(FILL_KEY, JSON.stringify(data));
    fillSaved.textContent = `Lagret: ${new Date().toLocaleString("no-NO")}`;
    toast(document.getElementById("fillToast"), "‚úÖ Lagret!");
  });

  document.getElementById("resetFill").addEventListener("click", () => {
    localStorage.removeItem(FILL_KEY);
    renderFill();
    fillSaved.textContent = "";
    toast(document.getElementById("fillToast"), "üßπ Nullstilt!");
  });

  // -------------------------
  // DEL 3: Convert (presens -> pass√© compos√©)
  // -------------------------
  const CONVERT_KEY = "passe_avoir_convert_v1";
  const convertRoot = document.getElementById("convertRoot");
  const convertTotal = document.getElementById("convertTotal");
  const convertSaved = document.getElementById("convertSaved");

  const convertItems = [
    { present: "Je mange √† la cantine.", answers: ["j'ai mang√© √† la cantine."] },
    { present: "Nous finissons le travail.", answers: ["nous avons fini le travail."] },
    { present: "Tu r√©ponds √† la question.", answers: ["tu as r√©pondu √† la question."] },
    { present: "Ils regardent la t√©l√©.", answers: ["ils ont regard√© la t√©l√©."] },
    { present: "Elle choisit une robe.", answers: ["elle a choisi une robe."] },
    { present: "Vous vendez des livres.", answers: ["vous avez vendu des livres."] },
    { present: "On attend le bus.", answers: ["on a attendu le bus."] },
  ];

  function renderConvert(){
    const saved = JSON.parse(localStorage.getItem(CONVERT_KEY) || "{}");
    convertRoot.innerHTML = "";

    convertItems.forEach((it, i) => {
      const wrap = document.createElement("div");
      wrap.className = "toast";
      wrap.style.margin = "10px 0";

      const p = document.createElement("div");
      p.innerHTML = `<b>${i+1}.</b> <span class="small">${it.present}</span>`;

      const input = document.createElement("input");
      input.className = "input";
      input.placeholder = "Skriv setningen i pass√© compos√©‚Ä¶";
      input.value = saved[`c_${i}`] || "";
      input.style.marginTop = "8px";

      input.addEventListener("blur", () => {
        const ok = it.answers.some(ans => eq(input.value, ans));
        input.style.outline = ok ? "2px solid var(--success)" : (norm(input.value) ? "2px solid var(--danger)" : "");
        if (ok) addXP(3, "konvertering");
        updateConvertScore();
      });

      wrap.appendChild(p);
      wrap.appendChild(input);
      convertRoot.appendChild(wrap);
    });

    updateConvertScore();
  }

  function updateConvertScore(){
    const inputs = [...convertRoot.querySelectorAll("input")];
    let ok = 0;
    convertItems.forEach((it, i) => {
      if (it.answers.some(ans => eq(inputs[i].value, ans))) ok++;
    });
    convertTotal.textContent = `Treff: ${ok} / ${convertItems.length}`;
    if (ok === convertItems.length) markDone("convert");
  }

  document.getElementById("saveConvert").addEventListener("click", () => {
    const inputs = [...convertRoot.querySelectorAll("input")];
    const data = {};
    convertItems.forEach((_, i) => data[`c_${i}`] = inputs[i].value);
    localStorage.setItem(CONVERT_KEY, JSON.stringify(data));
    convertSaved.textContent = `Lagret: ${new Date().toLocaleString("no-NO")}`;
    toast(document.getElementById("convertToast"), "‚úÖ Lagret!");
  });

  document.getElementById("resetConvert").addEventListener("click", () => {
    localStorage.removeItem(CONVERT_KEY);
    renderConvert();
    convertSaved.textContent = "";
    toast(document.getElementById("convertToast"), "üßπ Nullstilt!");
  });

  // -------------------------
  // DEL 4: Translate (NO -> FR, pass√© compos√© avec avoir)
  // -------------------------
  const TRANS_KEY = "passe_avoir_trans_v1";
  const transRoot = document.getElementById("transRoot");
  const transTotal = document.getElementById("transTotal");
  const transSaved = document.getElementById("transSaved");

  const transItems = [
    { no: "Jeg spiste frokost.", answers: ["j'ai mang√© le petit d√©jeuner.", "j'ai mang√© le petit-d√©jeuner."] },
    { no: "Vi solgte huset.", answers: ["nous avons vendu la maison."] },
    { no: "Hun valgte en bok.", answers: ["elle a choisi un livre."] },
    { no: "De ventet p√• l√¶reren.", answers: ["ils ont attendu le professeur.", "ils ont attendu la professeure."] },
    { no: "Du fullf√∏rte oppgaven.", answers: ["tu as fini l'exercice.", "tu as fini le devoir.", "tu as fini le travail."] },
    { no: "Dere svarte p√• meldingen.", answers: ["vous avez r√©pondu au message."] },
  ];

  function renderTrans(){
    const saved = JSON.parse(localStorage.getItem(TRANS_KEY) || "{}");
    transRoot.innerHTML = "";

    transItems.forEach((it, i) => {
      const wrap = document.createElement("div");
      wrap.className = "toast";
      wrap.style.margin = "10px 0";

      const p = document.createElement("div");
      p.innerHTML = `<b>${i+1}.</b> <span class="small">${it.no}</span>`;

      const input = document.createElement("input");
      input.className = "input";
      input.placeholder = "Skriv p√• fransk i pass√© compos√©‚Ä¶";
      input.value = saved[`t_${i}`] || "";
      input.style.marginTop = "8px";

      input.addEventListener("blur", () => {
        const ok = it.answers.some(ans => eq(input.value, ans));
        input.style.outline = ok ? "2px solid var(--success)" : (norm(input.value) ? "2px solid var(--danger)" : "");
        if (ok) addXP(4, "oversettelse");
        updateTransScore();
      });

      wrap.appendChild(p);
      wrap.appendChild(input);
      transRoot.appendChild(wrap);
    });

    updateTransScore();
  }

  function updateTransScore(){
    const inputs = [...transRoot.querySelectorAll("input")];
    let ok = 0;
    transItems.forEach((it, i) => {
      if (it.answers.some(ans => eq(inputs[i].value, ans))) ok++;
    });
    transTotal.textContent = `Treff: ${ok} / ${transItems.length}`;
    if (ok === transItems.length) markDone("translate");
  }

  document.getElementById("saveTrans").addEventListener("click", () => {
    const inputs = [...transRoot.querySelectorAll("input")];
    const data = {};
    transItems.forEach((_, i) => data[`t_${i}`] = inputs[i].value);
    localStorage.setItem(TRANS_KEY, JSON.stringify(data));
    transSaved.textContent = `Lagret: ${new Date().toLocaleString("no-NO")}`;
    toast(document.getElementById("transToast"), "‚úÖ Lagret!");
  });

  document.getElementById("resetTrans").addEventListener("click", () => {
    localStorage.removeItem(TRANS_KEY);
    renderTrans();
    transSaved.textContent = "";
    toast(document.getElementById("transToast"), "üßπ Nullstilt!");
  });

  // -------------------------
  // START: render alt
  // -------------------------
  renderFill();
  renderConvert();
  renderTrans();

})();
</script>
</body>
</html>
