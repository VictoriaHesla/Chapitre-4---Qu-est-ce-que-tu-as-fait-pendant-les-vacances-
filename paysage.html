<script>
  // ------------------ PROGRESJON / XP ------------------
  const LS_KEY = "chap4_progress_v1";
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)) || { xp:0, done:{} }; }
    catch(e){ return { xp:0, done:{} }; }
  }
  function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
  let state = loadState();

  function addXP(amount){
    state.xp = Math.max(0, (state.xp||0) + amount);
    saveState(state);
    renderHeader();
  }
  function markDone(id){
    state.done = state.done || {};
    state.done[id] = true;
    saveState(state);
    renderHeader();
  }
  function calcProgress(ids){
    const done = state.done || {};
    const total = ids.length;
    const doneCount = ids.filter(id => done[id]).length;
    const pct = total ? Math.round((doneCount/total)*100) : 0;
    return { pct, doneCount, total };
  }

  const TASKS = ["pay_open","pay_vocab","pay_quiz","pay_builder","pay_write","pay_bonus"];

  const xpEl = document.getElementById("xp");
  const badgeEl = document.getElementById("badge");
  const pctEl = document.getElementById("pct");
  const fillEl = document.getElementById("fill");

  function renderHeader(){
    xpEl.textContent = state.xp || 0;

    const xp = state.xp || 0;
    if(xp >= 140) badgeEl.textContent = "ğŸ† Paysage LÃ©gende";
    else if(xp >= 95) badgeEl.textContent = "ğŸ¥‡ Paysage Ninja";
    else if(xp >= 55) badgeEl.textContent = "ğŸ¥ˆ Paysage Pro";
    else badgeEl.textContent = "ğŸ¥‰ Paysage Starter";

    const { pct } = calcProgress(TASKS);
    pctEl.textContent = pct + "%";
    fillEl.style.width = pct + "%";
  }

  function flash(el, html, kind){
    el.innerHTML = html;
    el.style.borderColor =
      kind === "good" ? "rgba(71,209,140,.7)" :
      kind === "bad"  ? "rgba(255,92,122,.7)" :
      "rgba(255,255,255,.18)";
  }

  // mark open
  setTimeout(()=>markDone("pay_open"), 600);
  renderHeader();

  // ------------------ ORDBANK ------------------
  const WORDS = [
    { fr:"la montagne", no:"fjellet", emoji:"â›°ï¸" },
    { fr:"la mer", no:"havet", emoji:"ğŸŒŠ" },
    { fr:"la plage", no:"stranden", emoji:"ğŸ–ï¸" },
    { fr:"la forÃªt", no:"skogen", emoji:"ğŸŒ²" },
    { fr:"le lac", no:"innsjÃ¸en", emoji:"ğŸï¸" },
    { fr:"la riviÃ¨re", no:"elva", emoji:"ğŸï¸" },
    { fr:"la campagne", no:"landskapet (bygda)", emoji:"ğŸŒ¾" },
    { fr:"la ville", no:"byen", emoji:"ğŸ™ï¸" },
    { fr:"le village", no:"landsbyen", emoji:"ğŸ˜ï¸" },
    { fr:"lâ€™Ã®le", no:"Ã¸ya", emoji:"ğŸï¸" },
    { fr:"le dÃ©sert", no:"Ã¸rkenen", emoji:"ğŸœï¸" },
    { fr:"la vallÃ©e", no:"dalen", emoji:"ğŸ”ï¸" }
  ];

  const wordGrid = document.getElementById("wordGrid");
  const toggleNoBtn = document.getElementById("toggleNo");
  const ttsBtn = document.getElementById("ttsToggle");
  const ttsStateEl = document.getElementById("ttsState");
  const vocabMsg = document.getElementById("vocabMsg");
  const claimVocabBtn = document.getElementById("claimVocab");

  let showNo = true;
  let ttsOn = false;

  function speakFR(text){
    if(!ttsOn) return;
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "fr-FR";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  function renderWords(){
    wordGrid.innerHTML = "";
    WORDS.forEach(w=>{
      const div = document.createElement("div");
      div.className = "wordCard";
      div.innerHTML = `
        <div class="wordMain">
          <div class="fr">${w.emoji} ${w.fr}</div>
          <div class="no" style="${showNo ? "" : "display:none"}">${w.no}</div>
          <div class="tiny">Klikk ğŸ”Š for fransk</div>
        </div>
        <button class="btn secondary" style="padding:8px 10px" aria-label="uttale">ğŸ”Š</button>
      `;
      div.querySelector("button").onclick = ()=>{
        speakFR(w.fr);
        flash(vocabMsg, `ğŸ”Š Uttale: <strong>${w.fr}</strong> <span class="sparkle">(+1 XP)</span>`, "good");
        addXP(1);
      };
      wordGrid.appendChild(div);
    });
  }
  renderWords();

  toggleNoBtn.onclick = ()=>{
    showNo = !showNo;
    renderWords();
    flash(vocabMsg, showNo ? "Norsk vises âœ…" : "Norsk skjult ğŸ™ˆ (bra Ã¸ving!)", "info");
  };

  ttsBtn.onclick = ()=>{
    ttsOn = !ttsOn;
    ttsStateEl.textContent = ttsOn ? "PÃ…" : "AV";
    flash(vocabMsg, ttsOn ? "Lesestemme er PÃ… ğŸ”Š" : "Lesestemme er AV", "info");
  };

  claimVocabBtn.onclick = ()=>{
    if(state.done && state.done["pay_vocab"]){
      flash(vocabMsg, "Allerede tatt! ğŸ‰", "good");
      return;
    }
    addXP(15);
    markDone("pay_vocab");
    flash(vocabMsg, `ğŸ‰ Super! Du har Ã¸vd pÃ¥ glosene <span class="sparkle">(+15 XP)</span>`, "good");
  };

  // ------------------ MINI-QUIZ ------------------
  const scoreEl = document.getElementById("score");
  const totalEl = document.getElementById("total");
  const modeBtn = document.getElementById("mode");
  const modeTxt = document.getElementById("modeTxt");
  const newQBtn = document.getElementById("newQ");
  const resetBtn = document.getElementById("reset");
  const checkBtn = document.getElementById("check");
  const qPromptEl = document.getElementById("qPrompt");
  const qChoicesEl = document.getElementById("qChoices");
  const qResultEl = document.getElementById("qResult");

  let modeFRtoNO = true; // true = FR->NO, false = NO->FR
  let current = null;
  let selected = null;
  let score = 0;

  totalEl.textContent = WORDS.length;

  function shuffle(arr){
    const a = arr.slice();
    for(let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function pickQuestion(){
    current = WORDS[Math.floor(Math.random() * WORDS.length)];
    selected = null;

    const prompt = modeFRtoNO ? current.fr : current.no;
    qPromptEl.textContent = prompt;

    // svaralternativer (1 riktig + 3 feil)
    const pool = WORDS.filter(w => w !== current);
    const wrong = shuffle(pool).slice(0, 3);

    const choices = shuffle([current, ...wrong]).map(w => {
      return modeFRtoNO ? w.no : w.fr;
    });

    qChoicesEl.innerHTML = "";
    choices.forEach(txt=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = txt;
      b.onclick = ()=>{
        selected = txt;
        [...qChoicesEl.querySelectorAll(".choice")].forEach(x=>x.style.outline="none");
        b.style.outline = "2px solid rgba(139,123,255,.9)";
        flash(qResultEl, `Valgt: <strong>${txt}</strong>`, "info");
      };
      qChoicesEl.appendChild(b);
    });

    flash(qResultEl, `Velg et svar og trykk <span class="kbd">Sjekk</span>.`, "info");
  }

  function correctAnswerText(){
    return modeFRtoNO ? current.no : current.fr;
  }

  function checkAnswer(){
    if(!current){ pickQuestion(); return; }
    if(!selected){
      flash(qResultEl, `Velg et svar fÃ¸rst ğŸ™‚`, "bad");
      return;
    }
    const ok = (selected === correctAnswerText());

    if(ok){
      score += 1;
      scoreEl.textContent = score;
      addXP(5);
      flash(qResultEl, `âœ… Riktig! <span class="sparkle">(+5 XP)</span>`, "good");

      // marker quiz ferdig nÃ¥r man har 5 riktige (enkel â€œcompletionâ€)
      if(score >= 5 && !(state.done && state.done["pay_quiz"])){
        markDone("pay_quiz");
        flash(qResultEl, `âœ… Riktig! Du har nÃ¥ <strong>5</strong> riktige og lÃ¥ser inn quiz-modulen ğŸ‰`, "good");
      }
    }else{
      addXP(1); // trÃ¸stepoeng
      flash(qResultEl,
        `âŒ Nesten! Riktig svar er: <strong>${correctAnswerText()}</strong> <span class="sparkle">(+1 XP for forsÃ¸k)</span>`,
        "bad"
      );
    }
  }

  modeBtn.onclick = ()=>{
    modeFRtoNO = !modeFRtoNO;
    modeTxt.textContent = modeFRtoNO ? "FR â†’ NO" : "NO â†’ FR";
    pickQuestion();
  };

  newQBtn.onclick = ()=>pickQuestion();

  resetBtn.onclick = ()=>{
    score = 0;
    scoreEl.textContent = score;
    pickQuestion();
    flash(qResultEl, "Nullstilt. KjÃ¸r pÃ¥! ğŸ’ª", "info");
  };

  checkBtn.onclick = ()=>checkAnswer();

  // start
  pickQuestion();

  // ------------------ SETNINGSBYGGER ------------------
  const A_place = document.getElementById("A_place");
  const B_verb  = document.getElementById("B_verb");
  const B_where = document.getElementById("B_where");
  const C_desc  = document.getElementById("C_desc");
  const D_op    = document.getElementById("D_op");
  const D_reason= document.getElementById("D_reason");

  const A_make  = document.getElementById("A_make");
  const B_make  = document.getElementById("B_make");
  const C_make  = document.getElementById("C_make");
  const D_make  = document.getElementById("D_make");

  const builtEl = document.getElementById("built");
  const addToTextBtn = document.getElementById("addToText");
  const copyBuiltBtn = document.getElementById("copyBuilt");
  const clearBuiltBtn = document.getElementById("clearBuilt");

  // steder fra glosene (med riktig preposisjon)
  const PLACES = [
    { label:"Ã  la montagne (pÃ¥ fjellet)", fr:"Ã  la montagne" },
    { label:"Ã  la mer (ved havet)", fr:"Ã  la mer" },
    { label:"Ã  la plage (pÃ¥ stranden)", fr:"Ã  la plage" },
    { label:"dans la forÃªt (i skogen)", fr:"dans la forÃªt" },
    { label:"au lac (ved innsjÃ¸en)", fr:"au lac" },
    { label:"Ã  la riviÃ¨re (ved elva)", fr:"Ã  la riviÃ¨re" },
    { label:"Ã  la campagne (pÃ¥ landet)", fr:"Ã  la campagne" },
    { label:"en ville (i byen)", fr:"en ville" },
    { label:"dans un village (i en landsby)", fr:"dans un village" },
    { label:"sur une Ã®le (pÃ¥ en Ã¸y)", fr:"sur une Ã®le" },
    { label:"dans le dÃ©sert (i Ã¸rkenen)", fr:"dans le dÃ©sert" },
    { label:"dans la vallÃ©e (i dalen)", fr:"dans la vallÃ©e" }
  ];

  const ACTIVITIES = [
    { label:"fait une randonnÃ©e (gÃ¥tt pÃ¥ tur)", fr:"fait une randonnÃ©e" },
    { label:"pris des photos (tatt bilder)", fr:"pris des photos" },
    { label:"fait du vÃ©lo (syklet)", fr:"fait du vÃ©lo" },
    { label:"nagÃ© (badet/svÃ¸mt)", fr:"nagÃ©" },
    { label:"campÃ© (campet)", fr:"campÃ©" },
    { label:"visitÃ© un musÃ©e (besÃ¸kt museum)", fr:"visitÃ© un musÃ©e" },
    { label:"mangÃ© au restaurant (spist pÃ¥ restaurant)", fr:"mangÃ© au restaurant" },
    { label:"jouÃ© au foot (spilt fotball)", fr:"jouÃ© au foot" }
  ];

  const WHERES = [
    { label:"Ã  la plage", fr:"Ã  la plage" },
    { label:"en ville", fr:"en ville" },
    { label:"Ã  la campagne", fr:"Ã  la campagne" },
    { label:"dans la forÃªt", fr:"dans la forÃªt" },
    { label:"au lac", fr:"au lac" },
    { label:"Ã  la montagne", fr:"Ã  la montagne" }
  ];

  const DESCS = [
    { label:"Il y avait du soleil. (Det var sol.)", fr:"Il y avait du soleil." },
    { label:"Il faisait chaud. (Det var varmt.)", fr:"Il faisait chaud." },
    { label:"Il faisait froid. (Det var kaldt.)", fr:"Il faisait froid." },
    { label:"Il y avait du vent. (Det var vind.)", fr:"Il y avait du vent." },
    { label:"Câ€™Ã©tait magnifique. (Det var nydelig.)", fr:"Câ€™Ã©tait magnifique." },
    { label:"Câ€™Ã©tait calme. (Det var rolig.)", fr:"Câ€™Ã©tait calme." }
  ];

  const OPS = [
    { label:"Jâ€™ai adorÃ©. (Jeg elsket det.)", fr:"Jâ€™ai adorÃ©." },
    { label:"Jâ€™ai aimÃ©. (Jeg likte det.)", fr:"Jâ€™ai aimÃ©." },
    { label:"Je nâ€™ai pas aimÃ©. (Jeg likte det ikke.)", fr:"Je nâ€™ai pas aimÃ©." },
    { label:"Câ€™Ã©tait super. (Det var kjempebra.)", fr:"Câ€™Ã©tait super." },
    { label:"Câ€™Ã©tait intÃ©ressant. (Det var interessant.)", fr:"Câ€™Ã©tait intÃ©ressant." }
  ];

  const REASONS = [
    { label:"parce que câ€™Ã©tait beau. (fordi det var fint.)", fr:"parce que câ€™Ã©tait beau." },
    { label:"parce quâ€™il faisait beau. (fordi det var fint vÃ¦r.)", fr:"parce quâ€™il faisait beau." },
    { label:"parce que câ€™Ã©tait calme. (fordi det var rolig.)", fr:"parce que câ€™Ã©tait calme." },
    { label:"parce que jâ€™Ã©tais avec ma famille. (fordi jeg var med familien.)", fr:"parce que jâ€™Ã©tais avec ma famille." },
    { label:"parce que jâ€™ai pris des photos. (fordi jeg tok bilder.)", fr:"parce que jâ€™ai pris des photos." }
  ];

  function fillSelect(sel, items){
    items.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.fr;
      opt.textContent = it.label;
      sel.appendChild(opt);
    });
  }

  fillSelect(A_place, PLACES);
  fillSelect(B_verb, ACTIVITIES);
  fillSelect(B_where, WHERES);
  fillSelect(C_desc, DESCS);
  fillSelect(D_op, OPS);
  fillSelect(D_reason, REASONS);

  function setBuilt(sentence){
    if(!sentence){
      builtEl.textContent = "Setningen din dukker opp her ğŸ™‚";
      return;
    }
    builtEl.innerHTML = `ğŸ§© <strong>${sentence}</strong>`;
    if(!(state.done && state.done["pay_builder"])){
      // marker â€œbuilderâ€ som ferdig nÃ¥r man faktisk lager en setning
      markDone("pay_builder");
    }
  }

  A_make.onclick = ()=>{
    const place = A_place.value;
    if(!place) return flash(builtEl, "Velg et sted fÃ¸rst ğŸ™‚", "bad");
    const s = `Je suis allÃ©(e) ${place}.`;
    setBuilt(s);
    addXP(2);
    flash(builtEl, `ğŸ§© <strong>${s}</strong> <span class="sparkle">(+2 XP)</span>`, "good");
  };

  B_make.onclick = ()=>{
    const v = B_verb.value;
    if(!v) return flash(builtEl, "Velg en aktivitet fÃ¸rst ğŸ™‚", "bad");
    const w = B_where.value;
    const s = w ? `Jâ€™ai ${v} ${w}.` : `Jâ€™ai ${v}.`;
    setBuilt(s);
    addXP(2);
    flash(builtEl, `ğŸ§© <strong>${s}</strong> <span class="sparkle">(+2 XP)</span>`, "good");
  };

  C_make.onclick = ()=>{
    const d = C_desc.value;
    if(!d) return flash(builtEl, "Velg en beskrivelse fÃ¸rst ğŸ™‚", "bad");
    setBuilt(d);
    addXP(2);
    flash(builtEl, `ğŸ§© <strong>${d}</strong> <span class="sparkle">(+2 XP)</span>`, "good");
  };

  D_make.onclick = ()=>{
    const op = D_op.value;
    if(!op) return flash(builtEl, "Velg en mening fÃ¸rst ğŸ™‚", "bad");
    const r = D_reason.value;
    const s = r ? `${op} ${r}` : op;
    setBuilt(s);
    addXP(2);
    flash(builtEl, `ğŸ§© <strong>${s}</strong> <span class="sparkle">(+2 XP)</span>`, "good");
  };

  function getBuiltSentence(){
    // builtEl inneholder ofte HTML â€“ hent ut bare tekst
    const txt = builtEl.textContent || "";
    // fjerner emoji/prefix hvis den finnes
    return txt.replace(/^ğŸ§©\s*/,"").trim();
  }

  addToTextBtn.onclick = ()=>{
    const s = getBuiltSentence();
    if(!s || s.includes("Setningen din dukker opp her")) {
      flash(builtEl, "Lag en setning fÃ¸rst ğŸ™‚", "bad");
      return;
    }
    const textArea = document.getElementById("text");
    const sep = textArea.value.trim().length ? "\n" : "";
    textArea.value += sep + s;
    addXP(2);
    flash(builtEl, `âœ… La til i teksten <span class="sparkle">(+2 XP)</span>`, "good");
  };

  copyBuiltBtn.onclick = async ()=>{
    const s = getBuiltSentence();
    if(!s || s.includes("Setningen din dukker opp her")) {
      flash(builtEl, "Ingenting Ã¥ kopiere ennÃ¥ ğŸ™‚", "bad");
      return;
    }
    try{
      await navigator.clipboard.writeText(s);
      flash(builtEl, `ğŸ“‹ Kopiert!`, "good");
    }catch(e){
      flash(builtEl, `Kunne ikke kopiere (nettleser-blokkering). Marker setningen og kopier manuelt.`, "bad");
    }
  };

  clearBuiltBtn.onclick = ()=>setBuilt("");

  // ------------------ PRODUKSJON ------------------
  const LS_TEXT = "chap4_paysage_text_v1";
  const textEl = document.getElementById("text");
  const prodMsg = document.getElementById("prodMsg");

  const saveLocalBtn = document.getElementById("saveLocal");
  const loadLocalBtn = document.getElementById("loadLocal");
  const clearTextBtn = document.getElementById("clearText");
  const copyTextBtn = document.getElementById("copyText");
  const checkVocabBtn = document.getElementById("checkVocab");
  const bonus20Btn = document.getElementById("bonus20");

  const levelSel = document.getElementById("level");
  const insertStartersBtn = document.getElementById("insertStarters");

  function countSentences(text){
    // enkel setnings-teller: ., !, ? eller linjeskift
    const parts = text
      .split(/[\.\!\?\n]+/g)
      .map(x=>x.trim())
      .filter(Boolean);
    return parts.length;
  }

  function normalize(str){
    return (str||"")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,""); // fjern aksenter
  }

  function findUsedVocab(text){
    const t = normalize(text);
    const hits = [];
    WORDS.forEach(w=>{
      const fr = normalize(w.fr);
      // sjekk om fr-ordet finnes i teksten
      if(t.includes(fr)) hits.push(w.fr);
    });
    return hits;
  }

  function insertStarters(level){
    const starters = {
      1: [
        "Je suis allÃ©(e) â€¦",
        "Jâ€™ai â€¦",
        "Il y avait â€¦",
        "Câ€™Ã©tait â€¦",
        "Jâ€™ai aimÃ© â€¦",
        "Parce que â€¦"
      ],
      2: [
        "Pendant les vacances, je suis allÃ©(e) â€¦",
        "Jâ€™ai fait â€¦",
        "Il faisait â€¦",
        "Jâ€™ai visitÃ© â€¦",
        "Jâ€™ai adorÃ© â€¦ parce que â€¦",
        "Ensuite, â€¦"
      ],
      3: [
        "Pendant les vacances, je suis allÃ©(e) â€¦ avec â€¦",
        "Nous avons passÃ© du temps â€¦",
        "Il y avait â€¦ et lâ€™ambiance Ã©tait â€¦",
        "Jâ€™ai fait â€¦ et jâ€™ai pris â€¦",
        "Ce que jâ€™ai prÃ©fÃ©rÃ©, câ€™Ã©tait â€¦",
        "Enfin, â€¦"
      ]
    };
    const list = starters[level] || starters[2];
    const block = list.map(s=>`â€¢ ${s}`).join("\n");
    return `ğŸ“Œ Setningsstartere:\n${block}\n\n`;
  }

  saveLocalBtn.onclick = ()=>{
    localStorage.setItem(LS_TEXT, textEl.value);
    flash(prodMsg, "ğŸ’¾ Lagret lokalt i nettleseren din âœ…", "good");
  };

  loadLocalBtn.onclick = ()=>{
    const saved = localStorage.getItem(LS_TEXT) || "";
    textEl.value = saved;
    flash(prodMsg, saved ? "ğŸ“¥ Hentet lagret tekst âœ…" : "Ingen lagret tekst funnet.", saved ? "good" : "bad");
  };

  clearTextBtn.onclick = ()=>{
    textEl.value = "";
    flash(prodMsg, "TÃ¸mt. Start pÃ¥ nytt âœï¸", "info");
  };

  insertStartersBtn.onclick = ()=>{
    const lvl = String(levelSel.value || "2");
    const prefix = insertStarters(lvl);
    textEl.value = prefix + (textEl.value || "");
    flash(prodMsg, "ğŸ“Œ La inn setningsstartere (du kan slette dem nÃ¥r du vil).", "good");
  };

  copyTextBtn.onclick = async ()=>{
    const t = textEl.value || "";
    if(!t.trim()){
      flash(prodMsg, "Ingenting Ã¥ kopiere ennÃ¥ ğŸ™‚", "bad");
      return;
    }
    try{
      await navigator.clipboard.writeText(t);
      flash(prodMsg, "ğŸ“‹ Teksten er kopiert!", "good");
    }catch(e){
      flash(prodMsg, "Kunne ikke kopiere (nettleser-blokkering). Marker teksten og kopier manuelt.", "bad");
    }
  };

  checkVocabBtn.onclick = ()=>{
    const t = textEl.value || "";
    const used = findUsedVocab(t);
    const needed = 5;
    if(used.length >= needed){
      addXP(10);
      markDone("pay_write");
      flash(prodMsg,
        `âœ… Du bruker <strong>${used.length}</strong> landskapsord: <span class="kbd">${used.join("</span> <span class='kbd'>")}</span> <span class="sparkle">(+10 XP)</span>`,
        "good"
      );
    }else{
      const missing = needed - used.length;
      flash(prodMsg,
        `â„¹ï¸ Du har <strong>${used.length}</strong> / ${needed} landskapsord. Mangler <strong>${missing}</strong>.<br>
         Tips: legg inn noen av disse: <span class="kbd">${WORDS.slice(0,6).map(w=>w.fr).join("</span> <span class='kbd'>")}</span>`,
        "bad"
      );
    }
  };

  bonus20Btn.onclick = ()=>{
    if(state.done && state.done["pay_bonus"]){
      flash(prodMsg, "Allerede tatt! ğŸ‰", "good");
      return;
    }
    const n = countSentences(textEl.value || "");
    if(n >= 10){
      addXP(20);
      markDone("pay_bonus");
      flash(prodMsg, `ğŸ… 10+ setninger registrert (${n}). <span class="sparkle">(+20 XP)</span>`, "good");
    }else{
      flash(prodMsg, `Du har ca. <strong>${n}</strong> setninger. Skriv litt mer (mÃ¥l: 10) ğŸ™‚`, "bad");
    }
  };

  // liten auto-progress: om de begynner Ã¥ skrive, gi et lite â€œkickâ€ Ã©n gang
  let wroteKickGiven = (state.done && state.done["_wroteKick"]);
  textEl.addEventListener("input", ()=>{
    if(wroteKickGiven) return;
    if((textEl.value||"").trim().length >= 60){
      wroteKickGiven = true;
      state.done = state.done || {};
      state.done["_wroteKick"] = true;
      saveState(state);
      addXP(5);
      flash(prodMsg, `ğŸ”¥ Du er i gang! <span class="sparkle">(+5 XP)</span>`, "good");
    }
  });

  // ------------------ KVALITET: tastatur ------------------
  // Enter i quiz: sjekk (hvis fokus ikke er i textarea)
  document.addEventListener("keydown", (e)=>{
    const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
    if(tag === "textarea") return;

    if(e.key === "Enter"){
      // hvis vi er i quiz-kortet-ish, sjekk
      checkAnswer();
    }
  });
</script>
