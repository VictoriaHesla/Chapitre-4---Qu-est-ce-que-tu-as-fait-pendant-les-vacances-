<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salut 9 Â· Kapittel 4 Â· La mÃ©tÃ©o</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      Salut 9 <small>Kapittel 4</small>
    </div>
    <div class="pills">
      <span class="badge" id="xpBadge">â­ XP: 0</span>
      <a class="btn" href="index.html">â† Til meny</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1>â˜ï¸ La mÃ©tÃ©o</h1>
        <p>Ã˜v vÃ¦ruttrykk, fÃ¥ tilbakemelding, og samle poeng.</p>
      </div>
      <div style="min-width:260px; width:360px; max-width:100%;">
        <div class="small" style="display:flex; justify-content:space-between; margin-bottom:6px;">
          <span>Fremdrift</span><span id="progressText">0%</span>
        </div>
        <div class="progress"><div id="progressBar"></div></div>
        <div class="small" style="margin-top:6px;">Tips: FullfÃ¸r oppgavene for Ã¥ lÃ¥se opp ğŸ…</div>
      </div>
    </section>

    <section class="card">
      <h2>ğŸ¯ MÃ¥l</h2>
      <div class="grid">
        <div class="toast">
          <b>Jeg kanâ€¦</b>
          <ul class="small" style="margin:8px 0 0; padding-left:18px;">
            <li>bruke <b>il fait</b> + adjektiv</li>
            <li>bruke <b>il y a</b> + substantiv</li>
            <li>skrive 4â€“8 setninger om vÃ¦ret</li>
          </ul>
        </div>
        <div class="toast">
          <b>BelÃ¸nning</b>
          <p class="small" style="margin:8px 0 0;">
            Du fÃ¥r XP for: riktige treff, fullfÃ¸rt drag&drop og ferdige setninger.
            NÃ¥r du nÃ¥r 100 XP â†’ ğŸ… â€œMÃ©tÃ©o Masterâ€.
          </p>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="passe.html">PassÃ© composÃ©</a>
        <a class="btn" href="vetements.html">VÃªtements</a>
        <a class="btn" href="negation.html">NÃ©gation</a>
        <a class="btn" href="defi.html">DÃ©fi</a>
      </div>
    </section>

    <!-- DEL 1: MINI-ORDLISTE / MODELLER -->
    <section class="card" id="sectionModels">
      <h2>1) Modeller (byggesteiner)</h2>
      <div class="grid">
        <div class="toast">
          <b>Il fait + adjektiv</b>
          <p class="small" style="margin:8px 0 0;">
            Il fait beau / chaud / froid / mauvais.
          </p>
        </div>
        <div class="toast">
          <b>Il y a + substantiv</b>
          <p class="small" style="margin:8px 0 0;">
            Il y a du soleil / du vent / du brouillard / des nuages.
          </p>
        </div>
      </div>
      <p class="small" style="margin-top:10px;">
        Tipp: Bruk <b>du</b> (masseord) og <b>des</b> (flertall).
      </p>
    </section>

    <!-- DEL 2: EMOJI MATCH DRAG&DROP -->
    <section class="card" id="sectionEmoji">
      <h2>2) Dra riktig uttrykk til riktig emoji</h2>
      <p class="small">Dra kortet til riktig emoji (touch + mus). Riktig gir XP.</p>

      <div id="emojiBoard" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></div>

      <hr>

      <div>
        <b>Uttrykk Ã¥ dra</b>
        <div id="chips" class="chips" style="margin-top:10px;"></div>
      </div>

      <div class="kudos" style="margin-top:12px;">
        <div><b id="emojiScore">Poeng: 0 / 8</b> <span class="small" id="emojiHint"></span></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-success" id="saveEmoji">Lagre</button>
          <button class="btn btn-danger" id="resetEmoji">Start pÃ¥ nytt</button>
        </div>
      </div>

      <div class="toast" id="emojiToast" style="display:none;"></div>
    </section>

    <!-- DEL 3: SETNINGER MED TILBAKEMELDING -->
    <section class="card" id="sectionSentences">
      <h2>3) Skriv setninger (med tilbakemelding)</h2>
      <p class="small">
        NÃ¥ stÃ¥r modellene pÃ¥ <b>norsk</b>. Du skriver setningen pÃ¥ <b>fransk</b> i feltet.
        Du fÃ¥r â€œrette ordâ€ mot fasit-setningen (stavemÃ¥te teller).
      </p>

      <div id="meteoWrite"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveMeteo" class="btn btn-success">Lagre lokalt</button>
        <button id="resetMeteo" class="btn btn-danger">Nullstill</button>
      </div>

      <p id="meteoTotal" style="margin:10px 0 0; font-weight:800;"></p>
      <p id="meteoSaved" class="small" style="margin:6px 0 0;"></p>

      <div class="toast" id="sentenceToast" style="display:none;"></div>
    </section>

    <!-- DEL 4: FRI SKRIVING MED SMART FEEDBACK -->
    <section class="card" id="sectionFree">
      <h2>4) Fri minioppgave (smart feedback)</h2>
      <p class="small">
        Skriv 4â€“8 setninger om vÃ¦ret i dag eller i helga. Du fÃ¥r hint om du bruker gode â€œmÃ¸nstreâ€.
      </p>

      <div class="grid">
        <div class="toast">
          <b>Setningsstartere</b>
          <ul class="small" style="margin:8px 0 0; padding-left:18px;">
            <li>Aujourdâ€™hui, â€¦</li>
            <li>Dans ma ville, â€¦</li>
            <li>Le matin, â€¦ et lâ€™aprÃ¨s-midi, â€¦</li>
            <li>Jâ€™aime / Je nâ€™aime pas parce que â€¦</li>
          </ul>
        </div>

        <div class="toast">
          <b>Bonus-ord</b>
          <p class="small" style="margin:8px 0 0;">
            orage, brouillard, tempÃ©rature, souvent, parfois, mais, parce que
          </p>
        </div>
      </div>

      <textarea id="freeText" rows="8" placeholder="Skriv herâ€¦"></textarea>

      <div class="kudos" style="margin-top:10px;">
        <div>
          <b id="freeScore">Feedback: 0 / 5</b>
          <div class="small" id="freeFeedback"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-success" id="saveFree">Lagre</button>
          <button class="btn btn-danger" id="resetFree">Nullstill</button>
        </div>
      </div>

      <div class="toast" id="freeToast" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>ğŸ Ferdig?</h2>
      <p class="small">NÃ¥r du har gjort alt, gÃ¥ videre til neste modul.</p>
      <div class="nav">
        <a class="btn btn-primary" href="passe.html">Neste: PassÃ© composÃ© â†’</a>
        <a class="btn" href="index.html">Til meny</a>
      </div>
    </section>
  </main>

  <!-- Confetti canvas -->
  <canvas id="confetti" style="position:fixed; inset:0; pointer-events:none; z-index:999;"></canvas>

<script>
(() => {
  // -------------------------
  // GLOBAL: XP + Progress + Confetti
  // -------------------------
  const XP_KEY = "salut9_xp_v1";
  const DONE_KEY = "meteo_done_v1";

  const xpBadge = document.getElementById("xpBadge");
  const progressText = document.getElementById("progressText");
  const progressBar = document.getElementById("progressBar");

  const confetti = document.getElementById("confetti");
  const ctx = confetti.getContext("2d");
  let confettiPieces = [];
  let confettiRAF = null;

  function resizeConfetti(){
    confetti.width = window.innerWidth * devicePixelRatio;
    confetti.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resizeConfetti);
  resizeConfetti();

  function getXP(){
    return Number(localStorage.getItem(XP_KEY) || "0");
  }
  function setXP(v){
    localStorage.setItem(XP_KEY, String(v));
    xpBadge.textContent = `â­ XP: ${v}`;
    updateProgress();
  }
  function addXP(delta, reason){
    const before = getXP();
    const after = Math.max(0, before + delta);
    setXP(after);
    if (delta > 0) toastGlobal(`+${delta} XP ${reason ? "Â· " + reason : ""}`);
    if (before < 100 && after >= 100) {
      toastGlobal("ğŸ… LÃ¥st opp: MÃ©tÃ©o Master!");
      burstConfetti();
    }
  }

  function toastGlobal(msg){
    const el = document.getElementById("emojiToast") || document.getElementById("sentenceToast") || document.getElementById("freeToast");
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(() => { el.style.display = "none"; }, 1600);
  }

  function updateProgress(){
    const done = JSON.parse(localStorage.getItem(DONE_KEY) || "{}");
    const parts = [!!done.emoji, !!done.sentences, !!done.free, true];
    const pct = Math.round((parts.filter(Boolean).length / parts.length) * 100);
    progressText.textContent = `${pct}%`;
    progressBar.style.width = `${pct}%`;
  }

  function markDone(part){
    const done = JSON.parse(localStorage.getItem(DONE_KEY) || "{}");
    if (!done[part]){
      done[part] = true;
      localStorage.setItem(DONE_KEY, JSON.stringify(done));
      addXP(10, "FullfÃ¸rt del");
      if (Object.keys(done).length >= 3) burstConfetti();
    }
    updateProgress();
  }

  function burstConfetti(){
    const n = 120;
    confettiPieces = [];
    for (let i=0;i<n;i++){
      confettiPieces.push({
        x: (Math.random()*window.innerWidth) * devicePixelRatio,
        y: (-20 - Math.random()*200) * devicePixelRatio,
        vx: (Math.random()*2-1) * devicePixelRatio * 2.2,
        vy: (Math.random()*2+2) * devicePixelRatio * 2.6,
        r: (Math.random()*6+3) * devicePixelRatio,
        a: Math.random()*Math.PI*2,
        va: (Math.random()*0.2-0.1),
        life: 220 + Math.random()*80
      });
    }
    if (confettiRAF) cancelAnimationFrame(confettiRAF);
    animateConfetti();
  }

  function animateConfetti(){
    ctx.clearRect(0,0,confetti.width, confetti.height);
    confettiPieces.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy *= 0.995;
      p.vx *= 0.995;
      p.a += p.va;
      p.life -= 1;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = `rgba(255,255,255,${0.55 + Math.random()*0.35})`;
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    });

    confettiPieces = confettiPieces.filter(p => p.life > 0 && p.y < confetti.height + 40);
    if (confettiPieces.length){
      confettiRAF = requestAnimationFrame(animateConfetti);
    } else {
      ctx.clearRect(0,0,confetti.width, confetti.height);
    }
  }

  setXP(getXP());
  updateProgress();

  // -------------------------
  // DEL 2: Emoji drag & drop (pointer events)
  // -------------------------
  const EMOJI_KEY = "meteo_emoji_match_v2";

  const tasks = [
    { id:"sun",    emoji:"â˜€ï¸", label:"sol",        answer:"Il y a du soleil." },
    { id:"cloud",  emoji:"â˜ï¸", label:"skyer",      answer:"Il y a des nuages." },
    { id:"wind",   emoji:"ğŸ’¨", label:"vind",       answer:"Il y a du vent." },
    { id:"rain",   emoji:"ğŸŒ§ï¸", label:"regn",       answer:"Il pleut." },
    { id:"snow",   emoji:"â„ï¸", label:"snÃ¸",        answer:"Il neige." },
    { id:"storm",  emoji:"â›ˆï¸", label:"torden",     answer:"Il y a de l'orage." },
    { id:"fog",    emoji:"ğŸŒ«ï¸", label:"tÃ¥ke",       answer:"Il y a du brouillard." },
    { id:"cold",   emoji:"ğŸ¥¶", label:"kaldt",      answer:"Il fait froid." }
  ];

  const board = document.getElementById("emojiBoard");
  const chips = document.getElementById("chips");
  const emojiScoreEl = document.getElementById("emojiScore");
  const emojiHint = document.getElementById("emojiHint");

  function shuffle(arr){
    const a = [...arr];
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function loadEmojiState(){
    try { return JSON.parse(localStorage.getItem(EMOJI_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveEmojiState(state){
    localStorage.setItem(EMOJI_KEY, JSON.stringify(state));
  }

  function makeDraggable(el){
    let startX=0, startY=0, origX=0, origY=0, dragging=false;

    el.style.touchAction = "none";

    el.addEventListener("pointerdown", (e) => {
      dragging = true;
      el.setPointerCapture(e.pointerId);
      const r = el.getBoundingClientRect();
      startX = e.clientX; startY = e.clientY;
      origX = r.left; origY = r.top;

      el.style.position = "fixed";
      el.style.left = r.left + "px";
      el.style.top = r.top + "px";
      el.style.width = r.width + "px";
      el.style.zIndex = 9999;
      el.style.cursor = "grabbing";
    });

    el.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      el.style.left = (origX + dx) + "px";
      el.style.top  = (origY + dy) + "px";
    });

    el.addEventListener("pointerup", (e) => {
      if (!dragging) return;
      dragging = false;

      const drop = document.elementFromPoint(e.clientX, e.clientY);
      const slot = drop?.closest?.("[data-slot]");
      if (slot){
        const slotId = slot.dataset.slot;
        const expected = tasks.find(t => t.id === slotId)?.answer;
        const myText = el.dataset.text;

        if (myText === expected){
          slot.querySelector(".slotText").textContent = myText;
          slot.dataset.filled = "true";
          slot.style.outline = "3px solid rgba(125,255,178,.9)";
          el.remove();
          const state = loadEmojiState();
          state[slotId] = myText;
          saveEmojiState(state);
          addXP(5, "Riktig match");
          updateEmojiScore();
        } else {
          slot.style.outline = "3px solid rgba(255,107,107,.95)";
          setTimeout(()=> slot.style.outline = "none", 420);
        }
      }

      if (document.body.contains(el)){
        el.style.position = "";
        el.style.left = "";
        el.style.top = "";
        el.style.width = "";
        el.style.zIndex = "";
        el.style.cursor = "grab";
      }
    });
  }

  function updateEmojiScore(){
    const state = loadEmojiState();
    const correct = tasks.filter(t => state[t.id] === t.answer).length;
    emojiScoreEl.textContent = `Poeng: ${correct} / ${tasks.length}`;
    emojiHint.textContent = correct === tasks.length ? "âœ… Ferdig!" : "â†’ Fortsett!";
    if (correct === tasks.length){
      markDone("emoji");
    }
  }

  function renderEmoji(){
    board.innerHTML = "";
    chips.innerHTML = "";

    const state = loadEmojiState();

    tasks.forEach(t => {
      const div = document.createElement("div");
      div.className = "slot";
      div.dataset.slot = t.id;
      div.dataset.filled = state[t.id] ? "true" : "false";
      div.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-size:34px;">${t.emoji}</div>
          <div style="opacity:.88;"><b>${t.label}</b></div>
        </div>
        <div class="slotDrop">
          <div class="slotText">${state[t.id] ? state[t.id] : "<span style='opacity:.55'>Slipp uttrykk herâ€¦</span>"}</div>
        </div>
      `;
      if (state[t.id] === t.answer){
        div.style.outline = "3px solid rgba(125,255,178,.9)";
      }
      board.appendChild(div);
    });

    const remaining = shuffle(tasks.map(t => t.answer))
      .filter(ans => !Object.values(state).includes(ans));

    remaining.forEach(text => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.dataset.text = text;
      chip.textContent = text;
      chips.appendChild(chip);
      makeDraggable(chip);
    });

    updateEmojiScore();
  }

  document.getElementById("saveEmoji").addEventListener("click", () => {
    addXP(2, "Lagret");
    toastGlobal("âœ… Lagret lokalt.");
  });

  document.getElementById("resetEmoji").addEventListener("click", () => {
    localStorage.removeItem(EMOJI_KEY);
    renderEmoji();
    toastGlobal("ğŸ—‘ï¸ Emoji-oppgave nullstilt.");
  });

  renderEmoji();

  // -------------------------
  // DEL 3: Modellsetninger med rette ord (NORSK MODELL, FRANSK FASIT)
  // -------------------------
  const SENT_KEY = "meteo_sentences_v2";

  const targets = [
    { no: "Det er pent vÃ¦r.",      fr: "Il fait beau." },
    { no: "Det er varmt.",         fr: "Il fait chaud." },
    { no: "Det er sol.",           fr: "Il y a du soleil." },
    { no: "Det er vind.",          fr: "Il y a du vent." },
    { no: "Det regner.",           fr: "Il pleut." }
  ];

  const writeRoot = document.getElementById("meteoWrite");
  const totalEl = document.getElementById("meteoTotal");
  const savedEl = document.getElementById("meteoSaved");
  const sentenceToast = document.getElementById("sentenceToast");

  function stripAccents(s){
    return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }
  function normalizeWords(s){
    return stripAccents(s.toLowerCase())
      .replace(/[â€™]/g, "'")
      .replace(/[^a-z'\s]/g, " ")
      .split(/\s+/)
      .filter(Boolean);
  }

  function scoreSentence(input, target){
    const a = normalizeWords(input);
    const b = normalizeWords(target);

    const counts = new Map();
    for (const w of b) counts.set(w, (counts.get(w) || 0) + 1);

    let correct = 0;
    for (const w of a){
      const c = counts.get(w) || 0;
      if (c > 0){
        correct++;
        counts.set(w, c - 1);
      }
    }
    return { correct, total: b.length };
  }

  function loadSent(){
    try { return JSON.parse(localStorage.getItem(SENT_KEY) || "[]"); }
    catch { return []; }
  }
  function saveSent(arr){
    localStorage.setItem(SENT_KEY, JSON.stringify(arr));
  }

  function updateTotal(){
    let c = 0, tot = 0;
    targets.forEach((t, i) => {
      const val = document.getElementById(`in-${i}`)?.value || "";
      const s = scoreSentence(val, t.fr);
      c += s.correct;
      tot += s.total;
    });
    totalEl.textContent = `Totalt: ${c} / ${tot} riktige ord`;
    return {c, tot};
  }

  function renderSentences(){
    writeRoot.innerHTML = "";
    const saved = loadSent();

    targets.forEach((t, i) => {
      const wrap = document.createElement("div");
      wrap.style.margin = "10px 0";
      wrap.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline;">
          <div>
            <b>Setning ${i+1}</b>
            <span class="small">(norsk: ${t.no})</span>
          </div>
          <div id="fb-${i}" style="font-weight:900;"></div>
        </div>
        <input id="in-${i}" class="input" type="text" placeholder="Skriv setningen pÃ¥ franskâ€¦" />
      `;
      writeRoot.appendChild(wrap);

      const input = wrap.querySelector(`#in-${i}`);
      const fb = wrap.querySelector(`#fb-${i}`);
      input.value = saved[i] || "";

      const update = () => {
        const {correct,total} = scoreSentence(input.value, t.fr);
        fb.textContent = `${correct} / ${total}`;
        fb.style.color = (correct === total) ? "rgba(125,255,178,.95)"
                     : (correct >= Math.ceil(total/2)) ? "rgba(255,209,102,.95)"
                     : "rgba(255,107,107,.95)";

        const totals = updateTotal();

        const markerKey = `meteo_model_done_${i}_v1`;
        if (correct === total && localStorage.getItem(markerKey) !== "1"){
          localStorage.setItem(markerKey, "1");
          addXP(6, "Modellsetning fullfÃ¸rt");
          sentenceToast.style.display = "block";
          sentenceToast.textContent = `âœ… Setning ${i+1} perfekt! +6 XP`;
          clearTimeout(sentenceToast._t);
          sentenceToast._t = setTimeout(()=> sentenceToast.style.display="none", 1600);
        }

        const allPerfect = targets.every((_, k) => {
          const v = document.getElementById(`in-${k}`)?.value || "";
          const s = scoreSentence(v, targets[k].fr);
          return s.correct === s.total;
        });
        if (allPerfect){
          markDone("sentences");
        }

        if (totals.c === totals.tot){
          sentenceToast.style.display = "block";
          sentenceToast.textContent = "ğŸŒŸ Alt riktig i del 3!";
          clearTimeout(sentenceToast._t);
          sentenceToast._t = setTimeout(()=> sentenceToast.style.display="none", 1600);
        }
      };

      input.addEventListener("input", update);
      update();
    });

    updateTotal();
  }

  document.getElementById("saveMeteo").addEventListener("click", () => {
    const arr = targets.map((_, i) => (document.getElementById(`in-${i}`)?.value || "").trim());
    saveSent(arr);
    savedEl.textContent = "âœ… Lagret lokalt i nettleseren.";
    addXP(2, "Lagret setninger");
  });

  document.getElementById("resetMeteo").addEventListener("click", () => {
    localStorage.removeItem(SENT_KEY);
    targets.forEach((_, i) => localStorage.removeItem(`meteo_model_done_${i}_v1`));
    savedEl.textContent = "ğŸ—‘ï¸ Nullstilt.";
    renderSentences();
  });

  renderSentences();

  // -------------------------
  // DEL 4: Fri skriving med smart feedback
  // -------------------------
  const FREE_KEY = "meteo_free_text_v2";
  const freeText = document.getElementById("freeText");
  const freeScoreEl = document.getElementById("freeScore");
  const freeFeedbackEl = document.getElementById("freeFeedback");
  const freeToast = document.getElementById("freeToast");

  freeText.value = localStorage.getItem(FREE_KEY) || "";

  function countSentences(text){
    const m = text.match(/[.!?]+/g);
    return m ? m.length : (text.trim().length ? 1 : 0);
  }

  function smartFeedback(text){
    const t = text.toLowerCase().replace(/[â€™]/g,"'");
    const checks = [
      { id:"ilfait",  label:"Har du brukt â€œil faitâ€?", ok: /il\s+fait/.test(t) },
      { id:"ilya",    label:"Har du brukt â€œil y aâ€?", ok: /il\s+y\s+a/.test(t) },
      { id:"weather", label:"Har du brukt vÃ¦rord (soleil, vent, nuages, pleut, neigeâ€¦)?",
        ok: /(soleil|vent|nuage|pleut|neige|orage|brouillard|chaud|froid|beau|mauvais)/.test(t)
      },
      { id:"connect", label:"Har du brukt et bindeord (mais, parce que, et, ou)?",
        ok: /\b(mais|parce que|et|ou|donc)\b/.test(t)
      },
      { id:"len",     label:"Har du 4+ setninger?", ok: countSentences(text) >= 4 }
    ];

    const score = checks.filter(c => c.ok).length;
    return { score, max: checks.length, checks };
  }

  let freeAwarded = false;

  function updateFree(){
    const {score, max, checks} = smartFeedback(freeText.value);
    freeScoreEl.textContent = `Feedback: ${score} / ${max}`;
    freeFeedbackEl.innerHTML = checks.map(c =>
      `<div class="small">${c.ok ? "âœ…" : "â¬œ"} ${c.label}</div>`
    ).join("");

    if (score === max && !freeAwarded){
      freeAwarded = true;
      addXP(12, "FullfÃ¸rt fri tekst");
      toastGlobal("ğŸ Del 4 fullfÃ¸rt! +12 XP");
      markDone("free");
    }
    if (score < max) freeAwarded = false;
  }

  freeText.addEventListener("input", () => {
    localStorage.setItem(FREE_KEY, freeText.value);
    updateFree();
  });

  document.getElementById("saveFree").addEventListener("click", () => {
    localStorage.setItem(FREE_KEY, freeText.value);
    toastGlobal("âœ… Lagret lokalt.");
    addXP(2, "Lagret fri tekst");
    const { score, max } = smartFeedback(freeText.value);
    if (score === max) markDone("free");
  });

  document.getElementById("resetFree").addEventListener("click", () => {
    localStorage.removeItem(FREE_KEY);
    freeText.value = "";
    freeAwarded = false;
    updateFree();
    toastGlobal("ğŸ—‘ï¸ Fri tekst nullstilt.");
  });

  updateFree();

})();
</script>

</body>
</html>
